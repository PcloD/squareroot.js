var SQR={TWOPI:2*Math.PI,HALFPI:.5*Math.PI,EPSILON:1e-6,gl:null,flipMatrix:!0,fullScreenQuad:null,shaderPath:".",Primitives:{V2:function(t,r){return new SQR.V2(t,r)},V3:function(t,r,e){return new SQR.V3(t,r,e)},Q:function(t,r,e,n){return new SQR.Quaternion(t,r,e,n)},M4:function(){return new SQR.Matrix44},F:function(t){var r=function(t,e,n,i){var o=SQR.Face().v(t,e,n,i);return r.faces.push(o),o};return r.faces=[],r.toBuffer=function(e){var n=0;return r.faces.forEach(function(r){t&&t.reverseNormals&&r.flip(),r.calculateNormal(),n+=r.toBuffer(e,n,t&&t.perVertexNormal)}),n},r}},v2:function(){return{aPosition:2}},v3:function(){return{aPosition:3}},v2u2:function(){return{aPosition:2,aUV:2}},v2c3:function(){return{aPosition:2,aColor:3}},v3n3:function(){return{aPosition:3,aNormal:3}},v3n3u2:function(){return{aPosition:3,aNormal:3,aUV:2}},WARN_UNIFORM_NOT_PRESENT:!1};SQR.Version={version:"3.0",build:171,date:"Apr 19th 2016"},SQR.GLSL={diffspec:"/*#docs*/\n//#vertex\nprecision mediump float;\nattribute vec3 aNormal;\nattribute vec3 aPosition;\nattribute vec2 aUV;\nuniform mat4 uMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjection;\nuniform mat3 uNormalMatrix;\nuniform vec3 uEyePosition;\nvarying vec3 vNormal;\nvarying vec3 vIncident;\nvarying vec2 vUV;\nvoid main() {\n	vNormal = uNormalMatrix * aNormal;\n	vec3 p = (uMatrix * vec4(aPosition, 1.0)).xyz;\n	vIncident = normalize(p - uEyePosition);\n	vUV = aUV;\n	gl_Position = uProjection * uViewMatrix * vec4(aPosition, 1.0);\n}\n//#fragment\nprecision mediump float;\n//#include standardLight\nuniform vec3 uAmbient;\nuniform vec3 uColor;\nuniform float uEmissive;\nuniform vec3 uLightDirection;\n#ifdef USE_DIFFUSE_MAP\nuniform sampler2D uTexture;\nuniform vec4 uTextureTileOffset;\n#endif\n#ifdef USE_SPECULAR\nuniform vec4 uSpecularColor;\nuniform float uShininess;\n#endif\n#ifdef USE_SPECULAR_MAP\nuniform sampler2D uSpecularMap;\n#endif\nvarying vec3 vNormal;\nvarying vec3 vIncident;\nvarying vec2 vUV;\nvec4 texture(sampler2D t, vec2 uv) {\n	return texture2D(t, uv * uTextureTileOffset.xy + uTextureTileOffset.zw);\n}\nvoid main() {\n	#ifdef USE_DIFFUSE_MAP\n	vec3 dm = uColor * texture(uTexture, vUV).rgb;\n	#else\n	vec3 dm = uColor;\n	#endif\n	vec3 e = dm * uEmissive;\n	vec3 d = diffuse(vNormal, uLightDirection, dm, 1.0);\n	#ifdef USE_SPECULAR_MAP\n	#define SI uSpecularColor.a * texture(uSpecularMap, vUV).r\n	#else\n	#define SI uSpecularColor.a\n	#endif\n	#ifdef USE_SPECULAR\n	#define SP specular(vNormal, vIncident, uLightDirection, uSpecularColor.rgb, uShininess, SI)\n	#else \n	#define SP vec3(0.0) \n	#endif\n	gl_FragColor = vec4(uAmbient + e + d + SP, 1.0);\n}\n",normal2color:"/*#docs*/\n//#vertex indicates that this is where the vertex shader starts\n//#fragment indicates that this is where the fragment shader starts\n//#vertex\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjection;\nuniform mat3 uNormalMatrix;\nvarying vec3 vNormal;\nvoid main() {\n	vNormal = normalize(uNormalMatrix * aNormal);\n	gl_Position = uProjection * uViewMatrix * vec4(aPosition, 1.0);\n}\n//#fragment\nprecision mediump float;\nvarying vec3 vNormal;\nvoid main() {\n	gl_FragColor = vec4(vec3(0.5) + vNormal * 0.5, 1.0);\n}\n",standardLight:"/*#docs*/\nvec3 diffuse(vec3 n, vec3 l, vec3 c, float i) {\n	#ifdef HEMISPHERE_DIFFUSE\n	return (dot(-l, n) * 0.5 + 0.5) * c * i;\n	#else\n	return max(0.0, dot(-l, n)) * c * i;\n	#endif\n}\nvec3 specular(vec3 n, vec3 v, vec3 l, vec3 c, float sh, float i) {\n	return pow(max(0.0, dot(reflect(-l, n), v)), sh) * c.rgb * i;\n}\nfloat brightness(vec3 c) {\n	return c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\n",texture:"/*#docs*/\nattribute vec3 aPosition;\nattribute vec2 aUV;\nuniform mat4 uMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjection;\nuniform mat3 uNormalMatrix;\nvarying vec2 vUV;\nvoid main() {\n	vUV = aUV;\n	gl_Position = uProjection * uViewMatrix * vec4(aPosition, 1.0);\n}\n//#fragment\nprecision mediump float;\nuniform sampler2D uTexture;\nvarying vec2 vUV;\nvoid main() {\n	gl_FragColor = texture2D(uTexture, vUV);\n}\n"},SQR.Buffer=function(){var t,r,e,n,i={},o=!1;return i.mode=SQR.gl.TRIANGLES,i.drawMode=SQR.gl.STATIC_DRAW,i.setMode=function(t){return i.mode=t,i},i.layout=function(r,e){i.size=e,i.strideSize=0,i.layout=r,i.attributes={};for(var n in r){var o={offset:i.strideSize,byteOffset:4*i.strideSize,size:r[n]};i.strideSize+=r[n],i.attributes[n]=o}return i.strideByteSize=4*i.strideSize,t=new Float32Array(e*i.strideSize),i},i.resize=function(r,e){i.size=r;var n=new Float32Array(r*i.strideSize);if(e)for(var o=0;o<t.length;o++){var a=o-e*i.strideSize;a>=0&&(n[a]=t[o])}else n.set(t);t=n},i.data=function(r,e){e instanceof Array||(e=Array.prototype.slice.call(arguments,1));for(var n=i.attributes[r],o=e.length/n.size,a=0;o>a;a++)for(var s=0;s<n.size;s++)t[a*i.strideSize+s+n.offset]=e[a*n.size+s];return i},i.set=function(r,e,n){n.toArray?n=n.toArray():n instanceof Array||(n=Array.prototype.slice.call(arguments,2));var o=r?i.attributes[r].offset:0;0>e&&(e+=i.size),e>=i.size&&(e%=i.size);for(var a=0,s=n.length;s>a;a++)t[e*i.strideSize+a+o]=n[a];return i},i.iterate=function(r,e){var n=i.attributes[r];if(r&&!n)throw"> SQR.Buffer.iterate > no such attribute: "+r;for(var o=r?n.offset:0,a=0,s=0;s<t.length;s+=i.strideSize)e(s+o,t,a),a++;return i},i.bind=function(){return SQR.gl.bindBuffer(SQR.gl.ARRAY_BUFFER,e),o&&SQR.gl.bindBuffer(SQR.gl.ELEMENT_ARRAY_BUFFER,n),i},i.update=function(){var a=SQR.gl;return e=e||a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,e),a.bufferData(a.ARRAY_BUFFER,t,i.drawMode),o&&(n=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,n),a.bufferData(a.ELEMENT_ARRAY_BUFFER,r,i.drawMode)),i},i.index=function(t){return t instanceof Array||(t=Array.prototype.slice.call(arguments,0)),r=new Uint16Array(t),i.indexSize=t.length,o=!0,i},i.isIndexed=function(){return o},i.draw=function(t){var r=SQR.gl;o?r.drawElements(t.drawMode||i.mode,i.indexSize,r.UNSIGNED_SHORT,0):r.drawArrays(t.drawMode||i.mode,0,i.size)},i.setRawData=function(r,e){t.set(r,e)},i.getDataArray=function(){return t},i.getIndexArray=function(){return r},i.destroy=function(){t.length=0,SQR.gl.deleteBuffer(e),o&&(r.length=0,SQR.gl.deleteBuffer(n))},i},SQR.Context=function(t,r,e){!SQR._versionDisplayed&&SQR.Version&&(console.log("%cSquareroot v"+SQR.Version.version+" b"+SQR.Version.build,"background: #663399; color: #dd99ff; padding: 4px 10px 4px 10px"),SQR._versionDisplayed=!0);var n="> SQR.Context - Webgl is not supported.",i="> SQR.Context - Invalid canvas reference.";if(t||(t=document.createElement("canvas")),t instanceof HTMLElement||(t=document.querySelector(t)),!t.getContext)throw i;var o,a={canvas:t};return a.create=function(r,e){e=e||function(){throw n},r=r||{},void 0===r.antialias&&(r.antialias=!0),void 0===r.stencil&&(r.stencil=!1),window.WebGLRenderingContext||e();try{o=t.getContext("webgl",r)||t.getContext("experimental-webgl",r)}catch(i){console.error(i),e()}return a.gl=o,a.setAsCurrent(),o.enable(o.CULL_FACE),r.customGLSetup&&r.customGLSetup(),a},a.size=function(r,e,n){return n=n||1,t.width=r*n,t.height=e*n,a.viewport(0,0,r*n,e*n),t.style.width=r+"px",t.style.height=e+"px",a},a.viewport=function(t,r,e,n){return o.viewport(t,r,e,n),a},a.clearColor=function(t,r,e,n){return o.clearColor(t,r,e,n),o.clear(o.COLOR_BUFFER_BIT),a},a.clear=function(){return o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT|o.STENCIL_BUFFER_BIT),a},a.setAsCurrent=function(){return SQR.gl=o,a},a.create(r,e),a},SQR.Loader={loadText:function(t,r){var e=new XMLHttpRequest;e.open("GET",t);var n=function(){4==e.readyState&&(e.removeEventListener("readystatechange",n),r(e.responseText,t))};e.addEventListener("readystatechange",n),e.send()},loadJSON:function(t,r){SQR.Loader.loadText(t,function(e){r(JSON.parse(e),t)})},loadImage:function(t,r,e){var n=new Image;if(r){var i=function(){n.removeEventListener("load",i),r(n,t)};n.addEventListener("load",i)}if(e){var o=function(){return n.src="",n.removeEventListener("error",o),e(null,t),!1};n.addEventListener("error",o)}return n.src=t,n},loadWebcam:function(t,r){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia||(console.error("> SQR.Loader - getUserMedia not supported"),t()),r=r||{audio:!1,video:{}};var e=function(t){i.stream=t,i.src=window.URL.createObjectURL(t),i.play(),i.addEventListener("canplaythrough",n,!1)},n=function(){t(i,"webcam")},i=document.createElement("video");i.autoplay=!0,navigator.getUserMedia(r,e,function(t){console.error("> SQR.Loader - getUserMedia error ",t)})},loadVideo:function(t,r){var e=function(){r(n,t)},n=document.createElement("video");n.autoplay=!0,n.addEventListener("canplaythrough",e,!1);var i=t;n.canPlayType("video/mp4")||(i=i.replace("mp4","webm")),n.src=i},loadAssets:function(t,r,e,n){n=n||{};var i=t.length,o={};if(0==i)return e&&e(1,1),void r();for(var a={},s=function(t,r){SQR.GLSLInclude=SQR.GLSLInclude||{},SQR.GLSLInclude[a[r]]=t,u(t,r)},u=function(n,s){o[a[s]]=n,i--,e&&e(i,t.length),0==i&&r(o)},c=0;i>c;c++){var l=t[c],f="string"!=typeof l,h=f?l[0]:l,d=f?l[1]:l,p=h.substring(h.lastIndexOf(".")+1);switch(a[h]=d,p){case"glsl":SQR.Loader.loadText(h,s);break;case"png":case"jpg":case"gif":SQR.Loader.loadImage(h,u);break;case"json":case"js":SQR.Loader.loadJSON(h,u);break;case"mp4":case"webm":SQR.Loader.loadVideo(h,u);break;case"webcam":SQR.Loader.loadWebcam(u)}}}},SQR.Pointer3d=function(t){t=t||{};var r=-2,e=0,n=new SQR.Ray,i=[];document.addEventListener("mousemove",function(t){r=t.pageX/window.innerWidth*2-1,e=t.pageY/window.innerHeight*2-1});var o=function(t,r){return t.collider.__hit<r.collider.__hit?-1:t.collider.__hit>r.collider.__hit?1:0};return{all:t.all||!1,ray:n,onTransform:function(e){if(e.collider&&-2!=r){var o=SQR.Intersection.rayTest(n,e);t.all?e.collider.hit=o:(e.collider.hit=!1,e.collider.__hit=o),o&&i.push(e)}},onAfterRender:function(){-2!=r&&!t.all&&i.length>0&&(i.sort(o),i[0].collider.hit=i[0].collider.__hit)},fromMousePosition:function(t,o,a){var s=SQR.Ray._mt,u=a?a.x:r,c=a?a.y:e;return n.origin.set(u,-1*c,0),s.copyFrom(o).inverse(),s.transformVector(n.origin),t.globalMatrix.transformVector(n.origin),n.direction.sub(n.origin,t.globalPosition).norm(),i.length=0,n}}},SQR.Ray=function(t,r){this.origin=t||new SQR.V3,this.direction=r||new SQR.V3,this.localOrigin=new SQR.V3,this.localDirection=new SQR.V3,SQR.Ray._mt||(SQR.Ray._mt=new SQR.Matrix44,SQR.Ray._nt=new SQR.Matrix33)},SQR.Ray.prototype.makeLocal=function(t){var r=SQR.Ray._mt,e=SQR.Ray._nt;r.copyFrom(t.globalMatrix).inverse(),r.transformVector(this.origin,this.localOrigin),e.copyFrom(t.normalMatrix).transpose(),e.transformVector(this.direction,this.localDirection)},SQR.Renderer=function(t,r,e){var n;n=t&&t.setAsCurrent?t:SQR.Context(t,r,e);var i,o,a,s,u={currentTime:0,deltaTime:0,autoClear:!0,context:n},c=[],l=[],f=function(t,r,e){if(t.active){if(t.__transformed||(t.transformWorld(),t.__transformed=!1),t.transformView(r?r.inverseWorldMatrix:null),t.clip&&t.clip.update(t,o,u.deltaTime),e.pointer3d&&e.pointer3d.onTransform(t),t.numChildren>0)for(var n=0;n<t.numChildren;n++)f(t.children[n],r,e);t.buffer&&t.shader&&(t.transparent?l.push(t):c.push(t))}},h={},d=[],p=function(t,r){t&&r.setUniform("uEyePosition",t.globalPosition);var e=t&&t.projection?t.projection:u.projection;e&&r.setUniform("uProjection",e).setUniform("uNear",e.near).setUniform("uFar",e.far),r.setUniform("uTime",o)};return u.clearColor=function(t,r,e,i){return null!=t.r?(void 0==t.a&&(t.a=1),n.gl.clearColor(t.r,t.g,t.b,t.a)):(void 0==i&&(i=1),n.gl.clearColor(t,r,e,i)),n.gl.clear(SQR.gl.COLOR_BUFFER_BIT),u},u.render=function(t,r,e){u.tick(),u.beforeDraw(r,e),u.update(t,r,e),u.draw(null,r,e),u.afterDraw(e)},u.tick=function(){return i||(i=(new Date).getTime()),o=(new Date).getTime()-i,u.deltaTime=o-u.currentTime,u.currentTime=o,u},u.beforeDraw=function(t,r){if(r=r||h,r.pointer3d){var e=t&&t.projection?t.projection:u.projection;r.pointer3d.fromMousePosition(t||root,e)}return u},u.update=function(t,r,e){if(e=e||h,c.length=0,l.length=0,d.length=0,r){for(var n=r;n;)d.unshift(n),n=n.parent;for(var i=0,o=d.length;o>i;i++)d[i].transformWorld(),d[i].__transformed=!0;r.computeInverseMatrix()}return f(t,r,e),u},u.draw=function(t,r,e){var i=SQR.gl;e=e||h,u.autoClear&&n.clear(),i.enable(i.DEPTH_TEST),i.depthMask(!0),i.disable(i.STENCIL_TEST),i.frontFace(i.CW),e.customGLSetup&&e.customGLSetup(i),t&&t.buffer&&t.shader&&c.push(t),c=c.concat(l);var o,f=c.length,d=null,m=null,v=!1,S=e&&e.replacementShader;S&&(m=e.replacementShader.use().updateTextures(),p(r,m));for(var y=0;f>y;y++){a=!1,s=!1;var o=c[y];o.transparent&&(v||(i.enable(i.BLEND),v=!0),i.blendFunc(o.srcFactor,o.dstFactor)),d!=o.buffer&&(d=o.buffer,d.bind(),s=!0),m==o.shader||S||(m=o.shader.use().updateTextures(),p(r,m),a=!0),(a||s)&&m.attribPointers(d),o.draw(e)}return i.disable(i.BLEND),u},u.afterDraw=function(t){return t=t||h,t.pointer3d&&t.pointer3d.onAfterRender(),u},u.renderToScreen=function(){var t=SQR.gl;t.bindFramebuffer(t.FRAMEBUFFER,null)},u.clearColor(0,0,0,1),u},SQR.Shader=function(t,r){var e,n={},i={},o=[],a={},s=[],u=[],c=function(t){if(!t)throw"> SQR.Shader.parseGLSL - Shader source code missing";var e="",n=r?r.directives:null;if(n&&n instanceof Array)for(var i=0;i<n.length;i++)e+="#define "+n[i].name,n[i].value&&(e+=" "+n[i].value),e+="\n";for(var o=e,a=e,s=!0,u=t.split("\n"),i=0;i<u.length;i++){var c=u[i];if(c.indexOf("//#include")>-1){var l,f=c.substring(11);if(SQR.GLSL&&SQR.GLSL[f]?l=SQR.GLSL[f]:SQR.GLSLInclude&&SQR.GLSLInclude[f]?l=SQR.GLSLInclude[f]:r&&r.includes&&(l=r.includes[f]),!l)throw"> SQR.Shader.parseGLSL - Include not found: "+f;u[i]=l}}for(var u=u.join("\n").split("\n"),i=0;i<u.length;i++){var c=u[i];if(c.indexOf("//#")>-1)c.indexOf("//#fragment")>-1?s=!1:c.indexOf("//#vertex")>-1&&(s=!0);else{if(c.indexOf("//")>-1&&(c=c.substring(0,c.indexOf("//"))),c.match(/^([\s\t]*)$/))continue;s?o+=c+"\n":a+=c+"\n"}}return{vertex:o,fragment:a}};n.compile=function(){var r=t=c(t),i=SQR.gl,o=i.createShader(i.VERTEX_SHADER);i.shaderSource(o,r.vertex),i.compileShader(o);var a=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(a,r.fragment),i.compileShader(a),e=i.createProgram(),i.attachShader(e,o),i.attachShader(e,a),i.linkProgram(e),!i.getShaderParameter(o,i.COMPILE_STATUS))throw"> SQR.Shader. Vertex shader compile error: "+i.getShaderInfoLog(o);if(!i.getShaderParameter(a,i.COMPILE_STATUS))throw"> SQR.Shader. Fragment shader compile error: "+i.getShaderInfoLog(a);if(!i.getProgramParameter(e,i.LINK_STATUS))throw"> SQR.Shader. Shader linking error: "+i.getProgramInfoLog(e);return n},n.inspect=function(){for(var t=SQR.gl,r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),c=0;r>c;c++){var l=t.getActiveAttrib(e,c);l.location=t.getAttribLocation(e,l.name),i[l.name]=l,o.push(l)}for(var f=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),h=0,c=0;f>c;c++){var d=t.getActiveUniform(e,c);if((d.type==t.SAMPLER_2D||d.type==t.SAMPLER_CUBE)&&(d.texId=h++,u.push(d)),d.name.indexOf("[")>-1)for(var p=d.name.substring(0,d.name.indexOf("[")),m=1;m<d.size;m++){var v=p+"["+m+"]",S={name:v,location:t.getUniformLocation(e,v),type:d.type};a[S.name]=S,s.push(S)}d.location=t.getUniformLocation(e,d.name),a[d.name]=d,s.push(d)}return n};var l="string";n.getUniform=function(t){return a[t]},n.hasUniform=function(t){return null!=a[t]},n.setUniform=function(t,r){var e=SQR.gl,i=typeof t==l?a[t]:t,o=r;if(!i){var s=a[t+"[0]"];if(s){for(var u=0;u<s.size;u++)r[u]&&n.setUniform(t+"["+u+"]",r[u]);return}return SQR.WARN_UNIFORM_NOT_PRESENT&&(console.warn("> SQR.Shader attempt to set uniform that does not exist: "+t),console.trace()),n}switch(o&&o.toUniform&&(o=o.toUniform(i.type)),i.type){case e.BYTE:e.uniform1i(i.location,o);break;case e.UNSIGNED_BYTE:e.uniform1i(i.location,o);break;case e.SHORT:e.uniform1i(i.location,o);break;case e.UNSIGNED_SHORT:e.uniform1i(i.location,o);break;case e.INT:e.uniform1i(i.location,o);break;case e.INT_VEC2:e.uniform2iv(i.location,o);break;case e.INT_VEC3:e.uniform3iv(i.location,o);break;case e.INT_VEC4:e.uniform4iv(i.location,o);break;case e.UNSIGNED_INT:e.uniform1i(i.location,o);break;case e.FLOAT:e.uniform1f(i.location,o);break;case e.FLOAT_VEC2:e.uniform2fv(i.location,o);break;case e.FLOAT_VEC3:e.uniform3fv(i.location,o);break;case e.FLOAT_VEC4:e.uniform4fv(i.location,o);break;case e.BOOL:e.uniform1i(i.location,o);break;case e.BOOL_VEC2:e.uniform2iv(i.location,o);break;case e.BOOL_VEC3:e.uniform3iv(i.location,o);break;case e.BOOL_VEC4:e.uniform4iv(i.location,o);break;case e.FLOAT_MAT2:e.uniformMatrix2fv(i.location,!1,o.data||o);break;case e.FLOAT_MAT3:e.uniformMatrix3fv(i.location,!1,o.data||o);break;case e.FLOAT_MAT4:e.uniformMatrix4fv(i.location,!1,o.data||o);break;case e.SAMPLER_2D:f(i,o);break;case e.SAMPLER_CUBE:h(i,o);break;default:console.warn("> SQR.Shader > WARNING! Unknown uniform type ( 0x"+i.type.toString(16)+" )")}return n};var f=function(t,r){var e=SQR.gl,n=t.texId;t.texref=r,e.activeTexture(e.TEXTURE0+n),r?(e.bindTexture(e.TEXTURE_2D,r.tex||r),r.isAnimated&&r.update()):e.bindTexture(e.TEXTURE_2D,null),e.uniform1i(t.location,n)},h=function(t,r){var e=SQR.gl,n=t.texId;t.texref=r,e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_CUBE_MAP,r.tex||r),e.uniform1i(t.location,n)};return n.updateTextures=function(){for(var t=(SQR.gl,0),r=u.length;r>t;t++){var e=u[t];e.texref&&n.setUniform(e,e.texref)}return n},n.use=function(){return SQR.gl.useProgram(e),n},n.attribPointers=function(t){var r=SQR.gl,e=o.length;t=t.buffer||t;for(var i=0;e>i;i++){var a=o[i],s=t.attributes[a.name];if(!s)throw"> SQR.Shader expects attribute "+a.name+" but geometry doesn't provide it";a.enabled||r.enableVertexAttribArray(a.location),r.vertexAttribPointer(a.location,s.size,r.FLOAT,!1,t.strideByteSize,s.byteOffset),a.enabled=!0}return n},r&&r.doNotCompile||(n.compile(),n.inspect()),n},SQR.Texture=function(t,r){var e,n,i={},o=SQR.gl;i.setSource=function(t,r){if(!(t instanceof HTMLVideoElement||t instanceof Image||t instanceof HTMLCanvasElement))throw console.error("Invalid source: "+s),"SQR.Texture > provided source is not a valid source for texture";e=t,n=r||{};var c=n.wrapS||n.wrap,l=n.wrapT||n.wrap;o.bindTexture(o.TEXTURE_2D,u),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,void 0!==n.flip?n.flip:!0),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e);var f,h;return a()?(n.mipmap&&o.generateMipmap(o.TEXTURE_2D),f=n.mipmap?o.LINEAR_MIPMAP_LINEAR:o.LINEAR,h=o.LINEAR):(n.mipmap&&console.warn("Only power-of-2 texture can use mipmaps\n",t),f=h=o.LINEAR),c||(c=o.CLAMP_TO_EDGE),l||(l=o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,n.magFilter||n.filter||h),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,n.minFilter||n.filter||f),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,c),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,l),o.bindTexture(o.TEXTURE_2D,null),i.isAnimated=n&&n.isAnimated||t instanceof HTMLVideoElement,i};var a=function(){var t=e.width,r=e.height;return t>0&&r>0&&0==(t&t-1)&&0==(r&r-1)};i.getSource=function(){return e},i.update=function(){var t=SQR.gl;return t.bindTexture(t.TEXTURE_2D,u),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),i},i.destroy=function(){o.deleteTexture(i.tex)};var u=o.createTexture();return i.tex=u,t&&i.setSource(t,r),i},SQR.Transform=function(t,r){if(!(this instanceof SQR.Transform))return new SQR.Transform(t,r);var e=this;e._transformState=0,e.uid=r,e.name=t||"sqr.transform."+SQR.TransformCount++,e.active=!0,e.directMatrixMode=!1,e.matrix=new SQR.Matrix44,e.position=new SQR.V3,e.globalPosition=new SQR.V3,e.forward=new SQR.V3,e.quaternion=new SQR.Quaternion,e.rotation=new SQR.V3,e.scale=new SQR.V3(1,1,1),e.useQuaternion=!1,e.isStatic=!1,e.normalMatrix=new SQR.Matrix33,e.globalMatrix=new SQR.Matrix44,e.viewMatrix=new SQR.Matrix44,e.inverseWorldMatrix,e.boneMatrix=new SQR.Matrix44,e.poseMatrix=new SQR.Matrix44,e.inversePoseMatrix=new SQR.Matrix44,e.lookAt=null,e.transparent=!1,e.srcFactor=null,e.dstFactor=null,e.useDepth=!0,e.depthMask=!0,e.lineWidth=1,e.children=[],e.numChildren=0},SQR.Transform.prototype.setAsBoneRoot=function(){this.computePoseMatrix()},SQR.Transform.prototype.computePoseMatrix=function(){var t=this;t.bone=!0,t.transformWorld(),t.parent&&t.parent.bone?(t.parent.poseMatrix.copyTo(t.poseMatrix),t.poseMatrix.multiply(t.matrix)):t.matrix.copyTo(t.poseMatrix);for(var r=0;r<t.numChildren;r++){var e=t.children[r];e.computePoseMatrix()}return t.poseMatrix.inverse(t.inversePoseMatrix),t},SQR.Transform.prototype.setBlending=function(t,r,e){this.transparent=t,this.srcFactor=r||SQR.gl.SRC_ALPHA,this.dstFactor=e||SQR.gl.ONE_MINUS_SRC_ALPHA},SQR.Transform.prototype.add=function(){for(var t=this,r=0;r<arguments.length;r++){var e=arguments[r];e.parent&&e.parent.remove(e),e.onAdd&&e.onAdd(t),e.parent=t,-1==t.children.indexOf(e)&&t.children.push(e)}return t.numChildren=t.children.length,t},SQR.Transform.prototype.remove=function(){for(var t=this,r=0;r<arguments.length;r++){var e=arguments[r],n=t.children.indexOf(e);-1!=n&&(e.parent=null,t.children.splice(n,1),e.onRemove&&e.onRemove(t))}return t.numChildren=t.children.length,t},SQR.Transform.prototype.removeAll=function(){this.children.length=0,this.numChildren=0},SQR.Transform.prototype.contains=function(t){return this.children.indexOf(t)>-1},SQR.Transform.prototype.recurse=function(t,r){r||t(this);for(var e=0;e<this.numChildren;e++)this.children[e].recurse(t)},SQR.Transform.prototype.findByName=function(t){var r;return this.recurse(function(e){return e.name==t?(r=e,null):void 0}),r},SQR.Transform.prototype.findById=function(t){var r;return this.recurse(function(e){return e.uid&&e.uid==t?(r=e,null):void 0}),r},SQR.Transform.prototype.findByPath=function(t){for(var r=t.split("/"),e=this;pp=r.shift();){if(!e)return;e=e.findByName(pp)}return e},SQR.Transform.prototype.draw=function(t){var r=this,e=t&&t.replacementShader,n=e?t.replacementShader:r.shader;if(n.setUniform("uMatrix",r.globalMatrix),n.setUniform("uViewMatrix",r.viewMatrix),n.setUniform("uNormalMatrix",r.normalMatrix),!e&&n.uniforms)for(var i=Object.keys(n.uniforms),o=0,a=i.length;a>o;o++)n.setUniform(i[o],n.uniforms[i[o]]);if(!e&&r.uniforms)for(var i=Object.keys(r.uniforms),o=0,a=i.length;a>o;o++)n.setUniform(i[o],r.uniforms[i[o]]);var s=SQR.gl;r.useDepth?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),s.depthMask(r.depthMask),s.lineWidth(r.lineWidth),r.buffer.draw(this),r.afterDraw&&r.afterDraw()},SQR.Transform.prototype.transformWorld=function(){var t=this;if(1!=t._transformState){if(!t.directMatrixMode){var r=t.position,e=t.scale;if(t.useQuaternion){var n=t.quaternion;t.matrix.setTQS(r.x,r.y,r.z,n.w,n.x,n.y,n.z,e.x,e.y,e.z)}else{var i=t.rotation;t.matrix.setTRS(r.x,r.y,r.z,i.x,i.y,i.z,e.x,e.y,e.z)}}t.lookAt&&t.matrix.lookAt(t.lookAt.position),t.parent?(t.parent.globalMatrix.copyTo(t.globalMatrix),t.globalMatrix.multiply(t.matrix),t.bone&&(t.parent.boneMatrix.copyTo(t.boneMatrix),t.boneMatrix.multiply(t.matrix))):(t.matrix.copyTo(t.globalMatrix),t.bone&&t.matrix.copyTo(t.boneMatrix));var o=t.globalMatrix;o.extractPosition(t.globalPosition),t.forward.set(o.data[8],o.data[9],o.data[10]),t.isStatic&&(t._transformState=1),t.beforeDraw&&t.beforeDraw(t)}},SQR.Transform.prototype.viewDepth=function(){return this.viewMatrix.data[14]},SQR.Transform.prototype.transformView=function(t){var r=this;t?(t.copyTo(r.viewMatrix),r.viewMatrix.multiply(r.globalMatrix),r.globalMatrix.inverseMat3(r.normalMatrix)):(r.globalMatrix.copyTo(r.viewMatrix),r.globalMatrix.inverseMat3(r.normalMatrix))},SQR.Transform.prototype.computeInverseMatrix=function(){var t=this;return t.inverseWorldMatrix||(t.inverseWorldMatrix=new SQR.Matrix44),t.globalMatrix.inverse(t.inverseWorldMatrix),t.inverseWorldMatrix},SQR.Transform.prototype.computeBoneMatrix=function(){var t=this;return t.boneMatrix.multiply(t.inversePoseMatrix),t.boneMatrix},SQR.TransformCount=0,SQR.Color=function(t,r,e,n){return this instanceof SQR.Color?void("string"==typeof t?(this.setHex(t),this.a=void 0==r?1:r):t&&void 0!=t.r?(this.setRGB(t.r,t.g,t.b),this.a=void 0!=t.a?t.a:void 0!=r?r:1):(this.setRGB(t,r,e),this.a=void 0==n?1:n)):new SQR.Color(t,r,e,n)},SQR.Color.prototype.setRGB=function(t,r,e){var n=this;return n.r=t||0,n.g=r||0,n.b=e||0,n},SQR.Color.prototype.setHex=function(t){var r=this;return"string"==typeof t&&(t=0==t.indexOf("#")?t.substring(1):t,t=-1==t.indexOf("0x")?"0x"+t:t,t=parseInt(t)),r.r=(t>>16&255)/255,r.g=(t>>8&255)/255,r.b=(255&t)/255,r},SQR.Color.prototype.toCSS=function(){var t=this,r=255*t.r|0,e=255*t.g|0,n=255*t.b|0;return"rgb("+r+", "+e+", "+n+")"},SQR.Color.prototype.copyFrom=function(t){var r=this;return r.r=t.r,r.g=t.g,r.b=t.b,r},SQR.Color.prototype.lighten=function(t){return this.mul(t)},SQR.Color.prototype.clone=function(){return new SQR.Color(c.r,c.g,c.b)},SQR.Color.prototype.mul=function(t){var r=this;return r.r=Math.min(1,r.r*t),r.g=Math.min(1,r.g*t),r.b=Math.min(1,r.b*t),r},SQR.Color.prototype.lerp=function(t,r,e){var n=this,i=1-e;return n.r=t.r*i+r.r*e,n.g=t.g*i+r.g*e,n.b=t.b*i+r.b*e,n},SQR.Color.prototype.toUniform=function(t){var r=t==SQR.gl.FLOAT_VEC4,e=this;return e._array||(e._array=new Float32Array(r?4:3)),e._array[0]=e.r,e._array[1]=e.g,e._array[2]=e.b,r&&(e._array[3]=e.a),e._array},Math.clamp=function(t,r,e){return r>=t?r:t>=e?e:t},Math.clamp01=function(t){return 0>=t?0:t>=1?1:t},Math.absMin=function(t,r){return-r>=t||t>=r?t:t>=0?r:-r},Math.map=function(t,r,e){return r>=t?0:t>=e?1:(t-r)/(e-r)},SQR.Matrix33=function(){this.data=new Float32Array(9),this.identity=function(){var t=this.data;return t[0]=1,t[3]=0,t[6]=0,t[1]=0,t[4]=1,t[7]=0,t[2]=0,t[5]=0,t[8]=1,this},this.copyTo=function(t){for(var r=this.data,e=t.data||t,n=0;9>n;n++)e[n]=r[n];return this},this.copyFrom=function(t){for(var r=this.data,e=t.data||t,n=0;9>n;n++)r[n]=e[n];return this},this.transformVector=function(t,r){var e=this.data,n=t.x,i=t.y,o=t.z;return r=r||t,r.x=e[0]*n+e[3]*i+e[6]*o,r.y=e[1]*n+e[4]*i+e[7]*o,r.z=e[2]*n+e[5]*i+e[8]*o,r},this.determinant=function(){var t=this.data;return t[0]*(t[4]*t[8]-t[7]*t[5])+t[3]*(t[7]*t[2]-t[1]*t[8])+t[6]*(t[1]*t[5]-t[4]*t[2])},this.inverse=function(t){var r=this.data;t=t||this.data;var e,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],u=r[5],c=r[6],l=r[7],f=r[8],h=f*s-u*l,d=-f*a+u*c,p=l*a-s*c,r=n*h+i*d+o*p;return r?(e=1/r,t[0]=h*e,t[1]=(-f*i+o*l)*e,t[2]=(u*i-o*s)*e,t[3]=d*e,t[4]=(f*n-o*c)*e,t[5]=(-u*n+o*a)*e,t[6]=p*e,t[7]=(-l*n+i*c)*e,t[8]=(s*n-i*a)*e,t):(console.warn("Attempt to inverse a singular matrix33. ",this.data),t)},this.transpose=function(){var t=this.data,r=t[0],e=t[3],n=t[6],i=t[1],o=t[4],a=t[7],s=t[2],u=t[5],c=t[8];t[0]=r,t[1]=e,t[2]=n,t[3]=i,t[4]=o,t[5]=a,t[6]=s,t[7]=u,t[8]=c}},SQR.Matrix44=function(t){this.data=t||new Float32Array(16),this.identity=function(t){var r=t||this.data;return r[0]=1,r[4]=0,r[8]=0,r[12]=0,r[1]=0,r[5]=1,r[9]=0,r[13]=0,r[2]=0,r[6]=0,r[10]=1,r[14]=0,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},this.transformVector=function(t,r){var e=this.data,n=t.x,i=t.y,o=t.z,a=t.w;return r=r||t,r.x=e[0]*n+e[4]*i+e[8]*o+e[12]*a,r.y=e[1]*n+e[5]*i+e[9]*o+e[13]*a,r.z=e[2]*n+e[6]*i+e[10]*o+e[14]*a,r},this.rotateVector=function(t,r){{var e=this.data,n=t.x,i=t.y,o=t.z;t.w}return r=r||t,r.x=e[0]*n+e[4]*i+e[8]*o,r.y=e[1]*n+e[5]*i+e[9]*o,r.z=e[2]*n+e[6]*i+e[10]*o,r},this.multiply=function(t){var r,e,n,i,o,a,s,u,c,l,f,h,d,p,m,v,S,y,R,x,Q,g,M,w,T,_,b,E,V,z,P,A,L=this.data,U=t.data||t;return r=L[0],e=L[1],n=L[2],i=L[3],o=L[4],a=L[5],s=L[6],u=L[7],c=L[8],l=L[9],f=L[10],h=L[11],d=L[12],p=L[13],m=L[14],v=L[15],S=U[0],y=U[1],R=U[2],x=U[3],Q=U[4],g=U[5],M=U[6],w=U[7],T=U[8],_=U[9],b=U[10],E=U[11],V=U[12],z=U[13],P=U[14],A=U[15],L[0]=r*S+o*y+c*R+d*x,L[1]=e*S+a*y+l*R+p*x,L[2]=n*S+s*y+f*R+m*x,L[3]=i*S+u*y+h*R+v*x,L[4]=r*Q+o*g+c*M+d*w,L[5]=e*Q+a*g+l*M+p*w,L[6]=n*Q+s*g+f*M+m*w,L[7]=i*Q+u*g+h*M+v*w,L[8]=r*T+o*_+c*b+d*E,L[9]=e*T+a*_+l*b+p*E,L[10]=n*T+s*_+f*b+m*E,L[11]=i*T+u*_+h*b+v*E,L[12]=r*V+o*z+c*P+d*A,L[13]=e*V+a*z+l*P+p*A,L[14]=n*V+s*z+f*P+m*A,L[15]=i*V+u*z+h*P+v*A,this},this.setTQS=function(t,r,e,n,i,o,a,s,u,c,l){var f=l||this.data;this.identity(l);var h=i*i,d=o*o,p=a*a;return SQR.flipMatrix?(f[0]=(1-2*d-2*p)*s,f[1]=(2*i*o-2*a*n)*s,f[2]=(2*i*a+2*o*n)*s,f[4]=(2*i*o+2*a*n)*u,f[5]=(1-2*h-2*p)*u,f[6]=(2*o*a-2*i*n)*u,f[8]=(2*i*a-2*o*n)*c,f[9]=(2*o*a+2*i*n)*c,f[10]=(1-2*h-2*d)*c):(f[0]=(1-2*d-2*p)*s,f[4]=(2*i*o-2*a*n)*s,f[8]=(2*i*a+2*o*n)*s,f[1]=(2*i*o+2*a*n)*u,f[5]=(1-2*h-2*p)*u,f[9]=(2*o*a-2*i*n)*u,f[2]=(2*i*a-2*o*n)*c,f[6]=(2*o*a+2*i*n)*c,f[10]=(1-2*h-2*d)*c),f[12]=t,f[13]=r,f[14]=e,l||this},this.setTRS=function(t,r,e,n,i,o,a,s,u,c){var l=c||this.data;this.identity(c);var f=Math.sin(n),h=Math.cos(n),d=Math.sin(i),p=Math.cos(i),m=Math.sin(o),v=Math.cos(o);return SQR.flipMatrix?(l[0]=(p*v+d*f*m)*a,l[1]=(-p*m+d*f*v)*a,l[2]=d*h*a,l[4]=m*h*s,l[5]=v*h*s,l[6]=-f*s,l[8]=(-d*v+p*f*m)*u,l[9]=(m*d+p*f*v)*u,l[10]=p*h*u):(l[0]=(p*v+d*f*m)*a,l[4]=(-p*m+d*f*v)*a,l[8]=d*h*a,l[1]=m*h*s,l[5]=v*h*s,l[9]=-f*s,l[2]=(-d*v+p*f*m)*u,l[6]=(m*d+p*f*v)*u,l[10]=p*h*u),l[12]=t,l[13]=r,l[14]=e,c||this},this.setScale=function(t,r,e,n){var i=n||this.data;return i[0]=t,i[5]=r,i[10]=e,n||this},this.setTranslation=function(t,r,e,n){var i=n||this.data;return i[12]=t,i[13]=r,i[14]=e,n||this},this.setRotation=function(t,r,e,n){var i=n||this.data,o=Math.sin(t),a=Math.cos(t),s=Math.sin(r),u=Math.cos(r),c=Math.sin(e),l=Math.cos(e);return i[0]=u*l+s*o*c,i[1]=-u*c+s*o*l,i[2]=s*a,i[4]=c*a,i[5]=l*a,i[6]=-o,i[8]=-s*l+u*o*c,i[9]=c*s+u*o*l,i[10]=u*a,n||this},this.translate=function(t,r,e){return this.identity(SQR.Matrix44.__temp),this.setTranslation(t,r,e,SQR.Matrix44.__temp),this.multiply(SQR.Matrix44.__temp)},this.rotate=function(t,r,e){return this.identity(SQR.Matrix44.__temp),this.setRotation(t,r,e,SQR.Matrix44.__temp),this.multiply(SQR.Matrix44.__temp)},this.scale=function(t,r,e){return this.identity(SQR.Matrix44.__temp),this.setScale(t,r,e,SQR.Matrix44.__temp),this.multiply(SQR.Matrix44.__temp)},this.copyTo=function(t){for(var r=this.data,e=t.data||t,n=0;16>n;n++)e[n]=r[n];return this},this.copyFrom=function(t){for(var r=this.data,e=t.data||t,n=0;16>n;n++)r[n]=e[n];return this},this.copyRotationTo=function(t){var r=this.data,e=t.data||t;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],t},this.extractPosition=function(t){var r=this.data;return t.set(r[12],r[13],r[14]),t},this.determinant=function(){var t=this.data;return t[0]*(t[5]*t[10]-t[9]*t[6])+t[4]*(t[9]*t[2]-t[1]*t[10])+t[8]*(t[1]*t[6]-t[5]*t[2])},this.inverse=function(t){var r=this.data,e=t?t.data||t:this.data,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],u=r[5],c=r[6],l=r[7],f=r[8],h=r[9],d=r[10],p=r[11],m=r[12],v=r[13],S=r[14],y=r[15],R=n*u-i*s,x=n*c-o*s,Q=n*l-a*s,g=i*c-o*u,M=i*l-a*u,w=o*l-a*c,T=f*v-h*m,_=f*S-d*m,b=f*y-p*m,E=h*S-d*v,V=h*y-p*v,z=d*y-p*S,P=R*z-x*V+Q*E+g*b-M*_+w*T;return P?(P=1/P,e[0]=(u*z-c*V+l*E)*P,e[1]=(o*V-i*z-a*E)*P,e[2]=(v*w-S*M+y*g)*P,e[3]=(d*M-h*w-p*g)*P,e[4]=(c*b-s*z-l*_)*P,e[5]=(n*z-o*b+a*_)*P,e[6]=(S*Q-m*w-y*x)*P,e[7]=(f*w-d*Q+p*x)*P,e[8]=(s*V-u*b+l*T)*P,e[9]=(i*b-n*V-a*T)*P,e[10]=(m*M-v*Q+y*R)*P,e[11]=(h*Q-f*M-p*R)*P,e[12]=(u*_-s*E-c*T)*P,e[13]=(n*E-i*_+o*T)*P,e[14]=(v*x-m*g-S*R)*P,e[15]=(f*g-h*x+d*R)*P,t):null},this.inverseMat3=function(t){var r=this.data,e=t.data,n=this.determinant();if(Math.abs(n)<1e-4)return console.warn("> SQR.Matrix44 - Attempt to inverse a singular matrix44. ",this.data),console.trace(),t;{var i=r[0],o=r[4],a=r[8],s=(r[12],r[1]),u=r[5],c=r[9],l=(r[13],r[2]),f=r[6],h=r[10];r[14]}return n=1/n,e[0]=(u*h-c*f)*n,e[1]=(a*f-o*h)*n,e[2]=(o*c-a*u)*n,e[3]=(c*l-s*h)*n,e[4]=(i*h-a*l)*n,e[5]=(a*s-i*c)*n,e[6]=(s*f-u*l)*n,e[7]=(o*l-i*f)*n,e[8]=(i*u-o*s)*n,t},this.transpose=function(t){var r=this.data,e=t?t.data||t:this.data,n=r[0],i=r[4],o=r[8],a=r[1],s=r[5],u=r[9],c=r[2],l=r[6],f=r[10];e[0]=n,e[1]=i,e[2]=o,e[4]=a,e[5]=s,e[6]=u,e[8]=c,e[9]=l,e[10]=f},this.lookAt=function(t,r){var e=this.data,n=SQR.V3.__tv1,i=SQR.V3.__tv2,o=SQR.V3.__tv3;return r=r||SQR.V3.up,o.set(e[12],e[13],e[14]),o.sub(o,t).norm(),0===o.magsq()&&(o.z=1),n.cross(r,o).norm(),0===n.magsq()&&(o.x+=1e-4,n.cross(r,o).norm()),i.cross(o,n),e[0]=n.x,e[4]=i.x,e[8]=o.x,e[1]=n.y,e[5]=i.y,e[9]=o.y,e[2]=n.z,e[6]=i.z,e[10]=o.z,this
},t||this.identity()},SQR.Matrix44.__temp=new Float32Array(16),SQR.ProjectionMatrix=function(){"undefined"==typeof Float32Array&&(Float32Array=Array),this.data=new Float32Array(16),this.copyTo=function(t){for(var r=this.data,e=t.data||t,n=0;16>n;n++)e[n]=r[n];return t},this.identity()},SQR.ProjectionMatrix.getBoundsAtDistance=function(t,r,e,n){e=e||window.innerWidth,n=n||window.innerHeight;var i=e/n,o=Math.tan(t/180*Math.PI/2),a=r*o,s=a*i;return{w:s,h:a}},SQR.ProjectionMatrix.prototype.identity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},SQR.ProjectionMatrix.prototype.screenPixels2d=function(){return this.orthographic(window.innerWidth,0,window.innerHeight,0,-1,1e3),this},SQR.ProjectionMatrix.prototype.orthographic=function(t,r,e,n,i,o){var a=this.data;this.near=i,this.far=o;var s=r-t,u=e-n,c=o-i,l=(r+t)/s,f=(e+n)/u,h=(o+i)/c;return a[0]=2/s,a[4]=0,a[8]=0,a[12]=-l,a[1]=0,a[5]=2/u,a[9]=0,a[13]=-f,a[2]=0,a[6]=0,a[10]=-2/c,a[14]=-h,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},SQR.ProjectionMatrix.prototype.perspective=function(t,r,e,n){t=t||60,e=e||1,n=n||1e3;var i=this.data,o=e*Math.tan(t*Math.PI/360),a=n-e;return i[0]=e/(o*r),i[4]=0,i[8]=0,i[12]=0,i[1]=0,i[5]=e/o,i[9]=0,i[13]=0,i[2]=0,i[6]=0,i[10]=-(n+e)/a,i[14]=-(2*n*e)/a,i[3]=0,i[7]=0,i[11]=-1,i[15]=0,this.fov=t,this.near=e,this.far=n,this},SQR.ProjectionMatrix.prototype.transformVector=function(t,r){var e=t.x,n=t.y,i=t.z,o=t.w,a=this.data;return r=r||t,r.x=a[0]*e+a[4]*n+a[8]*i+a[12]*o,r.y=a[1]*e+a[5]*n+a[9]*i+a[13]*o,r.z=a[2]*e+a[6]*n+a[10]*i+a[14]*o,r},SQR.Quaternion=function(t,r,e,n){this.set(n,t,r,e)},SQR.Quaternion.prototype.set=function(t,r,e,n){return this.w=n||1,this.x=t||0,this.y=r||0,this.z=e||0,this},SQR.Quaternion.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,this},SQR.Quaternion.prototype.copyFrom=function(t){return t instanceof Array?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w),this},SQR.Quaternion.prototype.identity=function(){return this.set(),this},SQR.Quaternion.prototype.mul=function(t,r){r=r||this;var e=r.w*t.w-r.x*t.x-r.y*t.y-r.z*t.z,n=r.w*t.x+r.x*t.w+r.y*t.z-r.z*t.y,i=r.w*t.y-r.x*t.z+r.y*t.w+r.z*t.x,o=r.w*t.z+r.x*t.y-r.y*t.x+r.z*t.w;return r.set(n,i,o,e),r.normalize(),r},SQR.Quaternion.prototype.dot=function(){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w},SQR.Quaternion.prototype.lookAt=function(t,r){var e=SQR.Quaternion.__tv1,n=SQR.Quaternion.__tv2,i=SQR.Quaternion.__tv3;t.copyTo(e),r.copyTo(i),e.norm(),-1==e.z&&(e.x=1e-4,e.norm()),n.cross(i,e),i.cross(e,n),this.w=.5*Math.sqrt(1+n.x+i.y+e.z);var o=4*this.w;return this.x=(e.y-i.z)/o,this.y=(n.z-e.x)/o,this.z=(i.x-n.y)/o,this.normalize(),this},SQR.Quaternion.prototype.fromAngleAxis=function(t,r,e,n){var i=Math.sin(t/2);return this.x=r*i,this.y=e*i,this.z=n*i,this.w=Math.cos(t/2),this},SQR.Quaternion.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},SQR.Quaternion.prototype.normalize=function(){var t=this.mag();return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this},SQR.Quaternion.prototype.neg=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},SQR.Quaternion.prototype.toMatrix=function(){throw"SQR.Quaternion.toMatrix() is not implemented. Check SQR.Matrix44.TQS()"},SQR.Quaternion.slerp=function(t,r,e,n){if(n=n||new SQR.Quaternion,0===e)return n.copyFrom(t);if(1===e)return n.copyFrom(r);var i=SQR.Quaternion.dot(t,r);0>i&&(t.neg(),i=SQR.Quaternion.dot(t,r));var o=Math.acos(i),a=Math.sqrt(1-i*i),s=Math.sin((1-e)*o)/a,u=Math.sin(e*o)/a;return Math.abs(i)>=1?(s=1,u=0):Math.abs(a)<.001&&(s=.5,u=.5),n.w=t.w*s+r.w*u,n.x=t.x*s+r.x*u,n.y=t.y*s+r.y*u,n.z=t.z*s+r.z*u,n},SQR.Quaternion.dot=function(t,r){return t.x*r.x+t.y*r.y+t.z*r.z+t.w*r.w},SQR.Quaternion.prototype.slerp=function(t,r,e){return SQR.Quaternion.slerp(t,r,e,this),this},SQR.Quaternion.__tv1=new SQR.Quaternion,SQR.Quaternion.__tv2=new SQR.Quaternion,SQR.Quaternion.__tv3=new SQR.Quaternion,SQR.V2=function(t,r){this.set(t,r),this.size=2},SQR.V2.prototype.set=function(t,r){return this.x=t||0,this.y=r||0,this},SQR.V2.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,t},SQR.V2.prototype.copyFrom=function(t){return t instanceof Array?(this.x=t[0],this.y=t[1]):(this.x=t.x,this.y=t.y),this},SQR.V2.prototype.clone=function(){return new SQR.V2(this.x,this.y)},SQR.V2.prototype.magsq=function(){return this.x*this.x+this.y*this.y},SQR.V2.prototype.mag=function(){return Math.sqrt(this.magsq())},SQR.V2.prototype.isZero=function(){return 0==this.x&&0==this.y},SQR.V2.prototype.mul=function(t){return this.x*=t,this.y*=t,this},SQR.V2.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this},SQR.V2.prototype.norm=function(){var t=1/this.mag();return this.set(this.x*t,this.y*t),this},SQR.V2.prototype.add=function(t,r){return r=r||this,this.x=t.x+r.x,this.y=t.y+r.y,this},SQR.V2.prototype.sub=function(t,r){return r=r||this,this.x=t.x-r.x,this.y=t.y-r.y,this},SQR.V2.prototype.lerp=function(t,r,e){return this.x=t.x+(r.x-t.x)*e,this.y=t.y+(r.y-t.y)*e,this},SQR.V2.dot=function(t,r){return t.x*r.x+t.y*r.y},SQR.V2.prototype.perp=function(){return this.set(this.y,-this.x),this},SQR.V2.prototype.toUniform=function(){return this.toArray()},SQR.V2.prototype.toArray=function(){return this.array||(this.array=new Float32Array(2)),this.array[0]=this.x,this.array[1]=this.y,this.array},SQR.V3=function(t,r,e){this.set(t,r,e),this.size=3,SQR.V3.instances++},SQR.V3.prototype.set=function(t,r,e,n){return this.x=t||0,this.y=r||0,this.z=e||0,this.w=n||1,this},SQR.V3.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,void 0!=t.z&&(t.z=this.z),t},SQR.V3.prototype.copyFrom=function(t){return t instanceof Array?(this.x=t[0],this.y=t[1],this.z=t[2]||0):(this.x=t.x,this.y=t.y,this.z=t.z||0),this},SQR.V3.prototype.clone=function(){return new SQR.V3(this.x,this.y,this.z)},SQR.V3.prototype.magsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},SQR.V3.prototype.mag=function(){return Math.sqrt(this.magsq())},SQR.V3.prototype.isZero=function(){return Math.abs(this.x)<SQR.EPSILON&&Math.abs(this.y)<SQR.EPSILON&&Math.abs(this.z)<SQR.EPSILON},SQR.V3.prototype.mul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},SQR.V3.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},SQR.V3.prototype.norm=function(){var t=1/this.mag();return this.set(this.x*t,this.y*t,this.z*t),this},SQR.V3.prototype.add=function(t,r){return r=r||this,this.x=t.x+r.x,this.y=t.y+r.y,this.z=t.z+r.z,this},SQR.V3.prototype.sub=function(t,r){return this.x=t.x-r.x,this.y=t.y-r.y,this.z=t.z-r.z,this},SQR.V3.prototype.lerp=function(t,r,e){return this.x=t.x+(r.x-t.x)*e,this.y=t.y+(r.y-t.y)*e,this.z=t.z+(r.z-t.z)*e,this},SQR.V3.prototype.random=function(){return this.x=2*Math.random()-1,this.y=2*Math.random()-1,this.z=2*Math.random()-1,this},SQR.V3.dot=function(t,r){return t.x*r.x+t.y*r.y+t.z*r.z},SQR.V3.prototype.cross=function(t,r){var e=t.y*r.z-t.z*r.y,n=t.z*r.x-t.x*r.z,i=t.x*r.y-t.y*r.x;return this.set(e,n,i,this.w),this},SQR.V3.prototype.toUniform=function(){return this.toArray()},SQR.V3.prototype.toArray=function(){return this.array||(this.array=new Float32Array(3)),this.array[0]=this.x,this.array[1]=this.y,this.array[2]=this.z,this.array},SQR.V3.prototype.toString=function(){return x},SQR.V3.prototype.toScreenSpace=function(t,r){t=t||window.innerWidth,r=r||window.innerHeight,this.x=this.x/this.z*t/2+t/2,this.y=this.y/this.z*r/2+r/2,this.y=r-this.y},SQR.V3.prototype.addNormal=function(t){this.normal||(this.normal=new SQR.V3),this.normal.add(this.normal,t)},SQR.V3.prototype.resetNormal=function(){this.normal&&this.normal.set()},SQR.V3.up=new SQR.V3(0,1,0),SQR.V3.forward=new SQR.V3(0,0,1),SQR.V3.__tv1=new SQR.V3,SQR.V3.__tv2=new SQR.V3,SQR.V3.__tv3=new SQR.V3,SQR.V3.instances=0,SQR.Mesh=function(){if(!(this instanceof SQR.Mesh))return new SQR.Mesh;var t=this;t.polys=[],t.vertices=[],t.uvs=[],t.size=0,t.addVertex=function(r,e,n){var i=new SQR.Vertex(r,e,n);return t.vertices.push(i),t.vertices.length-1},t.addUV=function(r,e){var e=new SQR.V2(r,e);return t.uvs.push(e),t.uvs.length-1},t.addFace=function(){var r=new SQR.Poly(t);return r.V.apply(r,arguments),t.polys.push(r),t.size+=r.triangles.length,r},t.calculateNormals=function(r){t.smooth=r;for(var e=0,n=t.polys.length;n>e;e++)t.polys[e].calculateNormal();if(t.smooth)for(var e=0,n=t.vertices.length;n>e;e++)t.vertices[e].polys&&t.vertices[e].calculateNormal();return t},t.flip=function(){for(var r=0,e=t.polys.length;e>r;r++)t.polys[r].flip();return t},t.calculateTangents=function(){console.log("SQR.Mesh.calculateTangents is not implemented yet!")};var r=function(){var r=t.polys[0],e=t.size,n={aPosition:3};return r.normal&&(n.aNormal=3),r.uvs.length>0&&(n.aUV=2),t.buffer=SQR.Buffer().layout(n,e),t.buffer};t.update=function(){if(0==t.polys.length)return void console.warn("> SQR.Mesh.update > no polys found to create buffer from.");for(var e=t.buffer||r(),n=e.attributes.aPosition,i=0,o=[],a=0,s=t.polys.length;s>a;a++)for(var u=t.polys[a],c=0,l=u.triangles.length;l>c;c++){var f=u.triangles[c],h=t.vertices[u.vertices[f]],n=h.position,d=t.smooth?h.normal:u.normal,p=t.uvs[u.uvs[f]];o.length=0,o.push(n.x,n.y,n.z,d.x,d.y,d.z,p.x,p.y),e.set(null,i,o),i++}return e.update(),e.mesh||(e.mesh=t),e},t.V=t.addVertex,t.F=t.addFace,t.T=t.addUV},SQR.Mesh.fromJSON=function(t,r,e){var n;if(e=e||{},r)n=t[r];else if(t.vertices)n=t;else for(var i in t){n=t[i];break}if(!n)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var o={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},a=function(t){var r=n[t]||n[o[t]];return r&&r.length>0?r:0==r.length&&"aUV2"==t?a("aUV"):null},s=e.layout||t.layout||SQR.v3n3u2(),u=e.vertexSize||s.aPosition,c=(n.vertices||n.aPosition).length/u,l=SQR.Buffer().layout(s,c);for(var f in s){var i=a(f);i&&l.data(f,i)}var h=a("indices");return h&&l.index(h),l.update()},SQR.Poly=function(t){var r=this;r.mesh=t,r.triangles=[]},SQR.Poly.prototype.addVertices=function(){var t=this;if(t.size=arguments.length,t.size<3)throw"> SQR.Poly.addVertices > A poly needs at least 3 vertices.";t.vertices=[];for(var r=0;r<t.size;r++){var e=arguments[r];t.mesh.vertices[e].addPoly(t),t.vertices.push(e)}return t.size>=3&&t.triangles.push(0,1,2),t.size>=4&&t.triangles.push(2,1,3),t},SQR.Poly.prototype.addUV=function(t,r,e,n){var i=this;return i.uvs=[t,r,e],n&&i.uvs.push(n),i},SQR.Poly.prototype.flip=function(){var t=this,r=this.vertices,e=this.uvs,n=r[1];r[1]=r[2],r[2]=n,e&&(n=e[1],e[1]=e[2],e[2]=n),r.normal?r.normal.neg():t.normal?t.normal.neg():console.log("> SQR.Poly.flip > please consider calculating normal first, then flipping")},SQR.Poly.prototype.calculateNormal=function(){var t=this,r=this.vertices,e=t.mesh.vertices,n=SQR.V3.__tv1,i=SQR.V3.__tv2;return t.normal=t.normal||new SQR.V3,n.sub(e[r[0]].position,e[r[1]].position),n.isZero()&&t.size>3&&n.sub(e[r[0]].position,e[r[3]].position),i.sub(e[r[2]].position,e[r[0]].position),t.normal.cross(n,i).norm(),t},SQR.Poly.prototype.V=SQR.Poly.prototype.addVertices,SQR.Poly.prototype.T=SQR.Poly.prototype.addUV,SQR.Primitives.createPostEffect=function(t,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var e=new SQR.Transform("post-effect");return e.buffer=SQR.fullScreenQuad,t&&(e.shader=SQR.Shader(t,r)),e},SQR.Primitives.createSphere=function(t,r,e,n){var i=new SQR.Mesh;t=t||50,r=Math.max(3,Math.floor(r)||8),e=Math.max(3,Math.floor(e)||6),n=n||{};var o,a,s=2*Math.PI,u=Math.PI;for(a=0;e>=a;a++)for(o=0;r>o;o++){{var c=o/(r-1),l=a/e,f=-t*Math.cos(c*s)*Math.sin(l*u),h=t*Math.cos(l*u),d=t*Math.sin(c*s)*Math.sin(l*u);i.V(f,h,d)}i.T(c,1-l)}for(a=0;e>a;a++){var p=0==a,m=a==e-1;for(o=0;r>o;o++){var v=a,S=a+1,y=o,R=(o+1)%r,x=v*r+y,Q=v*r+R,g=S*r+y,M=S*r+R;p?i.F(x,M,g).T(x,M,g):m?i.F(x,Q,M).T(x,Q,M):i.F(x,Q,g,M).T(x,Q,g,M)}}return i.calculateNormals(n.smooth),n.flip&&i.flip(),i.update()},SQR.Vertex=function(t,r,e){var n=this;n.position=new SQR.V3(t,r,e),n.normal=new SQR.V3},SQR.Vertex.prototype.addPoly=function(t){var r=this;r.polys=r.polys||[],r.polys.push(t)},SQR.Vertex.prototype.calculateNormal=function(){var t=this;t.normal.set();for(var r=0,e=t.polys.length;e>r;r++)t.normal.add(t.polys[r].normal);t.normal.norm()},SQR.Gyro=function(){var t={x:0,y:0,z:0,w:1},r={},e=!1;r.getOrientation=function(){return t},r.hasGyro=function(){return e};var n=function(t,r,e){var n=-r,i=-t;z=e;var o=Math.cos(n/2),a=Math.cos(i/2),s=Math.cos(z/2),u=Math.sin(n/2),c=Math.sin(i/2),l=Math.sin(z/2),f=o*a*s-u*c*l;return n=u*a*s-o*c*l,i=o*c*s+u*a*l,z=o*a*l+u*c*s,{x:n,y:i,z:z,w:f}},i=function(t,r){return{w:t.w*r.w-t.x*r.x-t.y*r.y-t.z*r.z,x:t.w*r.x+t.x*r.w+t.y*r.z-t.z*r.y,y:t.w*r.y-t.x*r.z+t.y*r.w+t.z*r.x,z:t.w*r.z+t.x*r.y-t.y*r.x+t.z*r.w}},o=.5*Math.PI,a={x:Math.sin(.5*o),y:0,z:0,w:Math.cos(.5*o)},s=function(r){r.target.removeEventListener("deviceorientation",s,!0),r.target.addEventListener("deviceorientation",function(r){var o=n(r.alpha/180*Math.PI,r.beta/180*Math.PI,r.gamma/180*Math.PI),s=window.orientation/180*Math.PI,u={x:0,y:0,z:Math.sin(.5*s),w:Math.cos(.5*s)};t=o,t=i(a,t),t=i(u,t),null!=r.alpha&&(e=!0)},!0)};return window.addEventListener("deviceorientation",s,!0),r}();