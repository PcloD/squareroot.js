SQR.Gyro=function(){var e={x:0,y:0,z:0,w:1},t={},n=!1;t.getOrientation=function(){return e},t.hasGyro=function(){return n};var r=function(e,t,n){var r=-t,o=-e;z=n;var i=Math.cos(r/2),a=Math.cos(o/2),s=Math.cos(z/2),c=Math.sin(r/2),u=Math.sin(o/2),d=Math.sin(z/2),v=i*a*s-c*u*d;return r=c*a*s-i*u*d,o=i*u*s+c*a*d,z=i*a*d+c*u*s,{x:r,y:o,z:z,w:v}},o=function(e,t){return{w:e.w*t.w-e.x*t.x-e.y*t.y-e.z*t.z,x:e.w*t.x+e.x*t.w+e.y*t.z-e.z*t.y,y:e.w*t.y-e.x*t.z+e.y*t.w+e.z*t.x,z:e.w*t.z+e.x*t.y-e.y*t.x+e.z*t.w}},i=.5*Math.PI,a={x:Math.sin(.5*i),y:0,z:0,w:Math.cos(.5*i)},s=function(t){t.target.removeEventListener("deviceorientation",s,!0),t.target.addEventListener("deviceorientation",function(t){var i=r(t.alpha/180*Math.PI,t.beta/180*Math.PI,t.gamma/180*Math.PI),s=window.orientation/180*Math.PI,c={x:0,y:0,z:Math.sin(.5*s),w:Math.cos(.5*s)};e=i,e=o(a,e),e=o(c,e),null!=t.alpha&&(n=!0)},!0)};return window.addEventListener("deviceorientation",s,!0),t}(),SQR.VRApp=function(e,t){t=t||{},t.isTouch="ontouchstart"in document,t.vrInput=null,t.vrData={};var n,r,o,i={},a="<span>Put on your head set and press space when ready.</span>",s="CARDBOARD",c="NO CARDBOARD",u="Please rotate your screen to landscape mode",d=function(e){e.requestFullscreen?e.requestFullscreen(i):e.msRequestFullscreen?e.msRequestFullscreen(i):e.mozRequestFullScreen?e.mozRequestFullScreen(i):e.webkitRequestFullscreen&&e.webkitRequestFullscreen(i)},v=function(e){var n,r=function(t){console.log("Error in navigator.getVRDevices()"),console.log(t),e()},o=function(r){SQR.flipMatrix=!1;for(var o=0;o<r.length;o++){var a=r[o];!t.vrInput&&a instanceof PositionSensorVRDevice&&(t.vrInput=a),!n&&a instanceof HMDVRDevice&&(n=a),i.vrDisplay=n}t.vrData.leftEyeX=n.getEyeParameters("left").eyeTranslation.x,t.vrData.rightEyeX=n.getEyeParameters("right").eyeTranslation.x,e()};return navigator.mozGetVRDevices||navigator.getVRDevices?void(navigator.getVRDevices?navigator.getVRDevices().then(o,r):navigator.mozGetVRDevices(o)):(console.log("Your browser is not VR Ready"),void e())},l=function(e){32==e.keyCode&&(document.removeEventListener("keydown",l),m())},m=function(){n&&document.body.removeChild(n),r&&document.body.removeChild(r),o&&document.body.removeChild(o),(t.isTouch||t.vrInput&&!t.debug)&&d(document.body),e&&e(t)},p=function(){t.vrInput&&!t.isTouch?(o=document.createElement("div"),o.innerHTML=a+a,o.setAttribute("class","instr"),document.body.appendChild(o),document.addEventListener("keydown",l)):t.isTouch?(n=document.createElement("div"),n.setAttribute("class","start vr"),n.innerHTML=s,document.body.appendChild(n),r=document.createElement("div"),r.setAttribute("class","start novr"),r.innerHTML=c,document.body.appendChild(r),portWarn=document.createElement("div"),portWarn.setAttribute("class","portrait-warning"),portWarn.innerHTML=u,document.body.appendChild(portWarn),n.addEventListener("click",function(){t.forceStereo=!0,m()}),r.addEventListener("click",m)):m()};v(p)},SQR.VRPost=function(e,t,n,r){var o,i,a,s,c,u=r.vrInput||r.debug||r.forceStereo;t.autoClear=!1;var d=new SQR.Transform,v=new SQR.Transform;d.position.x=r.vrData.leftEyeX||-.1,v.position.x=r.vrData.rightEyeX||.1,(r.isTouch||r.vrInput)&&(e.useQuaternion=!0),e.add(d,v),r.customShader&&(s=SQR.FrameBuffer(0,0),c=SQR.Primitives.createPostEffect(r.customShader),c.uniforms={scale:new SQR.V2(.81,.81),scaleIn:new SQR.V2(1,1),lensCenter:new SQR.V2(0,0),hmdWarpParam:[1,.11,.12,0],chromAbParam:[.996,-.004,1.014,0]});var l={size:function(){var t=window.devicePixelRatio;o=window.innerWidth*t,i=window.innerHeight*t,a=o/2,n.size(window.innerWidth,window.innerHeight,t),r.customShader&&s.resize(a,i);var c=o/i,l=.5*o/i,m=(new SQR.ProjectionMatrix).perspective(u?75:50,u?l:c,.01,1e4);e.projection=m,d.projection=m,v.projection=m},render:function(s){if(r.vrInput){var c=r.vrInput.getState();null!==c.orientation&&e.quaternion.copyFrom(c.orientation),null!==c.position&&e.position.copyFrom(c.position)}else r.isTouch&&SQR.Gyro.hasGyro()?e.quaternion.copyFrom(SQR.Gyro.getOrientation()):r.customCameraAnimation&&r.customCameraAnimation();n.viewport(0,0,o,i),n.clear(),u?(n.viewport(0,0,a,i),t.render(s,d),n.viewport(a,0,a,i),t.render(s,v)):t.render(s,e)}};return l};