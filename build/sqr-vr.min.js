SQR.Gyro=function(){var e={x:0,y:0,z:0,w:1},t={},n=!1;t.getOrientation=function(){return e},t.hasGyro=function(){return n};var r=function(e,t,n){var r=-t,o=-e;z=n;var a=Math.cos(r/2),i=Math.cos(o/2),s=Math.cos(z/2),c=Math.sin(r/2),u=Math.sin(o/2),d=Math.sin(z/2),v=a*i*s-c*u*d;return r=c*i*s-a*u*d,o=a*u*s+c*i*d,z=a*i*d+c*u*s,{x:r,y:o,z:z,w:v}},o=function(e,t){return{w:e.w*t.w-e.x*t.x-e.y*t.y-e.z*t.z,x:e.w*t.x+e.x*t.w+e.y*t.z-e.z*t.y,y:e.w*t.y-e.x*t.z+e.y*t.w+e.z*t.x,z:e.w*t.z+e.x*t.y-e.y*t.x+e.z*t.w}},a=.5*Math.PI,i={x:Math.sin(.5*a),y:0,z:0,w:Math.cos(.5*a)},s=function(t){t.target.removeEventListener("deviceorientation",s,!0),t.target.addEventListener("deviceorientation",function(t){var a=r(t.alpha/180*Math.PI,t.beta/180*Math.PI,t.gamma/180*Math.PI),s=window.orientation/180*Math.PI,c={x:0,y:0,z:Math.sin(.5*s),w:Math.cos(.5*s)};e=a,e=o(i,e),e=o(c,e),null!=t.alpha&&(n=!0)},!0)};return window.addEventListener("deviceorientation",s,!0),t}(),SQR.VRApp=function(e,t){t=t||{},t.isTouch="ontouchstart"in document,t.vrInput=null,t.vrData={};var n,r,o,a={},i="<span>Put on your headset and press space when ready.</span>",s="CARDBOARD",c="NO CARDBOARD",u="Please rotate your screen to landscape mode",d=function(e){e.requestFullscreen?e.requestFullscreen(a):e.msRequestFullscreen?e.msRequestFullscreen(a):e.mozRequestFullScreen?e.mozRequestFullScreen(a):e.webkitRequestFullscreen&&e.webkitRequestFullscreen(a)},v=function(e){var n,r=function(t){console.log("VR: Error in navigator.getVRDevices()"),console.log(t),e()},o=function(r){SQR.flipMatrix=!1;for(var o=0;o<r.length;o++){var i=r[o];!t.vrInput&&i instanceof PositionSensorVRDevice&&(t.vrInput=i),!n&&i instanceof HMDVRDevice&&(n=i),a.vrDisplay=n}t.vrData.leftEyeX=n.getEyeParameters("left").eyeTranslation.x,t.vrData.rightEyeX=n.getEyeParameters("right").eyeTranslation.x,t.vrData.leftEyeFOV=n.getEyeParameters("left").recommendedFieldOfView,t.vrData.rightEyeFOV=n.getEyeParameters("right").recommendedFieldOfView,e()};return navigator.mozGetVRDevices||navigator.getVRDevices?void(navigator.getVRDevices?navigator.getVRDevices().then(o,r):navigator.mozGetVRDevices(o)):(console.log("VR: Your browser is not VR Ready"),void e())},l=function(e){32==e.keyCode&&(document.removeEventListener("keydown",l),m())},m=function(){n&&document.body.removeChild(n),r&&document.body.removeChild(r),o&&document.body.removeChild(o),(t.isTouch||t.vrInput&&!t.debug)&&d(document.body),e&&e(t)},h=function(){t.vrInput&&!t.isTouch?(o=document.createElement("div"),o.innerHTML=i+i,o.setAttribute("class","instr"),document.body.appendChild(o),document.addEventListener("keydown",l)):t.isTouch?(n=document.createElement("div"),n.setAttribute("class","start vr"),n.innerHTML=s,document.body.appendChild(n),r=document.createElement("div"),r.setAttribute("class","start novr"),r.innerHTML=c,document.body.appendChild(r),portWarn=document.createElement("div"),portWarn.setAttribute("class","portrait-warning"),portWarn.innerHTML=u,document.body.appendChild(portWarn),n.addEventListener("click",function(){t.forceStereo=!0,m()}),r.addEventListener("click",function(){t.forceMono=!0,m()})):m()};v(h)},SQR.VRPost=function(e,t,n,r){var o,a,i,s,c,u=r.vrInput&&!r.forceMono||r.forceStereo,d=!0,v=new SQR.Transform,l=new SQR.Transform;v.position.x=r.vrData.leftEyeX||-.1,l.position.x=r.vrData.rightEyeX||.1,(r.isTouch||r.vrInput)&&(e.useQuaternion=!0),e.add(v,l),t.autoClear=!1,r.customShader&&(s=SQR.FrameBuffer(0,0),c=SQR.Primitives.createPostEffect(r.customShader),c.uniforms={scale:new SQR.V2(.81,.81),scaleIn:new SQR.V2(1,1),lensCenter:new SQR.V2(0,0),hmdWarpParam:[1,.11,.12,0],chromAbParam:[.996,-.004,1.014,0]});var m={size:function(){var t=window.devicePixelRatio;o=window.innerWidth*t,a=window.innerHeight*t,i=o/2,n.size(window.innerWidth,window.innerHeight,t),r.customShader&&s.resize(i,a);var c=o/a,d=.5*o/a,m=u?80:50;r.vrData&&r.vrData.leftEyeFOV&&(m=2*r.vrData.leftEyeFOV.leftDegrees);var h=(new SQR.ProjectionMatrix).perspective(m,u?d:c,r.near||.1,r.far||1e4);e.projection=h,v.projection=h,l.projection=h},render:function(m){if(r.vrInput){var h=r.vrInput.getState();null!==h.orientation&&e.quaternion.copyFrom(h.orientation),null!==h.position&&e.position.copyFrom(h.position)}else r.isTouch&&SQR.Gyro.hasGyro()?e.quaternion.copyFrom(SQR.Gyro.getOrientation()):r.customCameraAnimation&&r.customCameraAnimation();if(n.viewport(0,0,o,a),n.clear(),u?r.customShader?(s.bind(),n.clear(),t.render(m,v),t.renderToScreen(),n.viewport(0,0,i,a),c.shader.use().setUniform("uTexture",s.texture),t.render(c),s.bind(),n.clear(),t.render(m,l),t.renderToScreen(),n.viewport(i,0,i,a),c.shader.use().setUniform("uTexture",s.texture),t.render(c)):(n.viewport(0,0,i,a),t.render(m,v),n.viewport(i,0,i,a),t.render(m,l)):t.render(m,e),d){if(r.target&&r.camRoot){var p=(new SQR.V3).sub(r.camRoot.position,r.target.position),y=(new SQR.V3).copyFrom(e.forward);p.y=0,y.y=0,p.norm(),y.norm();{var f=SQR.V3.dot(p,y);Math.acos(f)/Math.PI*180}r.camRoot.rotation.y=-Math.acos(f)}d=!1}}};return m};