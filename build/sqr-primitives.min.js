SQR.Primitives.createPoint=function(e,r){return SQR.Buffer().layout(SQR.v2(),1).setMode(SQR.gl.POINTS).data("aPosition",e||0,r||0).update()},SQR.Primitives.createCube=function(e,r,a,t){var n=this.V2,o=this.V3,i=this.F(t);e=e||1,r=r||1,a=a||1;var u=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},36),s=o(e*-.5,.5*r,.5*a),l=o(.5*e,.5*r,.5*a),c=o(e*-.5,r*-.5,.5*a),f=o(.5*e,r*-.5,.5*a),m=o(e*-.5,.5*r,a*-.5),v=o(.5*e,.5*r,a*-.5),S=o(e*-.5,r*-.5,a*-.5),d=o(.5*e,r*-.5,a*-.5),Q=n(0,1),h=n(1,1),R=n(0,0),p=n(1,0);return i(s,l,c,f).uv(Q,h,R,p),i(v,m,d,S).uv(Q,h,R,p),i(m,s,S,c).uv(Q,h,R,p),i(l,v,f,d).uv(Q,h,R,p),i(m,v,s,l).uv(Q,h,R,p),i(c,f,S,d).uv(Q,h,R,p),i.toBuffer(u),u.update()},SQR.Primitives.createSkybox=function(e){if(e=e||{},e.size=e.size||5,e.useDepth=void 0===e.useDepth?!0:e.useDepth,!e.glsl&&SQR.GLSL&&(e.glsl=e.use2dTextures?SQR.GLSL["shaders/skybox-2d.glsl"]:SQR.GLSL["shaders/skybox-cube.glsl"]),!e.glsl)throw"Missing shader code. Pass GLSL string as 2nd argument or include sqr-glsl.js to use the default one.";var r=new SQR.Transform,a=SQR.Shader(e.glsl);if(e.use2dTextures){var t={zUp:!0},n=e.size,o=SQR.Primitives.createPlane(n,n,1,1,0,0,t),i=function(r){var t=new SQR.Transform(r);return t.shader=a,t.useDepth=e.useDepth,t.buffer=o,t},u=i("front",t);u.position.z=n*-.5;var s=i("back",t);s.position.z=.5*n,s.rotation.y=Math.PI;var l=i("left",t);l.position.x=n*-.5,l.rotation.y=Math.PI*-.5;var c=i("right",t);c.position.x=.5*n,c.rotation.y=.5*Math.PI;var f=i("up");f.position.y=.5*n;var m=i("down");m.position.y=n*-.5,m.rotation.x=Math.PI,r.add(u,s,l,c,f,m),r.setTexture=function(e){e&&(console.log(e),u.uniforms={uTexture:SQR.Texture(e.front)},s.uniforms={uTexture:SQR.Texture(e.back)},l.uniforms={uTexture:SQR.Texture(e.left)},c.uniforms={uTexture:SQR.Texture(e.right)},f.uniforms={uTexture:SQR.Texture(e.up)},m.uniforms={uTexture:SQR.Texture(e.down)})}}else{var n=e.size;r.buffer=SQR.Primitives.createCube(n,n,n,{reverseNormals:!0}),r.shader=a,r.useDepth=e.useDepth,r.setTexture=function(e){e&&(r.cubemap=SQR.Cubemap(e),r.shader.use().setUniform("uCubemap",r.cubemap))}}return e.faces&&r.setTexture(e.faces),r},SQR.Primitives.createCylinder=function(e,r,a,t){t=t||{};var n,o,i,u,s,l,c=[],f=function(e,r,a,t,n,o,i,u){var s=(new SQR.Face).setPosition(e,r,a,t).setUV(n,o,i,u);c.push(s)};n=[],o=[],i=[],u=[];for(var m=0;a>m;m++){var v=new SQR.V3,S=new SQR.V3,d=new SQR.V2,Q=new SQR.V2,h=Math.cos(m/a*SQR.TWOPI)*r,R=Math.sin(m/a*SQR.TWOPI)*r;t.vertical?(v.set(R,e*-.5,h),S.set(R,.5*e,h)):(v.set(e*-.5,h,R),S.set(.5*e,h,R)),d.set(m/a,0),Q.set(m/a,1),t.noCaps||(t.vertical?(s=new SQR.V3(0,e*-.5,0),l=new SQR.V3(0,.5*e,0)):(s=new SQR.V3(e*-.5,0,0),l=new SQR.V3(.5*e,0,0))),n.push(v),o.push(S),i.push(d),u.push(Q),t.insideFaces&&(v._inside=v.clone(),S._inside=S.clone())}for(var m=0;a>m;m++){var p=n[m],V=o[m],b=i[m],g=u[m],w=(m+1)%a,P=n[w],y=o[w],x=i[w],N=u[w];if(t.heightSegments=t.heightSegments||t.hs||0,t.heightSegments)for(var T=(new SQR.V3).sub(V,p),M=(new SQR.V3).sub(y,P),_=(new SQR.V3).copyFrom(p),z=(new SQR.V3).copyFrom(P),U=new SQR.V3,F=new SQR.V3,w=t.heightSegments,I=0;w+1>I;I++)U.copyFrom(T).mul(1/w*I).add(p,U),F.copyFrom(M).mul(1/w*I).add(P,F),f(_.clone(),U.clone(),z.clone(),F.clone(),b,g,x,N),_.copyFrom(U),z.copyFrom(F);else f(p,V,P,y,b,g,x,N),t.noCaps&&t.insideFaces&&f(p._inside,P._inside,V._inside,y._inside,b,g,x,N);t.noCaps||(f(p,P,s,null,g,N,x),f(y,V,l,null,N,g,x))}var v,B=t.layout||{aPosition:3,aNormal:3,aUV:2},C=SQR.Buffer().layout(B,6*c.length),L=0;return c.forEach(function(e){L+=e.calculateNormal().toBuffer(C,L)}),C},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var r,a,t,n,o,i,u,s=[],l=[];e.setPaths=function(o,i,u,s){return r=o,a=o.length,t=i,n=u||10,c(s),e},e.makeCaps=function(){return e};var c=function(r){s.length=0,l.length=0,r=r||SQR.v3n3();for(var t=0;n>t;t++)for(var o=0;a>o;o++){var i=new SQR.V3;s.push(i)}for(var t=0;n-1>t;t++)for(var o=0;a>o;o++){var u=t*a+o,c=a-1>o?u+1:t*a,f=(t+1)*a+o,m=a-1>o?f+1:(t+1)*a,v=(new SQR.Face).setPosition(s[u],s[m],s[c]),S=(new SQR.Face).setPosition(s[u],s[f],s[m]);l.push(v,S)}e.buffer.layout(r,3*l.length)},f=function(u){for(var c=0;n>c;c++)for(var f=c/(n-1),m=i+f*o,v=t.matrixAt(m),S=0;a>S;S++){var d=s[c*a+S];d.copyFrom(r[S]),u&&u(f,d),v.transformVector(d)}for(var Q=0,c=0,h=l.length;h>c;c++)Q+=l[c].calculateNormal().toBuffer(e.buffer,Q,!1,!0)};return e.update=function(r,a,t){return i=r||0,u=a||1,o=u-i,f(t),e.buffer.update(),e},e},SQR.Face=function(){var e,r={},a=!1,t="aPosition",n="aNormal",o="aUV";return r.setPosition=r.v=function(e,a,t,n){return r.a=e||new SQR.V3,r.b=a||new SQR.V3,r.c=t||new SQR.V3,r.d=n,r},r.setIndex=r.i=function(t,n,o,i,u){return a=!0,r.ia=n,r.ib=o,r.ic=i,r.id=u,e=t,r},r.flip=function(){var e=r.b;r.b=r.c,r.c=e},r.setNormal=r.n=function(e){return r.normal=e,r},r.setUV=r.uv=function(e,a,t,n){return r.uva=e,r.uvb=a,r.uvc=t,r.uvd=n,r},r.setColor=r.cl=function(e,a,t,n){return r.ca=e,r.cb=a,r.cc=t,r.cd=n,r},r.calculateNormal=r.cn=function(){var t=SQR.V3.__tv1,n=SQR.V3.__tv2;return r.normal=new SQR.V3,a?(t.sub(e[r.ia],e[r.ib]),t.isZero()&&t.sub(e[r.ia],e[r.id]),n.sub(e[r.ic],e[r.ia])):(t.sub(r.a,r.b),t.isZero()&&t.sub(r.a,r.d),n.sub(r.c,r.a)),r.normal.cross(t,n),r},r.addNormalToVertices=function(){var t=a?e[r.ia]:r.a,n=a?e[r.ib]:r.b,o=a?e[r.ic]:r.c,i=a?e[r.id]:r.d;return t.addNormal(r.normal),n.addNormal(r.normal),o.addNormal(r.normal),i&&i.addNormal(r.normal),r},r.toBuffer=function(e,a,i,u){var s=a;if(e.attributes[t]&&(e.set(t,s+0,r.a).set(t,s+1,r.b).set(t,s+2,r.c),r.d&&e.set(t,s+3,r.c).set(t,s+4,r.b).set(t,s+5,r.d)),e.attributes[n]&&(r.normal||i)){var l=i,c=r.normal;u&&!l&&r.normal.norm(),e.set(n,s+0,l?r.a.normal:c).set(n,s+1,l?r.b.normal:c).set(n,s+2,l?r.c.normal:c),r.d&&e.set(n,s+3,l?r.c.normal:c).set(n,s+4,l?r.b.normal:c).set(n,s+5,l?r.d.normal:c)}return e.attributes[o]&&r.uva&&(e.set(o,s+0,r.uva).set(o,s+1,r.uvb).set(o,s+2,r.uvc),r.d&&e.set(o,s+3,r.uvc).set(o,s+4,r.uvb).set(o,s+5,r.uvd)),r.d?6:3},r},SQR.Primitives.createIcosphere=function(e,r,a){var t=[],n=[],o=[],i=0;a=a||{};var u=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],s=new SQR.V3,l=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var r,a;return s.copyFrom(e),s.norm(),r=1-(.5+Math.atan2(s.z,s.x)/SQR.TWOPI),a=1-(.5-Math.asin(s.y)/Math.PI),new SQR.V2(r,a)}),c=function(e,r,a,n,o,i){var u=l(e),s=l(r),c=l(a),f=(new SQR.Face).setPosition(e,r,a).setUV(u,s,c).setColor(n,o,i);t.push(f)},f=function(r,a){for(var t=n.length,o=0;t>o;o++){var i=n[o],u=i.__v1==r&&i.__v2==a,s=i.__v2==r&&i.__v1==a;if(u||s)return i}var l=new SQR.V3;return l.sub(r,a).mul(.5).add(l,a).norm().mul(e),l.__v1=r,l.__v2=a,n.push(l),l.normal=l.clone(),l},m=function(){o[i]={};var e=o[i];e.faces=t,e.vectors=n,t=[];for(var r=e.faces.length,a=0;r>a;a++){var s=e.faces[a],l=f(s.a,s.b),m=f(s.a,s.c),v=f(s.b,s.c),S=u[i+1];c(s.a,l,m,s.ca,S,S),c(s.b,v,l,s.cb,S,S),c(s.c,m,v,s.cc,S,S),c(l,v,m,S,S,S)}i++},v=e,S=.5*(1+Math.sqrt(5))*v,d=function(r,t,o){var i=new SQR.V3(r,t,o).norm();i.normal=i.clone(),a.reverseNormals&&i.normal.neg(),i.mul(e),n.push(i)},Q=function(e,r,a){var t=u[0];c(n[e],n[a],n[r],t,t,t)};for(d(-v,S,0),d(v,S,0),d(-v,-S,0),d(v,-S,0),d(0,-v,S),d(0,v,S),d(0,-v,-S),d(0,v,-S),d(S,0,-v),d(S,0,v),d(-S,0,-v),d(-S,0,v),Q(0,11,5),Q(0,5,1),Q(0,1,7),Q(0,7,10),Q(0,10,11),Q(1,5,9),Q(5,11,4),Q(11,10,2),Q(10,7,6),Q(7,1,8),Q(3,9,4),Q(3,4,2),Q(3,2,6),Q(3,6,8),Q(3,8,9),Q(4,9,5),Q(2,4,11),Q(6,2,10),Q(8,6,7),Q(9,8,1);r-->0;)m();var S,h=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*t.length),R=0;return t.forEach(function(e){a.flatShading&&e.calculateNormal(),R+=e.toBuffer(h,R,!a.flatShading)}),h},SQR.Mesh={fromJSON:function(e,r,a){var t;if(a=a||{},r)t=e[r];else if(e.vertices)t=e;else for(var n in e){t=e[n];break}if(!t)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var o={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",indices:"tris"},i=function(e){var r=t[e]||t[o[e]];return r&&r.length>0?r:null},u=a.layout||e.layout||SQR.v3n3u2(),s=a.vertexSize||u.aPosition,l=(t.vertices||t.aPosition).length/s,c=SQR.Buffer().layout(u,l);for(var f in u)if("aNormal"!=f||!a.skipNormals){var n=i(f);n&&c.data(f,n)}var m=i("indices");return m&&c.index(m),c.update()},calculateNormals:function(e){var r=e.getIndexArray(),a=e.getDataArray(),t=(new SQR.Face).setPosition(new SQR.V3,new SQR.V3,new SQR.V3);t.a.normal=new SQR.V3,t.b.normal=new SQR.V3,t.c.normal=new SQR.V3;for(var n=new SQR.V3,o=0;o<e.indexSize;o+=3){var i=r[o+0]*e.strideSize,u=r[o+1]*e.strideSize,s=r[o+2]*e.strideSize;t.a.set(a[i+0],a[i+1],a[i+2]),t.b.set(a[u+0],a[u+1],a[u+2]),t.c.set(a[s+0],a[s+1],a[s+2]),t.a.normal.set(a[i+3],a[i+4],a[i+5]),t.b.normal.set(a[u+3],a[u+4],a[u+5]),t.c.normal.set(a[s+3],a[s+4],a[s+5]),t.calculateNormal(),t.normal.norm(),t.addNormalToVertices(),a[i+3]=t.a.normal.x,a[i+4]=t.a.normal.y,a[i+5]=t.a.normal.z,a[u+3]=t.b.normal.x,a[u+4]=t.b.normal.y,a[u+5]=t.b.normal.z,a[s+3]=t.c.normal.x,a[s+4]=t.c.normal.y,a[s+5]=t.c.normal.z}e.iterate("aNormal",function(e,r){n.set(r[e+0],r[e+1],r[e+2]).norm(),r[e+0]=n.x,r[e+1]=n.y,r[e+2]=n.z}),e.update()}},SQR.Primitives.create2DQuad=function(e,r,a,t){return SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",e,r+t,e+a,r,e+a,r+t,e+a,r,e,r+t,e,r).data("aUV",0,0,1,1,1,0,1,1,0,0,0,1).update()},SQR.Primitives.createPlane=function(e,r,a,t,n,o,i){var u=[],s=[],l=new SQR.Buffer,i=i||{};l.width=e,l.height=r;var e=.5*e,r=.5*r,n=n||0,o=o||0,a=a||1,t=t||1;u.length=[];var c,f,m=-e+n,v=-r+o,S=l.width/a,d=l.height/t,Q=[],h=[];for(c=0;a+1>c;c++)for(f=0;t+1>f;f++){var R=m+c*S,p=v+f*d,V=c*(t+1)+f;h[V]=new SQR.V2(c/a,f/t),Q[V]=i.zUp?new SQR.V3(R,p,0):new SQR.V3(R,0,p)}for(c=0;a>c;c++)for(f=0;t>f;f++){var R=m+c*S,p=v+f*d,V=c*(t+1)+f,b=(c+1)*(t+1)+f,g=(new SQR.Face).setIndex(Q,V,V+1,b,b+1);u.push(g),s.push(V,V+1,b,b,V+1,b+1)}return layout=i&&i.layout?i.layout:{},layout.aPosition=3,layout.aNormal=3,layout.aUV=2,l.layout(layout,Q.length),u.forEach(function(e){e.calculateNormal(),e.addNormalToVertices()}),l.iterate("aPosition",function(e,r,a){var t=Q[a];r[e+0]=t.x,r[e+1]=t.y,r[e+2]=t.z}),l.iterate("aNormal",function(e,r,a){var t=Q[a];t.normal.norm(),r[e+0]=t.normal.x,r[e+1]=t.normal.y,r[e+2]=t.normal.z}),l.iterate("aUV",function(e,r,a){var t=h[a];r[e+0]=t.x,r[e+1]=t.y}),l.index(s),l.update()},SQR.Primitives.createPostEffect=function(e,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var a=new SQR.Transform("post-effect");return a.buffer=SQR.fullScreenQuad,a.shader=SQR.Shader(e,r),a},SQR.Primitives.createImage=function(e,r,a,t){if(!a&&!SQR.GLSL)throw"> SQR.Primitives.createImage > sqr-glsl.js package is required to use this feature.";a=a||SQR.GLSL["post/image.glsl"];var n=new SQR.Transform;n.buffer=SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var o=e,i=SQR.Texture(o);return n.shader=SQR.Shader(a,t),n.setImage=function(e){o=e,i.setSource(e).update(),n.shader.use().setUniform("uTexture",i)},n.setImage(o),n.size=function(e,a){var t=-1,i=1,u=1,s=-1,l=o.width,c=o.height,f=l/c*a,m=c/l*e;return"fit"==r?(f>e&&(s=-(m/a),i=m/a),m>a&&(t=-(f/e),u=f/e)):"cover"==r&&(f>e&&(t=-(f/e),u=f/e),m>a&&(s=-(m/a),i=m/a)),n.buffer.data("aPosition",t,i,u,i,u,s,t,i,u,s,t,s).update(),n},n},SQR.Primitives.createSphere=function(e,r,a,t){var n=[],o=[],i=[];t=t||{};var u,s,e=e||50,l=Math.max(3,Math.floor(r)||8),c=Math.max(3,Math.floor(a)||6),f=0,m=2*Math.PI,v=0,S=Math.PI;for(s=0;c>=s;s++)for(u=0;l>=u;u++){var d=u/l,Q=s/c,h=-e*Math.cos(f+d*m)*Math.sin(v+Q*S),R=e*Math.cos(v+Q*S),p=e*Math.sin(f+d*m)*Math.sin(v+Q*S);n.push(new SQR.V3(h,R,p)),o.push(new SQR.V2(d,1-Q))}for(s=0;c>s;s++)for(u=0;l>u;u++){var V,b=l+1,g=n[s*b+u+0],w=n[s*b+u+1],P=n[(s+1)*b+u+1],y=n[(s+1)*b+u+0],x=o[s*b+u+0],N=o[s*b+u+1],T=o[(s+1)*b+u+1],M=o[(s+1)*b+u+0];V=t.reverseNormals?(new SQR.Face).setPosition(w,g,P,y).setUV(N,x,T,M):(new SQR.Face).setPosition(g,w,y,P).setUV(x,N,M,T),t.flatShading?V.calculateNormal():(g.normal=g.clone().norm(),w.normal=w.clone().norm(),P.normal=P.clone().norm(),y.normal=y.clone().norm(),t.reverseNormals&&(g.normal.neg(),w.normal.neg(),P.normal.neg(),y.normal.neg())),i.push(V)}var _=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},6*i.length),z=0;return i.forEach(function(e){z+=e.toBuffer(_,z,!t.flatShading)}),_};