SQR.Primitives.createCube=function(e,r,t,a){e=e||1,r=r||1,t=t||1,a=a||{};var o=new SQR.Mesh,n=o.V(e*-.5,.5*r,.5*t),i=o.V(.5*e,.5*r,.5*t),s=o.V(e*-.5,r*-.5,.5*t),l=o.V(.5*e,r*-.5,.5*t),c=o.V(e*-.5,.5*r,t*-.5),u=o.V(.5*e,.5*r,t*-.5),f=o.V(e*-.5,r*-.5,t*-.5),v=o.V(.5*e,r*-.5,t*-.5),p=o.T(0,1),d=o.T(1,1),m=o.T(0,0),h=o.T(1,0);return o.F(n,i,s,l).T(p,d,m,h),o.F(u,c,v,f).T(p,d,m,h),o.F(c,n,f,s).T(p,d,m,h),o.F(i,u,l,v).T(p,d,m,h),o.F(c,u,n,i).T(p,d,m,h),o.F(s,l,f,v).T(p,d,m,h),o.calculateNormals(a.smooth),a.flip&&o.flip(),o.update()},SQR.Primitives.createCylinder=function(e,r,t,a){a=a||{};var o,n,i,s,l,c,u=[],f=function(e,r,t,a,o,n,i,s){var l=(new SQR.Face).setPosition(e,r,t,a).setUV(o,n,i,s);u.push(l)};o=[],n=[],i=[],s=[];for(var v=0;t>v;v++){var p=new SQR.V3,d=new SQR.V3,m=new SQR.V2,h=new SQR.V2,S=Math.cos(v/t*SQR.TWOPI)*r,Q=Math.sin(v/t*SQR.TWOPI)*r;a.vertical?(p.set(Q,e*-.5,S),d.set(Q,.5*e,S)):(p.set(e*-.5,S,Q),d.set(.5*e,S,Q)),m.set(v/t,0),h.set(v/t,1),a.noCaps||(a.vertical?(l=new SQR.V3(0,e*-.5,0),c=new SQR.V3(0,.5*e,0)):(l=new SQR.V3(e*-.5,0,0),c=new SQR.V3(.5*e,0,0))),o.push(p),n.push(d),i.push(m),s.push(h),a.insideFaces&&(p._inside=p.clone(),d._inside=d.clone())}for(var v=0;t>v;v++){var R=o[v],y=n[v],V=i[v],g=s[v],b=(v+1)%t,w=o[b],F=n[b],P=i[b],x=s[b];if(a.heightSegments=a.heightSegments||a.hs||0,a.heightSegments)for(var M=(new SQR.V3).sub(y,R),T=(new SQR.V3).sub(F,w),N=(new SQR.V3).copyFrom(R),_=(new SQR.V3).copyFrom(w),U=new SQR.V3,B=new SQR.V3,b=a.heightSegments,C=0;b+1>C;C++)U.copyFrom(M).mul(1/b*C).add(R,U),B.copyFrom(T).mul(1/b*C).add(w,B),f(N.clone(),U.clone(),_.clone(),B.clone(),V,g,P,x),N.copyFrom(U),_.copyFrom(B);else f(R,y,w,F,V,g,P,x),a.noCaps&&a.insideFaces&&f(R._inside,w._inside,y._inside,F._inside,V,g,P,x);a.noCaps||(f(R,w,l,null,g,x,P),f(F,y,c,null,x,g,P))}var p,I=a.layout||{aPosition:3,aNormal:3,aUV:2},z=SQR.Buffer().layout(I,6*u.length),k=0;return u.forEach(function(e){k+=e.calculateNormal().toBuffer(z,k)}),z},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var r,t,a,o,n,i,s,l=[],c=[];e.setPaths=function(n,i,s,l){return r=n,t=n.length,a=i,o=s||10,u(l),e},e.makeCaps=function(){return e};var u=function(r){l.length=0,c.length=0,r=r||SQR.v3n3();for(var a=0;o>a;a++)for(var n=0;t>n;n++){var i=new SQR.V3;l.push(i)}for(var a=0;o-1>a;a++)for(var n=0;t>n;n++){var s=a*t+n,u=t-1>n?s+1:a*t,f=(a+1)*t+n,v=t-1>n?f+1:(a+1)*t,p=(new SQR.Face).setPosition(l[s],l[v],l[u]),d=(new SQR.Face).setPosition(l[s],l[f],l[v]);c.push(p,d)}e.buffer.layout(r,3*c.length)},f=function(s,u){for(var f=0;o>f;f++)for(var v=f/(o-1),p=i+v*n,d=a.matrixAt(p),m=0;t>m;m++){var h=l[f*t+m];h.copyFrom(r[m]),s&&s(v,h,e),d.transformVector(h),u&&u(v,h,e)}for(var S=0,f=0,Q=c.length;Q>f;f++)S+=c[f].calculateNormal().toBuffer(e.buffer,S,!1,!0)};return e.update=function(r,t,a,o){return i=r||0,s=t||1,n=s-i,f(a,o),e.buffer.update(),e},e},SQR.Face=function(){return this instanceof SQR.Face?void 0:new SQR.Face},SQR.Face.prototype.setPosition=function(e,r,t,a){var o=this;return o.a=e||new SQR.V3,o.b=r||new SQR.V3,o.c=t||new SQR.V3,o.d=a,o},SQR.Face.prototype.setIndex=function(e,r,t,a,o){var n=this;return n.indexed=!0,n.ia=r,n.ib=t,n.ic=a,n.id=o,n.vertexArray=e,n},SQR.Face.prototype.flip=function(){var e=this,r=e.b;e.b=e.c,e.c=r},SQR.Face.prototype.setNormal=function(e){return this.normal=e,this},SQR.Face.prototype.setUV=function(e,r,t,a){var o=this;return o.uva=e,o.uvb=r,o.uvc=t,o.uvd=a,o},SQR.Face.prototype.setColor=function(e,r,t,a){var o=this;return o.ca=e,o.cb=r,o.cc=t,o.cd=a,o},SQR.Face.prototype.calculateNormal=function(){var e=this,r=SQR.V3.__tv1,t=SQR.V3.__tv2,a=e.vertexArray;return e.normal=e.normal||new SQR.V3,e.indexed?(r.sub(a[e.ia],a[e.ib]),r.isZero()&&r.sub(a[e.ia],a[e.id]),t.sub(a[e.ic],a[e.ia])):(r.sub(e.a,e.b),r.isZero()&&r.sub(e.a,e.d),t.sub(e.c,e.a)),e.normal.cross(r,t),e},SQR.Face.prototype.v=SQR.Face.prototype.setPosition,SQR.Face.prototype.i=SQR.Face.prototype.setIndex,SQR.Face.prototype.n=SQR.Face.prototype.setNormal,SQR.Face.prototype.uv=SQR.Face.prototype.setUV,SQR.Face.prototype.cl=SQR.Face.prototype.setColor,SQR.Face.prototype.cn=SQR.Face.prototype.calculateNormal,SQR.Face.prototype.addNormalToVertices=function(){var e=this,r=e.vertexArray,t=e.indexed?r[e.ia]:e.a,a=e.indexed?r[e.ib]:e.b,o=e.indexed?r[e.ic]:e.c,n=e.indexed?r[e.id]:e.d;return t.addNormal(e.normal),a.addNormal(e.normal),o.addNormal(e.normal),n&&n.addNormal(e.normal),e},SQR.Face.prototype.toBuffer=function(e,r,t,a){var o=this,n="aPosition",i="aNormal",s="aUV",l=r;if(e.attributes[n]&&(e.set(n,l+0,o.a).set(n,l+1,o.b).set(n,l+2,o.c),o.d&&e.set(n,l+3,o.c).set(n,l+4,o.b).set(n,l+5,o.d)),e.attributes[i]&&(o.normal||t)){var c=t,u=o.normal;a&&!c&&o.normal.norm(),e.set(i,l+0,c?o.a.normal:u).set(i,l+1,c?o.b.normal:u).set(i,l+2,c?o.c.normal:u),o.d&&e.set(i,l+3,c?o.c.normal:u).set(i,l+4,c?o.b.normal:u).set(i,l+5,c?o.d.normal:u)}return e.attributes[s]&&o.uva&&(e.set(s,l+0,o.uva).set(s,l+1,o.uvb).set(s,l+2,o.uvc),o.d&&e.set(s,l+3,o.uvc).set(s,l+4,o.uvb).set(s,l+5,o.uvd)),o.d?6:3},SQR.Primitives.createIcosphere=function(e,r,t){var a=[],o=[],n=[],i=0;t=t||{};var s=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],l=new SQR.V3,c=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var r,t;return l.copyFrom(e),l.norm(),r=1-(.5+Math.atan2(l.z,l.x)/SQR.TWOPI),t=1-(.5-Math.asin(l.y)/Math.PI),new SQR.V2(r,t)}),u=function(e,r,t,o,n,i){var s=c(e),l=c(r),u=c(t),f=(new SQR.Face).setPosition(e,r,t).setUV(s,l,u).setColor(o,n,i);a.push(f)},f=function(r,t){for(var a=o.length,n=0;a>n;n++){var i=o[n],s=i.__v1==r&&i.__v2==t,l=i.__v2==r&&i.__v1==t;if(s||l)return i}var c=new SQR.V3;return c.sub(r,t).mul(.5).add(c,t).norm().mul(e),c.__v1=r,c.__v2=t,o.push(c),c.normal=c.clone(),c},v=function(){n[i]={};var e=n[i];e.faces=a,e.vectors=o,a=[];for(var r=e.faces.length,t=0;r>t;t++){var l=e.faces[t],c=f(l.a,l.b),v=f(l.a,l.c),p=f(l.b,l.c),d=s[i+1];u(l.a,c,v,l.ca,d,d),u(l.b,p,c,l.cb,d,d),u(l.c,v,p,l.cc,d,d),u(c,p,v,d,d,d)}i++},p=e,d=.5*(1+Math.sqrt(5))*p,m=function(r,a,n){var i=new SQR.V3(r,a,n).norm();i.normal=i.clone(),t.reverseNormals&&i.normal.neg(),i.mul(e),o.push(i)},h=function(e,r,t){var a=s[0];u(o[e],o[t],o[r],a,a,a)};for(m(-p,d,0),m(p,d,0),m(-p,-d,0),m(p,-d,0),m(0,-p,d),m(0,p,d),m(0,-p,-d),m(0,p,-d),m(d,0,-p),m(d,0,p),m(-d,0,-p),m(-d,0,p),h(0,11,5),h(0,5,1),h(0,1,7),h(0,7,10),h(0,10,11),h(1,5,9),h(5,11,4),h(11,10,2),h(10,7,6),h(7,1,8),h(3,9,4),h(3,4,2),h(3,2,6),h(3,6,8),h(3,8,9),h(4,9,5),h(2,4,11),h(6,2,10),h(8,6,7),h(9,8,1);r-->0;)v();var d,S=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*a.length),Q=0;return a.forEach(function(e){t.flatShading&&e.calculateNormal(),Q+=e.toBuffer(S,Q,!t.flatShading)}),S},SQR.Mesh=function(){if(!(this instanceof SQR.Mesh))return new SQR.Mesh;var e=this;e.polys=[],e.vertices=[],e.uvs=[],e.size=0,e.addVertex=function(r,t,a){var o=new SQR.Vertex(r,t,a);return e.vertices.push(o),e.vertices.length-1},e.addUV=function(r,t){var t=new SQR.V2(r,t);return e.uvs.push(t),e.uvs.length-1},e.addFace=function(){var r=new SQR.Poly(e);return r.V.apply(r,arguments),e.polys.push(r),e.size+=r.triangles.length,r},e.calculateNormals=function(r){e.smooth=r;for(var t=0,a=e.polys.length;a>t;t++)e.polys[t].calculateNormal();if(e.smooth)for(var t=0,a=e.vertices.length;a>t;t++)e.vertices[t].polys&&e.vertices[t].calculateNormal();return e},e.flip=function(){for(var r=0,t=e.polys.length;t>r;r++)e.polys[r].flip();return e},e.calculateTangents=function(){console.log("SQR.Mesh.calculateTangents is not implemented yet!")};var r=function(){var r=e.polys[0],t=e.size,a={aPosition:3};return r.normal&&(a.aNormal=3),r.uvs.length>0&&(a.aUV=2),e.buffer=SQR.Buffer().layout(a,t),e.buffer};e.update=function(){if(0==e.polys.length)return void console.warn("> SQR.Mesh.update > no polys found to create buffer from.");for(var t=e.buffer||r(),a=t.attributes.aPosition,o=0,n=[],i=0,s=e.polys.length;s>i;i++)for(var l=e.polys[i],c=0,u=l.triangles.length;u>c;c++){var f=l.triangles[c],v=e.vertices[l.vertices[f]],a=v.position,p=e.smooth?v.normal:l.normal,d=e.uvs[l.uvs[f]];n.length=0,n.push(a.x,a.y,a.z,p.x,p.y,p.z,d.x,d.y),t.set(null,o,n),o++}return t.update(),t.mesh||(t.mesh=e),t},e.V=e.addVertex,e.F=e.addFace,e.T=e.addUV},SQR.Mesh.fromJSON=function(e,r,t){var a;if(t=t||{},r)a=e[r];else if(e.vertices)a=e;else for(var o in e){a=e[o];break}if(!a)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var n={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},i=function(e){var r=a[e]||a[n[e]];return r&&r.length>0?r:0==r.length&&"aUV2"==e?i("aUV"):null},s=t.layout||e.layout||SQR.v3n3u2(),l=t.vertexSize||s.aPosition,c=(a.vertices||a.aPosition).length/l,u=SQR.Buffer().layout(s,c);for(var f in s){var o=i(f);o&&u.data(f,o)}var v=i("indices");return v&&u.index(v),u.update()},SQR.Primitives.createPlane=function(e,r,t,a,o,n,i){var s,l,i=i||{},e=.5*e,r=.5*r,o=o||0,n=n||0,t=t||1,a=a||1,c=-e+o,u=-r+n,f=2*e/t,v=2*r/a,p=new SQR.Mesh;for(s=0;t+1>s;s++)for(l=0;a+1>l;l++){var d=c+s*f,m=u+l*v;i.zUp?p.V(d,m,0):p.V(d,0,m),p.T(s/t,l/a)}for(s=0;t>s;s++)for(l=0;a>l;l++){var d=c+s*f,m=u+l*v,h=(s+0)*(a+1)+l,S=(s+1)*(a+1)+l;p.F(h,h+1,S,S+1).T(h,h+1,S,S+1)}return p.calculateNormals(i.smooth),i.flip&&p.flip(),p.update()},SQR.Poly=function(e){var r=this;r.mesh=e,r.triangles=[]},SQR.Poly.prototype.addVertices=function(){var e=this;if(e.size=arguments.length,e.size<3)throw"> SQR.Poly.addVertices > A poly needs at least 3 vertices.";e.vertices=[];for(var r=0;r<e.size;r++){var t=arguments[r];e.mesh.vertices[t].addPoly(e),e.vertices.push(t)}return e.size>=3&&e.triangles.push(0,1,2),e.size>=4&&e.triangles.push(2,1,3),e},SQR.Poly.prototype.addUV=function(e,r,t,a){var o=this;return o.uvs=[e,r,t],a&&o.uvs.push(a),o},SQR.Poly.prototype.flip=function(){var e=this,r=this.vertices,t=this.uvs,a=r[1];r[1]=r[2],r[2]=a,t&&(a=t[1],t[1]=t[2],t[2]=a),r.normal?r.normal.neg():e.normal?e.normal.neg():console.log("> SQR.Poly.flip > please consider calculating normal first, then flipping")},SQR.Poly.prototype.calculateNormal=function(){var e=this,r=this.vertices,t=e.mesh.vertices,a=SQR.V3.__tv1,o=SQR.V3.__tv2;return e.normal=e.normal||new SQR.V3,a.sub(t[r[0]].position,t[r[1]].position),a.isZero()&&e.size>3&&a.sub(t[r[0]].position,t[r[3]].position),o.sub(t[r[2]].position,t[r[0]].position),e.normal.cross(a,o).norm(),e},SQR.Poly.prototype.V=SQR.Poly.prototype.addVertices,SQR.Poly.prototype.T=SQR.Poly.prototype.addUV,SQR.Primitives.createPostEffect=function(e,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var t=new SQR.Transform("post-effect");return t.buffer=SQR.fullScreenQuad,t.shader=SQR.Shader(e,r),t},SQR.SceneParser=function(){var e=function(e,r){r.x=e[0],r.y=e[1],r.z=e[2],r.w&&(r.w=e[3])};return{parse:function(r,t){t=t||{};var a=t.prefix||"",o=r[a+"scene"],n=r[a+"mesh"],i=r[a+"anim"];if(t.context){var s=o.background;t.context.clearColor(s.r,s.g,s.b)}var l=function(){var e;return function(){return e||(e=t.shader.setUniform?t.shader:SQR.Shader(t.shader)),e}}();SQR.flipMatrix=t&&t.flipMatrix?t.flipMatrix:!1;var c={},u={},f=[],v={};for(var p in n){var d=n[p],m=SQR.v3n3u2();d.boneWeights&&(m.aWeight=4,m.aIndex=4),d.uv2&&(m.aUV2=2);var h=SQR.Mesh.fromJSON(d,null,{layout:m});c[p]=h,u[d.name]=h}for(var S in o.materials){var Q=o.materials[S];Q.color=SQR.Color().setRGB(Q.color.r,Q.color.g,Q.color.b)}var R,y=new SQR.Transform,V=o.transforms;V.forEach(function(r){var t=new SQR.Transform(r.name,r.uid);if(t.useQuaternion=!0,e(r.position,t.position),e(r.rotation,t.quaternion),r.scale&&e(r.scale,t.scale),t.data=r,r.bones&&f.push(t),r.camera){R=t;var a=o.cameras[r.camera],n=window.innerWidth,i=window.innerHeight,s=n/i;R.projection=(new SQR.ProjectionMatrix).perspective(a.fov,s,a.near,a.far)}if(r.lightmapTileOffset&&(t.uniforms=t.uniforms||{},t.uniforms.uLightmapTileOffset=r.lightmapTileOffset),r.mesh&&(t.buffer=c[r.meshId]),r.collider){var u;switch(r.collider.type){case"sphere":u=SQR.Collider.Sphere(),u.radius=r.collider.radius,e(r.collider.center,u.center);break;case"box":u=SQR.Collider.Box();var v=r.collider.center,p=r.collider.size;u.box={maxX:v[0]+p[0]/2,minX:v[0]-p[0]/2,maxY:v[1]+p[1]/2,minY:v[1]-p[1]/2,maxZ:v[2]+p[2]/2,minZ:v[2]-p[2]/2};break;case"mesh":u=SQR.Collider.Mesh(c[r.meshId])}t.collider=u}r.renderer&&(r.bones||(t.shader=l()),t.uniforms=t.uniforms||{},t.uniforms.uColor=o.materials[r.renderer].color),r.parent?y.findById(r.parent).add(t):y.add(t)}),f.forEach(function(e){var r=e.data.bones,a=[],o=r.length;r.forEach(function(e){a.push(y.findById(e))}),a[0].setAsBoneRoot();var n=[];e.shader=SQR.Shader(t.shader,{directives:[{name:"NUM_BONES",value:o},{name:"BONE_PER_VERTEX",value:4}]}),e.beforeDraw=function(){for(var r=0;o>r;r++)n[r]=a[r].computeBoneMatrix();e.shader.use().setUniform("uBones",n)}});for(var g in i){var b=i[g];v[g]={duration:b.length,transforms:{}};for(var w in b.curves){v[g].transforms[w]={properties:{}};for(var F in b.curves[w]){var P=[],x=b.curves[w][F];if(t.linearAnimation)for(var M=0;M<x.keys.length;M+=4){var T=x.keys[M+0],h=x.keys[M+1];P.push(new SQR.V2(T,h))}else for(var M=0;M<x.keys.length-4;M+=4){var N=x.keys[M+0],_=x.keys[M+1],U=x.keys[M+3],B=x.keys[M+4],C=x.keys[M+5],I=x.keys[M+6],z=new SQR.V2(N,_),k=new SQR.V2(B,C),E=(k.x-z.x)/3,O=new SQR.V2(E,E*U).add(z),A=new SQR.V2(-E,-E*I).add(k);P.push(new SQR.Bezier(z,O,A,k))}v[g].transforms[w].properties[F]=P}}}return y.recurse(function(e){if(e.data&&e.data.animationId){var r=e.data.animationId,a=v[r];if(!a)return;e.animation=SQR.Animation(a.duration);for(var o in a.transforms){var n=e.findByPath(o);n.clip=SQR.Clip(a.duration),e.animation.addClip(n.clip);for(var i in a.transforms[o].properties)n.clip.addProperty(i,a.transforms[o].properties[i])}t.autoPlay&&e.animation.play()}},!0),{root:y,camera:R,buffers:u}}}}(),SQR.Primitives.createSphere=function(e,r,t,a){var o=new SQR.Mesh;e=e||50,r=Math.max(3,Math.floor(r)||8),t=Math.max(3,Math.floor(t)||6),a=a||{};var n,i,s=2*Math.PI,l=Math.PI;for(i=0;t>=i;i++)for(n=0;r>n;n++){{var c=n/(r-1),u=i/t,f=-e*Math.cos(c*s)*Math.sin(u*l),v=e*Math.cos(u*l),p=e*Math.sin(c*s)*Math.sin(u*l);o.V(f,v,p)}o.T(c,1-u)}for(i=0;t>i;i++){var d=0==i,m=i==t-1;for(n=0;r>n;n++){var h=i,S=i+1,Q=n,R=(n+1)%r,y=h*r+Q,V=h*r+R,g=S*r+Q,b=S*r+R;d?o.F(y,b,g).T(y,b,g):m?o.F(y,V,b).T(y,V,b):o.F(y,V,g,b).T(y,V,g,b)}}return o.calculateNormals(a.smooth),a.flip&&o.flip(),o.update()},SQR.Vertex=function(e,r,t){var a=this;a.position=new SQR.V3(e,r,t),a.normal=new SQR.V3},SQR.Vertex.prototype.addPoly=function(e){var r=this;r.polys=r.polys||[],r.polys.push(e)},SQR.Vertex.prototype.calculateNormal=function(){var e=this;e.normal.set();for(var r=0,t=e.polys.length;t>r;r++)e.normal.add(e.polys[r].normal);e.normal.norm()};