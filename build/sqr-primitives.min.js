SQR.Primitives.createPoint=function(e,r){return SQR.Buffer().layout(SQR.v2(),1).setMode(SQR.gl.POINTS).data("aPosition",e||0,r||0).update()},SQR.Primitives.createCube=function(e,r,a,t){var n=this.V2,o=this.V3,i=this.F(t);e=e||1,r=r||1,a=a||1;var s=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},36),u=o(e*-.5,.5*r,.5*a),l=o(.5*e,.5*r,.5*a),c=o(e*-.5,r*-.5,.5*a),f=o(.5*e,r*-.5,.5*a),m=o(e*-.5,.5*r,a*-.5),v=o(.5*e,.5*r,a*-.5),S=o(e*-.5,r*-.5,a*-.5),d=o(.5*e,r*-.5,a*-.5),h=n(0,1),Q=n(1,1),R=n(0,0),p=n(1,0);return i(u,l,c,f).uv(h,Q,R,p),i(v,m,d,S).uv(h,Q,R,p),i(m,u,S,c).uv(h,Q,R,p),i(l,v,f,d).uv(h,Q,R,p),i(m,v,u,l).uv(h,Q,R,p),i(c,f,S,d).uv(h,Q,R,p),i.toBuffer(s),s.update()},SQR.Primitives.createSkybox=function(e){if(e=e||{},e.size=e.size||5,e.useDepth=void 0===e.useDepth?!0:e.useDepth,!e.glsl&&SQR.GLSL&&(e.glsl=e.use2dTextures?SQR.GLSL["shaders/skybox-2d.glsl"]:SQR.GLSL["shaders/skybox-cube.glsl"]),!e.glsl)throw"Missing shader code. Pass GLSL string as 2nd argument or include sqr-glsl.js to use the default one.";var r=new SQR.Transform,a=SQR.Shader(e.glsl);if(e.use2dTextures){var t={zUp:!0},n=e.size,o=SQR.Primitives.createPlane(n,n,1,1,0,0,t),i=function(r){var t=new SQR.Transform(r);return t.shader=a,t.useDepth=e.useDepth,t.buffer=o,t},s=i("front",t);s.position.z=n*-.5;var u=i("back",t);u.position.z=.5*n,u.rotation.y=Math.PI;var l=i("left",t);l.position.x=n*-.5,l.rotation.y=Math.PI*-.5;var c=i("right",t);c.position.x=.5*n,c.rotation.y=.5*Math.PI;var f=i("up");f.position.y=.5*n;var m=i("down");m.position.y=n*-.5,m.rotation.x=Math.PI,r.add(s,u,l,c,f,m),r.setTexture=function(e){e&&(console.log(e),s.uniforms={uTexture:SQR.Texture(e.front)},u.uniforms={uTexture:SQR.Texture(e.back)},l.uniforms={uTexture:SQR.Texture(e.left)},c.uniforms={uTexture:SQR.Texture(e.right)},f.uniforms={uTexture:SQR.Texture(e.up)},m.uniforms={uTexture:SQR.Texture(e.down)})}}else{var n=e.size;r.buffer=SQR.Primitives.createCube(n,n,n,{reverseNormals:!0}),r.shader=a,r.useDepth=e.useDepth,r.setTexture=function(e){e&&(r.cubemap=SQR.Cubemap(e),r.shader.use().setUniform("uCubemap",r.cubemap))}}return e.faces&&r.setTexture(e.faces),r},SQR.Primitives.createCylinder=function(e,r,a,t){t=t||{};var n,o,i,s,u,l,c=[],f=function(e,r,a,t,n,o,i,s){var u=(new SQR.Face).setPosition(e,r,a,t).setUV(n,o,i,s);c.push(u)};n=[],o=[],i=[],s=[];for(var m=0;a>m;m++){var v=new SQR.V3,S=new SQR.V3,d=new SQR.V2,h=new SQR.V2,Q=Math.cos(m/a*SQR.TWOPI)*r,R=Math.sin(m/a*SQR.TWOPI)*r;t.vertical?(v.set(R,e*-.5,Q),S.set(R,.5*e,Q)):(v.set(e*-.5,Q,R),S.set(.5*e,Q,R)),d.set(m/a,0),h.set(m/a,1),t.noCaps||(t.vertical?(u=new SQR.V3(0,e*-.5,0),l=new SQR.V3(0,.5*e,0)):(u=new SQR.V3(e*-.5,0,0),l=new SQR.V3(.5*e,0,0))),n.push(v),o.push(S),i.push(d),s.push(h),t.insideFaces&&(v._inside=v.clone(),S._inside=S.clone())}for(var m=0;a>m;m++){var p=n[m],w=o[m],b=i[m],g=s[m],V=(m+1)%a,P=n[V],x=o[V],y=i[V],N=s[V];if(t.heightSegments=t.heightSegments||t.hs||0,t.heightSegments)for(var T=(new SQR.V3).sub(w,p),M=(new SQR.V3).sub(x,P),I=(new SQR.V3).copyFrom(p),U=(new SQR.V3).copyFrom(P),_=new SQR.V3,B=new SQR.V3,V=t.heightSegments,F=0;V+1>F;F++)_.copyFrom(T).mul(1/V*F).add(p,_),B.copyFrom(M).mul(1/V*F).add(P,B),f(I.clone(),_.clone(),U.clone(),B.clone(),b,g,y,N),I.copyFrom(_),U.copyFrom(B);else f(p,w,P,x,b,g,y,N),t.noCaps&&t.insideFaces&&f(p._inside,P._inside,w._inside,x._inside,b,g,y,N);t.noCaps||(f(p,P,u,null,g,N,y),f(x,w,l,null,N,g,y))}var v,z=t.layout||{aPosition:3,aNormal:3,aUV:2},E=SQR.Buffer().layout(z,6*c.length),L=0;return c.forEach(function(e){L+=e.calculateNormal().toBuffer(E,L)}),E},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var r,a,t,n,o,i,s,u=[],l=[];e.setPaths=function(o,i,s,u){return r=o,a=o.length,t=i,n=s||10,c(u),e},e.makeCaps=function(){return e};var c=function(r){u.length=0,l.length=0,r=r||SQR.v3n3();for(var t=0;n>t;t++)for(var o=0;a>o;o++){var i=new SQR.V3;u.push(i)}for(var t=0;n-1>t;t++)for(var o=0;a>o;o++){var s=t*a+o,c=a-1>o?s+1:t*a,f=(t+1)*a+o,m=a-1>o?f+1:(t+1)*a,v=(new SQR.Face).setPosition(u[s],u[m],u[c]),S=(new SQR.Face).setPosition(u[s],u[f],u[m]);l.push(v,S)}e.buffer.layout(r,3*l.length)},f=function(s){for(var c=0;n>c;c++)for(var f=c/(n-1),m=i+f*o,v=t.matrixAt(m),S=0;a>S;S++){var d=u[c*a+S];d.copyFrom(r[S]),s&&s(f,d),v.transformVector(d)}for(var h=0,c=0,Q=l.length;Q>c;c++)h+=l[c].calculateNormal().toBuffer(e.buffer,h,!1,!0)};return e.update=function(r,a,t){return i=r||0,s=a||1,o=s-i,f(t),e.buffer.update(),e},e},SQR.Face=function(){var e,r={},a=!1,t="aPosition",n="aNormal",o="aUV";return r.setPosition=r.v=function(e,a,t,n){return r.a=e||new SQR.V3,r.b=a||new SQR.V3,r.c=t||new SQR.V3,r.d=n,r},r.setIndex=r.i=function(t,n,o,i,s){return a=!0,r.ia=n,r.ib=o,r.ic=i,r.id=s,e=t,r},r.flip=function(){var e=r.b;r.b=r.c,r.c=e},r.setNormal=r.n=function(e){return r.normal=e,r},r.setUV=r.uv=function(e,a,t,n){return r.uva=e,r.uvb=a,r.uvc=t,r.uvd=n,r},r.setColor=r.cl=function(e,a,t,n){return r.ca=e,r.cb=a,r.cc=t,r.cd=n,r},r.calculateNormal=r.cn=function(){var t=SQR.V3.__tv1,n=SQR.V3.__tv2;return r.normal=new SQR.V3,a?(t.sub(e[r.ia],e[r.ib]),t.isZero()&&t.sub(e[r.ia],e[r.id]),n.sub(e[r.ic],e[r.ia])):(t.sub(r.a,r.b),t.isZero()&&t.sub(r.a,r.d),n.sub(r.c,r.a)),r.normal.cross(t,n),r},r.addNormalToVertices=function(){var t=a?e[r.ia]:r.a,n=a?e[r.ib]:r.b,o=a?e[r.ic]:r.c,i=a?e[r.id]:r.d;return t.addNormal(r.normal),n.addNormal(r.normal),o.addNormal(r.normal),i&&i.addNormal(r.normal),r},r.toBuffer=function(e,a,i,s){var u=a;if(e.attributes[t]&&(e.set(t,u+0,r.a).set(t,u+1,r.b).set(t,u+2,r.c),r.d&&e.set(t,u+3,r.c).set(t,u+4,r.b).set(t,u+5,r.d)),e.attributes[n]&&(r.normal||i)){var l=i,c=r.normal;s&&!l&&r.normal.norm(),e.set(n,u+0,l?r.a.normal:c).set(n,u+1,l?r.b.normal:c).set(n,u+2,l?r.c.normal:c),r.d&&e.set(n,u+3,l?r.c.normal:c).set(n,u+4,l?r.b.normal:c).set(n,u+5,l?r.d.normal:c)}return e.attributes[o]&&r.uva&&(e.set(o,u+0,r.uva).set(o,u+1,r.uvb).set(o,u+2,r.uvc),r.d&&e.set(o,u+3,r.uvc).set(o,u+4,r.uvb).set(o,u+5,r.uvd)),r.d?6:3},r},SQR.Primitives.createIcosphere=function(e,r,a){var t=[],n=[],o=[],i=0;a=a||{};var s=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],u=new SQR.V3,l=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var r,a;return u.copyFrom(e),u.norm(),r=1-(.5+Math.atan2(u.z,u.x)/SQR.TWOPI),a=1-(.5-Math.asin(u.y)/Math.PI),new SQR.V2(r,a)}),c=function(e,r,a,n,o,i){var s=l(e),u=l(r),c=l(a),f=(new SQR.Face).setPosition(e,r,a).setUV(s,u,c).setColor(n,o,i);t.push(f)},f=function(r,a){for(var t=n.length,o=0;t>o;o++){var i=n[o],s=i.__v1==r&&i.__v2==a,u=i.__v2==r&&i.__v1==a;if(s||u)return i}var l=new SQR.V3;return l.sub(r,a).mul(.5).add(l,a).norm().mul(e),l.__v1=r,l.__v2=a,n.push(l),l.normal=l.clone(),l},m=function(){o[i]={};var e=o[i];e.faces=t,e.vectors=n,t=[];for(var r=e.faces.length,a=0;r>a;a++){var u=e.faces[a],l=f(u.a,u.b),m=f(u.a,u.c),v=f(u.b,u.c),S=s[i+1];c(u.a,l,m,u.ca,S,S),c(u.b,v,l,u.cb,S,S),c(u.c,m,v,u.cc,S,S),c(l,v,m,S,S,S)}i++},v=e,S=.5*(1+Math.sqrt(5))*v,d=function(r,t,o){var i=new SQR.V3(r,t,o).norm();i.normal=i.clone(),a.reverseNormals&&i.normal.neg(),i.mul(e),n.push(i)},h=function(e,r,a){var t=s[0];c(n[e],n[a],n[r],t,t,t)};for(d(-v,S,0),d(v,S,0),d(-v,-S,0),d(v,-S,0),d(0,-v,S),d(0,v,S),d(0,-v,-S),d(0,v,-S),d(S,0,-v),d(S,0,v),d(-S,0,-v),d(-S,0,v),h(0,11,5),h(0,5,1),h(0,1,7),h(0,7,10),h(0,10,11),h(1,5,9),h(5,11,4),h(11,10,2),h(10,7,6),h(7,1,8),h(3,9,4),h(3,4,2),h(3,2,6),h(3,6,8),h(3,8,9),h(4,9,5),h(2,4,11),h(6,2,10),h(8,6,7),h(9,8,1);r-->0;)m();var S,Q=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*t.length),R=0;return t.forEach(function(e){a.flatShading&&e.calculateNormal(),R+=e.toBuffer(Q,R,!a.flatShading)}),Q},SQR.Mesh={fromJSON:function(e,r,a){var t;if(a=a||{},r)t=e[r];else if(e.vertices)t=e;else for(var n in e){t=e[n];break}if(!t)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var o={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},i=function(e){var r=t[e]||t[o[e]];return r&&r.length>0?r:null},s=a.layout||e.layout||SQR.v3n3u2(),u=a.vertexSize||s.aPosition,l=(t.vertices||t.aPosition).length/u,c=SQR.Buffer().layout(s,l);for(var f in s)if("aNormal"!=f||!a.skipNormals){var n=i(f);n&&c.data(f,n)}var m=i("indices");return m&&c.index(m),c.update()},calculateNormals:function(e){var r=e.getIndexArray(),a=e.getDataArray(),t=(new SQR.Face).setPosition(new SQR.V3,new SQR.V3,new SQR.V3);t.a.normal=new SQR.V3,t.b.normal=new SQR.V3,t.c.normal=new SQR.V3;for(var n=new SQR.V3,o=0;o<e.indexSize;o+=3){var i=r[o+0]*e.strideSize,s=r[o+1]*e.strideSize,u=r[o+2]*e.strideSize;t.a.set(a[i+0],a[i+1],a[i+2]),t.b.set(a[s+0],a[s+1],a[s+2]),t.c.set(a[u+0],a[u+1],a[u+2]),t.a.normal.set(a[i+3],a[i+4],a[i+5]),t.b.normal.set(a[s+3],a[s+4],a[s+5]),t.c.normal.set(a[u+3],a[u+4],a[u+5]),t.calculateNormal(),t.normal.norm(),t.addNormalToVertices(),a[i+3]=t.a.normal.x,a[i+4]=t.a.normal.y,a[i+5]=t.a.normal.z,a[s+3]=t.b.normal.x,a[s+4]=t.b.normal.y,a[s+5]=t.b.normal.z,a[u+3]=t.c.normal.x,a[u+4]=t.c.normal.y,a[u+5]=t.c.normal.z}e.iterate("aNormal",function(e,r){n.set(r[e+0],r[e+1],r[e+2]).norm(),r[e+0]=n.x,r[e+1]=n.y,r[e+2]=n.z}),e.update()}},SQR.Primitives.create2DQuad=function(e,r,a,t){return SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",e,r+t,e+a,r,e+a,r+t,e+a,r,e,r+t,e,r).data("aUV",0,0,1,1,1,0,1,1,0,0,0,1).update()},SQR.Primitives.createPlane=function(e,r,a,t,n,o,i){var s=[],u=[],l=new SQR.Buffer,i=i||{};l.width=e,l.height=r;var e=.5*e,r=.5*r,n=n||0,o=o||0,a=a||1,t=t||1;s.length=[];var c,f,m=-e+n,v=-r+o,S=l.width/a,d=l.height/t,h=[],Q=[];for(c=0;a+1>c;c++)for(f=0;t+1>f;f++){var R=m+c*S,p=v+f*d,w=c*(t+1)+f;Q[w]=i.perQuadUV?new SQR.V2(c%2,f%2):new SQR.V2(c/a,f/t),h[w]=i.zUp?new SQR.V3(R,p,0):new SQR.V3(R,0,p)}for(c=0;a>c;c++)for(f=0;t>f;f++){var R=m+c*S,p=v+f*d,w=c*(t+1)+f,b=(c+1)*(t+1)+f,g=(new SQR.Face).setIndex(h,w,w+1,b,b+1);s.push(g),u.push(w,w+1,b,b,w+1,b+1)}return layout=i.layout?i.layout:{},layout.aPosition=3,layout.aNormal=3,layout.aUV=2,l.layout(layout,h.length),l.faces=s,l.vertices=h,l.recalculateNormals=function(){return s.forEach(function(e){e.calculateNormal(),e.addNormalToVertices()}),l},l.updateFromFaces=function(){return l.iterate("aPosition",function(e,r,a){var t=h[a];r[e+0]=t.x,r[e+1]=t.y,r[e+2]=t.z}),l.iterate("aNormal",function(e,r,a){var t=h[a];t.normal.norm(),r[e+0]=t.normal.x,r[e+1]=t.normal.y,r[e+2]=t.normal.z}),l.iterate("aUV",function(e,r,a){var t=Q[a];r[e+0]=t.x,r[e+1]=t.y}),l.index(u),l},l.recalculateNormals().updateFromFaces().update()},SQR.Primitives.createPostEffect=function(e,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var a=new SQR.Transform("post-effect");return a.buffer=SQR.fullScreenQuad,a.shader=SQR.Shader(e,r),a},SQR.Primitives.createImage=function(e,r,a,t){if(!a&&!SQR.GLSL)throw"> SQR.Primitives.createImage > sqr-glsl.js package is required to use this feature.";a=a||SQR.GLSL["post/image.glsl"];var n=new SQR.Transform;n.buffer=SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var o=e,i=SQR.Texture(o);return n.shader=SQR.Shader(a,t),n.setImage=function(e){o=e,i.setSource(e).update(),n.shader.use().setUniform("uTexture",i)},n.setImage(o),n.size=function(e,a){var t=-1,i=1,s=1,u=-1,l=o.width,c=o.height,f=l/c*a,m=c/l*e;return"fit"==r?(f>e&&(u=-(m/a),i=m/a),m>a&&(t=-(f/e),s=f/e)):"cover"==r&&(f>e&&(t=-(f/e),s=f/e),m>a&&(u=-(m/a),i=m/a)),n.buffer.data("aPosition",t,i,s,i,s,u,t,i,s,u,t,u).update(),n},n},SQR.SceneParser=function(){var e=function(){return{aPosition:3,aNormal:3,aUV:2,aWeight:4,aIndex:4}},r=function(e,r){r.x=e[0],r.y=e[1],r.z=e[2],r.w&&(r.w=e[3])};return{parse:function(a,t,n){var o=SQR.Shader(n.shader);SQR.flipMatrix=n&&n.flipMatrix?n.flipMatrix:!1;var i={},s={},u=[];for(var l in t){var c=t[l],f=c.boneWeights?e():SQR.v3n3u2(),m=SQR.Mesh.fromJSON(c,null,{layout:f});i[l]=m,s[c.name]=m}var v,S=new SQR.Transform,d=a.transforms;return d.forEach(function(e){var t=new SQR.Transform(e.name,e.uid);if(t.useQuaternion=!0,r(e.position,t.position),r(e.rotation,t.quaternion),t.data=e,e.bones&&u.push(t),e.camera){v=t;var n=a.cameras[e.camera],s=function(){var e=window.innerWidth,r=window.innerHeight,a=e/r;v.projection=(new SQR.ProjectionMatrix).perspective(n.fov,a,n.near,n.far)};window.addEventListener("resize",s),s()}e.mesh&&(t.buffer=i[e.meshId],e.bones||(t.shader=o)),e.parent?S.findById(e.parent).add(t):S.add(t)}),u.forEach(function(e){var r=e.data.bones,a=[],t=r.length;r.forEach(function(e){a.push(S.findById(e))}),a[0].setAsBoneRoot();var o=[];e.shader=SQR.Shader(n.shader,{directives:[{name:"NUM_BONES",value:t},{name:"BONE_PER_VERTEX",value:4}]}),e.beforeDraw=function(){for(var r=0;t>r;r++)o[r]=a[r].computeBoneMatrix();e.shader.use().setUniform("uBones",o)}}),{root:S,camera:v,buffers:s}}}}(),SQR.Primitives.createSphere=function(e,r,a,t){var n=[],o=[],i=[];t=t||{};var s,u,e=e||50,l=Math.max(3,Math.floor(r)||8),c=Math.max(3,Math.floor(a)||6),f=0,m=2*Math.PI,v=0,S=Math.PI;for(u=0;c>=u;u++)for(s=0;l>=s;s++){var d=s/l,h=u/c,Q=-e*Math.cos(f+d*m)*Math.sin(v+h*S),R=e*Math.cos(v+h*S),p=e*Math.sin(f+d*m)*Math.sin(v+h*S);n.push(new SQR.V3(Q,R,p)),o.push(new SQR.V2(d,1-h))}for(u=0;c>u;u++)for(s=0;l>s;s++){var w,b=l+1,g=n[u*b+s+0],V=n[u*b+s+1],P=n[(u+1)*b+s+1],x=n[(u+1)*b+s+0],y=o[u*b+s+0],N=o[u*b+s+1],T=o[(u+1)*b+s+1],M=o[(u+1)*b+s+0];w=t.reverseNormals?(new SQR.Face).setPosition(V,g,P,x).setUV(N,y,T,M):(new SQR.Face).setPosition(g,V,x,P).setUV(y,N,M,T),t.flatShading?w.calculateNormal():(g.normal=g.clone().norm(),V.normal=V.clone().norm(),P.normal=P.clone().norm(),x.normal=x.clone().norm(),t.reverseNormals&&(g.normal.neg(),V.normal.neg(),P.normal.neg(),x.normal.neg())),i.push(w)}var I=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},6*i.length),U=0;return i.forEach(function(e){U+=e.toBuffer(I,U,!t.flatShading)}),I};