SQR.Primitives.createCube=function(e,r,a,n){var t=this.V2,o=this.V3,i=this.F(n);e=e||1,r=r||1,a=a||1;var s=SQR.Buffer().layout(SQR.v3n3u2(),36),u=o(e*-.5,.5*r,.5*a),c=o(.5*e,.5*r,.5*a),l=o(e*-.5,r*-.5,.5*a),f=o(.5*e,r*-.5,.5*a),m=o(e*-.5,.5*r,a*-.5),v=o(.5*e,.5*r,a*-.5),d=o(e*-.5,r*-.5,a*-.5),S=o(.5*e,r*-.5,a*-.5),h=t(0,1),Q=t(1,1),R=t(0,0),p=t(1,0);return i(u,c,l,f).uv(h,Q,R,p),i(v,m,S,d).uv(h,Q,R,p),i(m,u,d,l).uv(h,Q,R,p),i(c,v,f,S).uv(h,Q,R,p),i(m,v,u,c).uv(h,Q,R,p),i(l,f,d,S).uv(h,Q,R,p),i.toBuffer(s),s.update()},SQR.Primitives.createCylinder=function(e,r,a,n){n=n||{};var t,o,i,s,u,c,l=[],f=function(e,r,a,n,t,o,i,s){var u=(new SQR.Face).setPosition(e,r,a,n).setUV(t,o,i,s);l.push(u)};t=[],o=[],i=[],s=[];for(var m=0;a>m;m++){var v=new SQR.V3,d=new SQR.V3,S=new SQR.V2,h=new SQR.V2,Q=Math.cos(m/a*SQR.TWOPI)*r,R=Math.sin(m/a*SQR.TWOPI)*r;n.vertical?(v.set(R,e*-.5,Q),d.set(R,.5*e,Q)):(v.set(e*-.5,Q,R),d.set(.5*e,Q,R)),S.set(m/a,0),h.set(m/a,1),n.noCaps||(n.vertical?(u=new SQR.V3(0,e*-.5,0),c=new SQR.V3(0,.5*e,0)):(u=new SQR.V3(e*-.5,0,0),c=new SQR.V3(.5*e,0,0))),t.push(v),o.push(d),i.push(S),s.push(h),n.insideFaces&&(v._inside=v.clone(),d._inside=d.clone())}for(var m=0;a>m;m++){var p=t[m],y=o[m],w=i[m],V=s[m],b=(m+1)%a,g=t[b],F=o[b],x=i[b],P=s[b];if(n.heightSegments=n.heightSegments||n.hs||0,n.heightSegments)for(var N=(new SQR.V3).sub(y,p),M=(new SQR.V3).sub(F,g),_=(new SQR.V3).copyFrom(p),B=(new SQR.V3).copyFrom(g),I=new SQR.V3,U=new SQR.V3,b=n.heightSegments,C=0;b+1>C;C++)I.copyFrom(N).mul(1/b*C).add(p,I),U.copyFrom(M).mul(1/b*C).add(g,U),f(_.clone(),I.clone(),B.clone(),U.clone(),w,V,x,P),_.copyFrom(I),B.copyFrom(U);else f(p,y,g,F,w,V,x,P),n.noCaps&&n.insideFaces&&f(p._inside,g._inside,y._inside,F._inside,w,V,x,P);n.noCaps||(f(p,g,u,null,V,P,x),f(F,y,c,null,P,V,x))}var v,E=n.layout||{aPosition:3,aNormal:3,aUV:2},z=SQR.Buffer().layout(E,6*l.length),k=0;return l.forEach(function(e){k+=e.calculateNormal().toBuffer(z,k)}),z},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var r,a,n,t,o,i,s,u=[],c=[];e.setPaths=function(o,i,s,u){return r=o,a=o.length,n=i,t=s||10,l(u),e},e.makeCaps=function(){return e};var l=function(r){u.length=0,c.length=0,r=r||SQR.v3n3();for(var n=0;t>n;n++)for(var o=0;a>o;o++){var i=new SQR.V3;u.push(i)}for(var n=0;t-1>n;n++)for(var o=0;a>o;o++){var s=n*a+o,l=a-1>o?s+1:n*a,f=(n+1)*a+o,m=a-1>o?f+1:(n+1)*a,v=(new SQR.Face).setPosition(u[s],u[m],u[l]),d=(new SQR.Face).setPosition(u[s],u[f],u[m]);c.push(v,d)}e.buffer.layout(r,3*c.length)},f=function(s,l){for(var f=0;t>f;f++)for(var m=f/(t-1),v=i+m*o,d=n.matrixAt(v),S=0;a>S;S++){var h=u[f*a+S];h.copyFrom(r[S]),s&&s(m,h,e),d.transformVector(h),l&&l(m,h,e)}for(var Q=0,f=0,R=c.length;R>f;f++)Q+=c[f].calculateNormal().toBuffer(e.buffer,Q,!1,!0)};return e.update=function(r,a,n,t){return i=r||0,s=a||1,o=s-i,f(n,t),e.buffer.update(),e},e},SQR.Face=function(){return this instanceof SQR.Face?void 0:new SQR.Face},SQR.Face.prototype.setPosition=function(e,r,a,n){var t=this;return t.a=e||new SQR.V3,t.b=r||new SQR.V3,t.c=a||new SQR.V3,t.d=n,t},SQR.Face.prototype.setIndex=function(e,r,a,n,t){var o=this;return o.indexed=!0,o.ia=r,o.ib=a,o.ic=n,o.id=t,o.vertexArray=e,o},SQR.Face.prototype.flip=function(){var e=this,r=e.b;e.b=e.c,e.c=r},SQR.Face.prototype.setNormal=function(e){return this.normal=e,this},SQR.Face.prototype.setUV=function(e,r,a,n){var t=this;return t.uva=e,t.uvb=r,t.uvc=a,t.uvd=n,t},SQR.Face.prototype.setColor=function(e,r,a,n){var t=this;return t.ca=e,t.cb=r,t.cc=a,t.cd=n,t},SQR.Face.prototype.calculateNormal=function(){var e=this,r=SQR.V3.__tv1,a=SQR.V3.__tv2,n=e.vertexArray;return e.normal=e.normal||new SQR.V3,e.indexed?(r.sub(n[e.ia],n[e.ib]),r.isZero()&&r.sub(n[e.ia],n[e.id]),a.sub(n[e.ic],n[e.ia])):(r.sub(e.a,e.b),r.isZero()&&r.sub(e.a,e.d),a.sub(e.c,e.a)),e.normal.cross(r,a),e},SQR.Face.prototype.v=SQR.Face.prototype.setPosition,SQR.Face.prototype.i=SQR.Face.prototype.setIndex,SQR.Face.prototype.n=SQR.Face.prototype.setNormal,SQR.Face.prototype.uv=SQR.Face.prototype.setUV,SQR.Face.prototype.cl=SQR.Face.prototype.setColor,SQR.Face.prototype.cn=SQR.Face.prototype.calculateNormal,SQR.Face.prototype.addNormalToVertices=function(){var e=this,r=e.vertexArray,a=e.indexed?r[e.ia]:e.a,n=e.indexed?r[e.ib]:e.b,t=e.indexed?r[e.ic]:e.c,o=e.indexed?r[e.id]:e.d;return a.addNormal(e.normal),n.addNormal(e.normal),t.addNormal(e.normal),o&&o.addNormal(e.normal),e},SQR.Face.prototype.toBuffer=function(e,r,a,n){var t=this,o="aPosition",i="aNormal",s="aUV",u=r;if(e.attributes[o]&&(e.set(o,u+0,t.a).set(o,u+1,t.b).set(o,u+2,t.c),t.d&&e.set(o,u+3,t.c).set(o,u+4,t.b).set(o,u+5,t.d)),e.attributes[i]&&(t.normal||a)){var c=a,l=t.normal;n&&!c&&t.normal.norm(),e.set(i,u+0,c?t.a.normal:l).set(i,u+1,c?t.b.normal:l).set(i,u+2,c?t.c.normal:l),t.d&&e.set(i,u+3,c?t.c.normal:l).set(i,u+4,c?t.b.normal:l).set(i,u+5,c?t.d.normal:l)}return e.attributes[s]&&t.uva&&(e.set(s,u+0,t.uva).set(s,u+1,t.uvb).set(s,u+2,t.uvc),t.d&&e.set(s,u+3,t.uvc).set(s,u+4,t.uvb).set(s,u+5,t.uvd)),t.d?6:3},SQR.Primitives.createIcosphere=function(e,r,a){var n=[],t=[],o=[],i=0;a=a||{};var s=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],u=new SQR.V3,c=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var r,a;return u.copyFrom(e),u.norm(),r=1-(.5+Math.atan2(u.z,u.x)/SQR.TWOPI),a=1-(.5-Math.asin(u.y)/Math.PI),new SQR.V2(r,a)}),l=function(e,r,a,t,o,i){var s=c(e),u=c(r),l=c(a),f=(new SQR.Face).setPosition(e,r,a).setUV(s,u,l).setColor(t,o,i);n.push(f)},f=function(r,a){for(var n=t.length,o=0;n>o;o++){var i=t[o],s=i.__v1==r&&i.__v2==a,u=i.__v2==r&&i.__v1==a;if(s||u)return i}var c=new SQR.V3;return c.sub(r,a).mul(.5).add(c,a).norm().mul(e),c.__v1=r,c.__v2=a,t.push(c),c.normal=c.clone(),c},m=function(){o[i]={};var e=o[i];e.faces=n,e.vectors=t,n=[];for(var r=e.faces.length,a=0;r>a;a++){var u=e.faces[a],c=f(u.a,u.b),m=f(u.a,u.c),v=f(u.b,u.c),d=s[i+1];l(u.a,c,m,u.ca,d,d),l(u.b,v,c,u.cb,d,d),l(u.c,m,v,u.cc,d,d),l(c,v,m,d,d,d)}i++},v=e,d=.5*(1+Math.sqrt(5))*v,S=function(r,n,o){var i=new SQR.V3(r,n,o).norm();i.normal=i.clone(),a.reverseNormals&&i.normal.neg(),i.mul(e),t.push(i)},h=function(e,r,a){var n=s[0];l(t[e],t[a],t[r],n,n,n)};for(S(-v,d,0),S(v,d,0),S(-v,-d,0),S(v,-d,0),S(0,-v,d),S(0,v,d),S(0,-v,-d),S(0,v,-d),S(d,0,-v),S(d,0,v),S(-d,0,-v),S(-d,0,v),h(0,11,5),h(0,5,1),h(0,1,7),h(0,7,10),h(0,10,11),h(1,5,9),h(5,11,4),h(11,10,2),h(10,7,6),h(7,1,8),h(3,9,4),h(3,4,2),h(3,2,6),h(3,6,8),h(3,8,9),h(4,9,5),h(2,4,11),h(6,2,10),h(8,6,7),h(9,8,1);r-->0;)m();var d,Q=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*n.length),R=0;return n.forEach(function(e){a.flatShading&&e.calculateNormal(),R+=e.toBuffer(Q,R,!a.flatShading)}),Q},SQR.Mesh=function(e){var r={},a=(new SQR.Face).setPosition(new SQR.V3,new SQR.V3,new SQR.V3);a.a.normal=new SQR.V3,a.b.normal=new SQR.V3,a.c.normal=new SQR.V3;var n=new SQR.V3;return r.calculateNormals=function(){for(var r=e.getIndexArray(),t=e.getDataArray(),o=0;o<e.indexSize;o+=3){var i=e.strideSize,s=r[o+0]*i,u=r[o+1]*i,c=r[o+2]*i;a.a.set(t[s+0],t[s+1],t[s+2]),a.b.set(t[u+0],t[u+1],t[u+2]),a.c.set(t[c+0],t[c+1],t[c+2]),a.a.normal.set(t[s+3],t[s+4],t[s+5]),a.b.normal.set(t[u+3],t[u+4],t[u+5]),a.c.normal.set(t[c+3],t[c+4],t[c+5]),a.calculateNormal(),a.normal.norm(),a.addNormalToVertices(),t[s+3]=a.a.normal.x,t[s+4]=a.a.normal.y,t[s+5]=a.a.normal.z,t[u+3]=a.b.normal.x,t[u+4]=a.b.normal.y,t[u+5]=a.b.normal.z,t[c+3]=a.c.normal.x,t[c+4]=a.c.normal.y,t[c+5]=a.c.normal.z}e.iterate("aNormal",function(e,r){n.set(r[e+0],r[e+1],r[e+2]).norm(),r[e+0]=n.x,r[e+1]=n.y,r[e+2]=n.z}),e.update()},r},SQR.Mesh.fromJSON=function(e,r,a){var n;if(a=a||{},r)n=e[r];else if(e.vertices)n=e;else for(var t in e){n=e[t];break}if(!n)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var o={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},i=function(e){var r=n[e]||n[o[e]];return r&&r.length>0?r:null},s=a.layout||e.layout||SQR.v3n3u2(),u=a.vertexSize||s.aPosition,c=(n.vertices||n.aPosition).length/u,l=SQR.Buffer().layout(s,c);for(var f in s){var t=i(f);t&&l.data(f,t)}var m=i("indices");return m&&l.index(m),l.mesh=SQR.Mesh(l),l.update()},SQR.Primitives.createPlane=function(e,r,a,n,t,o,i){var s=[],u=[],c=new SQR.Buffer,i=i||{};c.width=e,c.height=r;var e=.5*e,r=.5*r,t=t||0,o=o||0,a=a||1,n=n||1;s.length=[];var l,f,m=-e+t,v=-r+o,d=c.width/a,S=c.height/n,h=[],Q=[];for(l=0;a+1>l;l++)for(f=0;n+1>f;f++){var R=m+l*d,p=v+f*S,y=l*(n+1)+f;Q[y]=new SQR.V2(l/a,f/n),h[y]=i.zUp?new SQR.V3(R,p,0):new SQR.V3(R,0,p)}for(l=0;a>l;l++)for(f=0;n>f;f++){var R=m+l*d,p=v+f*S,y=l*(n+1)+f,w=(l+1)*(n+1)+f,V=(new SQR.Face).setIndex(h,y,y+1,w,w+1);s.push(V),u.push(y,y+1,w,w,y+1,w+1)}return layout=i.layout?i.layout:{},layout.aPosition=3,layout.aNormal=3,layout.aUV=2,c.layout(layout,h.length),c.faces=s,c.vertices=h,c.recalculateNormals=function(){return s.forEach(function(e){e.calculateNormal(),e.addNormalToVertices()}),c},c.updateFromFaces=function(){return c.iterate("aPosition",function(e,r,a){var n=h[a];r[e+0]=n.x,r[e+1]=n.y,r[e+2]=n.z}),c.iterate("aNormal",function(e,r,a){var n=h[a];n.normal.norm(),r[e+0]=n.normal.x,r[e+1]=n.normal.y,r[e+2]=n.normal.z}),c.iterate("aUV",function(e,r,a){var n=Q[a];r[e+0]=n.x,r[e+1]=n.y}),c.index(u),c},c.recalculateNormals().updateFromFaces().update()},SQR.Primitives.createPostEffect=function(e,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var a=new SQR.Transform("post-effect");return a.buffer=SQR.fullScreenQuad,a.shader=SQR.Shader(e,r),a},SQR.SceneParser=function(){var e=function(){return{aPosition:3,aNormal:3,aUV:2,aWeight:4,aIndex:4}},r=function(e,r){r.x=e[0],r.y=e[1],r.z=e[2],r.w&&(r.w=e[3])};return{parse:function(a,n){n=n||{};var t=n.prefix||"",o=a[t+"scene"],i=a[t+"mesh"],s=a[t+"anim"];if(n.context){var u=o.background;n.context.clearColor(u.r,u.g,u.b)}var c=function(){var e;return function(){return e||(e=SQR.Shader(n.shader)),e}}();SQR.flipMatrix=n&&n.flipMatrix?n.flipMatrix:!1;var l={},f={},m=[],v={};for(var d in i){var S=i[d],h=S.boneWeights?e():SQR.v3n3u2(),Q=SQR.Mesh.fromJSON(S,null,{layout:h});l[d]=Q,f[S.name]=Q}for(var R in o.materials){var p=o.materials[R];p.color=SQR.Color().setRGB(p.color.r,p.color.g,p.color.b)}var y,w=new SQR.Transform,V=o.transforms;V.forEach(function(e){var a=new SQR.Transform(e.name,e.uid);if(a.useQuaternion=!0,r(e.position,a.position),r(e.rotation,a.quaternion),a.data=e,e.bones&&m.push(a),e.camera){y=a;var n=o.cameras[e.camera],t=function(){var e=window.innerWidth,r=window.innerHeight,a=e/r;y.projection=(new SQR.ProjectionMatrix).perspective(n.fov,a,n.near,n.far)};window.addEventListener("resize",t),t()}e.mesh&&(a.buffer=l[e.meshId]),e.renderer&&(e.bones||(a.shader=c()),a.uniforms=a.uniforms||{},a.uniforms.uColor=o.materials[e.renderer].color),e.parent?w.findById(e.parent).add(a):w.add(a)}),m.forEach(function(e){var r=e.data.bones,a=[],t=r.length;r.forEach(function(e){a.push(w.findById(e))}),a[0].setAsBoneRoot();var o=[];e.shader=SQR.Shader(n.shader,{directives:[{name:"NUM_BONES",value:t},{name:"BONE_PER_VERTEX",value:4}]}),e.beforeDraw=function(){for(var r=0;t>r;r++)o[r]=a[r].computeBoneMatrix();e.shader.use().setUniform("uBones",o)}});for(var b in s){var g=s[b];v[b]={duration:g.length,transforms:{}};for(var F in g.curves){v[b].transforms[F]={properties:{}};for(var x in g.curves[F]){var P=[],N=g.curves[F][x];if(n.linearAnimation)for(var M=0;M<N.keys.length;M+=4){var _=N.keys[M+0],Q=N.keys[M+1];P.push(new SQR.V2(_,Q))}else for(var M=0;M<N.keys.length-4;M+=4){var B=N.keys[M+0],I=N.keys[M+1],U=N.keys[M+3],C=N.keys[M+4],E=N.keys[M+5],z=N.keys[M+6],k=new SQR.V2(B,I),T=new SQR.V2(C,E),A=(T.x-k.x)/3,W=new SQR.V2(A,A*U).add(k),O=new SQR.V2(-A,-A*z).add(T);P.push(new SQR.Bezier(k,W,O,T))}v[b].transforms[F].properties[x]=P}}}return w.recurse(function(e){if(e.data&&e.data.animationId){var r=e.data.animationId,a=v[r];if(!a)return;e.animation=SQR.Animation(a.duration);for(var t in a.transforms){var o=e.findByPath(t);o.clip=SQR.Clip(a.duration),e.animation.addClip(o.clip);for(var i in a.transforms[t].properties)o.clip.addProperty(i,a.transforms[t].properties[i])}n.autoPlay&&e.animation.play()}},!0),{root:w,camera:y,buffers:f}}}}(),SQR.Primitives.createSphere=function(e,r,a,n){var t=[],o=[],i=[];n=n||{};var s,u,e=e||50,c=Math.max(3,Math.floor(r)||8),l=Math.max(3,Math.floor(a)||6),f=0,m=2*Math.PI,v=0,d=Math.PI;for(u=0;l>=u;u++)for(s=0;c>=s;s++){var S=s/c,h=u/l,Q=-e*Math.cos(f+S*m)*Math.sin(v+h*d),R=e*Math.cos(v+h*d),p=e*Math.sin(f+S*m)*Math.sin(v+h*d);t.push(new SQR.V3(Q,R,p)),o.push(new SQR.V2(S,1-h))}for(u=0;l>u;u++)for(s=0;c>s;s++){var y,w=c+1,V=t[u*w+s+0],b=t[u*w+s+1],g=t[(u+1)*w+s+1],F=t[(u+1)*w+s+0],x=o[u*w+s+0],P=o[u*w+s+1],N=o[(u+1)*w+s+1],M=o[(u+1)*w+s+0];y=n.reverseNormals?(new SQR.Face).setPosition(b,V,g,F).setUV(P,x,N,M):(new SQR.Face).setPosition(V,b,F,g).setUV(x,P,M,N),n.flatShading?y.calculateNormal():(V.normal=V.clone().norm(),b.normal=b.clone().norm(),g.normal=g.clone().norm(),F.normal=F.clone().norm(),n.reverseNormals&&(V.normal.neg(),b.normal.neg(),g.normal.neg(),F.normal.neg())),i.push(y)}var _=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},6*i.length),B=0;return i.forEach(function(e){B+=e.toBuffer(_,B,!n.flatShading)}),_.update()};