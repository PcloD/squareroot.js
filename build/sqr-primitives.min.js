SQR.Primitives.createPoint=function(e,r){return SQR.Buffer().layout(SQR.v2(),1).setMode(SQR.gl.POINTS).data("aPosition",e||0,r||0).update()},SQR.Primitives.createCube=function(e,r,a,n){var t=this.V2,o=this.V3,i=this.F(n);e=e||1,r=r||1,a=a||1;var s=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},36),u=o(e*-.5,.5*r,.5*a),l=o(.5*e,.5*r,.5*a),f=o(e*-.5,r*-.5,.5*a),c=o(.5*e,r*-.5,.5*a),m=o(e*-.5,.5*r,a*-.5),v=o(.5*e,.5*r,a*-.5),d=o(e*-.5,r*-.5,a*-.5),S=o(.5*e,r*-.5,a*-.5),h=t(0,1),Q=t(1,1),R=t(0,0),p=t(1,0);return i(u,l,f,c).uv(h,Q,R,p),i(v,m,S,d).uv(h,Q,R,p),i(m,u,d,f).uv(h,Q,R,p),i(l,v,c,S).uv(h,Q,R,p),i(m,v,u,l).uv(h,Q,R,p),i(f,c,d,S).uv(h,Q,R,p),i.toBuffer(s),s.update()},SQR.Primitives.createSkybox=function(e){if(e=e||{},e.size=e.size||5,e.useDepth=void 0===e.useDepth?!0:e.useDepth,!e.glsl&&SQR.GLSL&&(e.glsl=e.use2dTextures?SQR.GLSL["shaders/skybox-2d.glsl"]:SQR.GLSL["shaders/skybox-cube.glsl"]),!e.glsl)throw"Missing shader code. Pass GLSL string as 2nd argument or include sqr-glsl.js to use the default one.";var r=new SQR.Transform,a=SQR.Shader(e.glsl);if(e.use2dTextures){var n={zUp:!0},t=e.size,o=SQR.Primitives.createPlane(t,t,1,1,0,0,n),i=function(r){var n=new SQR.Transform(r);return n.shader=a,n.useDepth=e.useDepth,n.buffer=o,n},s=i("front",n);s.position.z=t*-.5;var u=i("back",n);u.position.z=.5*t,u.rotation.y=Math.PI;var l=i("left",n);l.position.x=t*-.5,l.rotation.y=Math.PI*-.5;var f=i("right",n);f.position.x=.5*t,f.rotation.y=.5*Math.PI;var c=i("up");c.position.y=.5*t;var m=i("down");m.position.y=t*-.5,m.rotation.x=Math.PI,r.add(s,u,l,f,c,m),r.setTexture=function(e){e&&(console.log(e),s.uniforms={uTexture:SQR.Texture(e.front)},u.uniforms={uTexture:SQR.Texture(e.back)},l.uniforms={uTexture:SQR.Texture(e.left)},f.uniforms={uTexture:SQR.Texture(e.right)},c.uniforms={uTexture:SQR.Texture(e.up)},m.uniforms={uTexture:SQR.Texture(e.down)})}}else{var t=e.size;r.buffer=SQR.Primitives.createCube(t,t,t,{reverseNormals:!0}),r.shader=a,r.useDepth=e.useDepth,r.setTexture=function(e){e&&(r.cubemap=SQR.Cubemap(e),r.shader.use().setUniform("uCubemap",r.cubemap))}}return e.faces&&r.setTexture(e.faces),r},SQR.Primitives.createCylinder=function(e,r,a,n){n=n||{};var t,o,i,s,u,l,f=[],c=function(e,r,a,n,t,o,i,s){var u=(new SQR.Face).setPosition(e,r,a,n).setUV(t,o,i,s);f.push(u)};t=[],o=[],i=[],s=[];for(var m=0;a>m;m++){var v=new SQR.V3,d=new SQR.V3,S=new SQR.V2,h=new SQR.V2,Q=Math.cos(m/a*SQR.TWOPI)*r,R=Math.sin(m/a*SQR.TWOPI)*r;n.vertical?(v.set(R,e*-.5,Q),d.set(R,.5*e,Q)):(v.set(e*-.5,Q,R),d.set(.5*e,Q,R)),S.set(m/a,0),h.set(m/a,1),n.noCaps||(n.vertical?(u=new SQR.V3(0,e*-.5,0),l=new SQR.V3(0,.5*e,0)):(u=new SQR.V3(e*-.5,0,0),l=new SQR.V3(.5*e,0,0))),t.push(v),o.push(d),i.push(S),s.push(h),n.insideFaces&&(v._inside=v.clone(),d._inside=d.clone())}for(var m=0;a>m;m++){var p=t[m],w=o[m],b=i[m],g=s[m],V=(m+1)%a,y=t[V],P=o[V],x=i[V],N=s[V];if(n.heightSegments=n.heightSegments||n.hs||0,n.heightSegments)for(var T=(new SQR.V3).sub(w,p),M=(new SQR.V3).sub(P,y),B=(new SQR.V3).copyFrom(p),I=(new SQR.V3).copyFrom(y),U=new SQR.V3,_=new SQR.V3,V=n.heightSegments,z=0;V+1>z;z++)U.copyFrom(T).mul(1/V*z).add(p,U),_.copyFrom(M).mul(1/V*z).add(y,_),c(B.clone(),U.clone(),I.clone(),_.clone(),b,g,x,N),B.copyFrom(U),I.copyFrom(_);else c(p,w,y,P,b,g,x,N),n.noCaps&&n.insideFaces&&c(p._inside,y._inside,w._inside,P._inside,b,g,x,N);n.noCaps||(c(p,y,u,null,g,N,x),c(P,w,l,null,N,g,x))}var v,F=n.layout||{aPosition:3,aNormal:3,aUV:2},k=SQR.Buffer().layout(F,6*f.length),C=0;return f.forEach(function(e){C+=e.calculateNormal().toBuffer(k,C)}),k},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var r,a,n,t,o,i,s,u=[],l=[];e.setPaths=function(o,i,s,u){return r=o,a=o.length,n=i,t=s||10,f(u),e},e.makeCaps=function(){return e};var f=function(r){u.length=0,l.length=0,r=r||SQR.v3n3();for(var n=0;t>n;n++)for(var o=0;a>o;o++){var i=new SQR.V3;u.push(i)}for(var n=0;t-1>n;n++)for(var o=0;a>o;o++){var s=n*a+o,f=a-1>o?s+1:n*a,c=(n+1)*a+o,m=a-1>o?c+1:(n+1)*a,v=(new SQR.Face).setPosition(u[s],u[m],u[f]),d=(new SQR.Face).setPosition(u[s],u[c],u[m]);l.push(v,d)}e.buffer.layout(r,3*l.length)},c=function(s){for(var f=0;t>f;f++)for(var c=f/(t-1),m=i+c*o,v=n.matrixAt(m),d=0;a>d;d++){var S=u[f*a+d];S.copyFrom(r[d]),s&&s(c,S),v.transformVector(S)}for(var h=0,f=0,Q=l.length;Q>f;f++)h+=l[f].calculateNormal().toBuffer(e.buffer,h,!1,!0)};return e.update=function(r,a,n){return i=r||0,s=a||1,o=s-i,c(n),e.buffer.update(),e},e},SQR.Face=function(){var e,r={},a=!1,n="aPosition",t="aNormal",o="aUV";return r.setPosition=r.v=function(e,a,n,t){return r.a=e||new SQR.V3,r.b=a||new SQR.V3,r.c=n||new SQR.V3,r.d=t,r},r.setIndex=r.i=function(n,t,o,i,s){return a=!0,r.ia=t,r.ib=o,r.ic=i,r.id=s,e=n,r},r.flip=function(){var e=r.b;r.b=r.c,r.c=e},r.setNormal=r.n=function(e){return r.normal=e,r},r.setUV=r.uv=function(e,a,n,t){return r.uva=e,r.uvb=a,r.uvc=n,r.uvd=t,r},r.setColor=r.cl=function(e,a,n,t){return r.ca=e,r.cb=a,r.cc=n,r.cd=t,r},r.calculateNormal=r.cn=function(){var n=SQR.V3.__tv1,t=SQR.V3.__tv2;return r.normal=new SQR.V3,a?(n.sub(e[r.ia],e[r.ib]),n.isZero()&&n.sub(e[r.ia],e[r.id]),t.sub(e[r.ic],e[r.ia])):(n.sub(r.a,r.b),n.isZero()&&n.sub(r.a,r.d),t.sub(r.c,r.a)),r.normal.cross(n,t),r},r.addNormalToVertices=function(){var n=a?e[r.ia]:r.a,t=a?e[r.ib]:r.b,o=a?e[r.ic]:r.c,i=a?e[r.id]:r.d;return n.addNormal(r.normal),t.addNormal(r.normal),o.addNormal(r.normal),i&&i.addNormal(r.normal),r},r.toBuffer=function(e,a,i,s){var u=a;if(e.attributes[n]&&(e.set(n,u+0,r.a).set(n,u+1,r.b).set(n,u+2,r.c),r.d&&e.set(n,u+3,r.c).set(n,u+4,r.b).set(n,u+5,r.d)),e.attributes[t]&&(r.normal||i)){var l=i,f=r.normal;s&&!l&&r.normal.norm(),e.set(t,u+0,l?r.a.normal:f).set(t,u+1,l?r.b.normal:f).set(t,u+2,l?r.c.normal:f),r.d&&e.set(t,u+3,l?r.c.normal:f).set(t,u+4,l?r.b.normal:f).set(t,u+5,l?r.d.normal:f)}return e.attributes[o]&&r.uva&&(e.set(o,u+0,r.uva).set(o,u+1,r.uvb).set(o,u+2,r.uvc),r.d&&e.set(o,u+3,r.uvc).set(o,u+4,r.uvb).set(o,u+5,r.uvd)),r.d?6:3},r},SQR.Primitives.createIcosphere=function(e,r,a){var n=[],t=[],o=[],i=0;a=a||{};var s=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],u=new SQR.V3,l=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var r,a;return u.copyFrom(e),u.norm(),r=1-(.5+Math.atan2(u.z,u.x)/SQR.TWOPI),a=1-(.5-Math.asin(u.y)/Math.PI),new SQR.V2(r,a)}),f=function(e,r,a,t,o,i){var s=l(e),u=l(r),f=l(a),c=(new SQR.Face).setPosition(e,r,a).setUV(s,u,f).setColor(t,o,i);n.push(c)},c=function(r,a){for(var n=t.length,o=0;n>o;o++){var i=t[o],s=i.__v1==r&&i.__v2==a,u=i.__v2==r&&i.__v1==a;if(s||u)return i}var l=new SQR.V3;return l.sub(r,a).mul(.5).add(l,a).norm().mul(e),l.__v1=r,l.__v2=a,t.push(l),l.normal=l.clone(),l},m=function(){o[i]={};var e=o[i];e.faces=n,e.vectors=t,n=[];for(var r=e.faces.length,a=0;r>a;a++){var u=e.faces[a],l=c(u.a,u.b),m=c(u.a,u.c),v=c(u.b,u.c),d=s[i+1];f(u.a,l,m,u.ca,d,d),f(u.b,v,l,u.cb,d,d),f(u.c,m,v,u.cc,d,d),f(l,v,m,d,d,d)}i++},v=e,d=.5*(1+Math.sqrt(5))*v,S=function(r,n,o){var i=new SQR.V3(r,n,o).norm();i.normal=i.clone(),a.reverseNormals&&i.normal.neg(),i.mul(e),t.push(i)},h=function(e,r,a){var n=s[0];f(t[e],t[a],t[r],n,n,n)};for(S(-v,d,0),S(v,d,0),S(-v,-d,0),S(v,-d,0),S(0,-v,d),S(0,v,d),S(0,-v,-d),S(0,v,-d),S(d,0,-v),S(d,0,v),S(-d,0,-v),S(-d,0,v),h(0,11,5),h(0,5,1),h(0,1,7),h(0,7,10),h(0,10,11),h(1,5,9),h(5,11,4),h(11,10,2),h(10,7,6),h(7,1,8),h(3,9,4),h(3,4,2),h(3,2,6),h(3,6,8),h(3,8,9),h(4,9,5),h(2,4,11),h(6,2,10),h(8,6,7),h(9,8,1);r-->0;)m();var d,Q=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*n.length),R=0;return n.forEach(function(e){a.flatShading&&e.calculateNormal(),R+=e.toBuffer(Q,R,!a.flatShading)}),Q},SQR.Mesh={fromJSON:function(e,r,a){var n;if(a=a||{},r)n=e[r];else if(e.vertices)n=e;else for(var t in e){n=e[t];break}if(!n)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var o={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},i=function(e){var r=n[e]||n[o[e]];return r&&r.length>0?r:null},s=a.layout||e.layout||SQR.v3n3u2(),u=a.vertexSize||s.aPosition,l=(n.vertices||n.aPosition).length/u,f=SQR.Buffer().layout(s,l);for(var c in s)if("aNormal"!=c||!a.skipNormals){var t=i(c);t&&f.data(c,t)}var m=i("indices");return m&&f.index(m),f.update()},calculateNormals:function(e){var r=e.getIndexArray(),a=e.getDataArray(),n=(new SQR.Face).setPosition(new SQR.V3,new SQR.V3,new SQR.V3);n.a.normal=new SQR.V3,n.b.normal=new SQR.V3,n.c.normal=new SQR.V3;for(var t=new SQR.V3,o=0;o<e.indexSize;o+=3){var i=r[o+0]*e.strideSize,s=r[o+1]*e.strideSize,u=r[o+2]*e.strideSize;n.a.set(a[i+0],a[i+1],a[i+2]),n.b.set(a[s+0],a[s+1],a[s+2]),n.c.set(a[u+0],a[u+1],a[u+2]),n.a.normal.set(a[i+3],a[i+4],a[i+5]),n.b.normal.set(a[s+3],a[s+4],a[s+5]),n.c.normal.set(a[u+3],a[u+4],a[u+5]),n.calculateNormal(),n.normal.norm(),n.addNormalToVertices(),a[i+3]=n.a.normal.x,a[i+4]=n.a.normal.y,a[i+5]=n.a.normal.z,a[s+3]=n.b.normal.x,a[s+4]=n.b.normal.y,a[s+5]=n.b.normal.z,a[u+3]=n.c.normal.x,a[u+4]=n.c.normal.y,a[u+5]=n.c.normal.z}e.iterate("aNormal",function(e,r){t.set(r[e+0],r[e+1],r[e+2]).norm(),r[e+0]=t.x,r[e+1]=t.y,r[e+2]=t.z}),e.update()}},SQR.Primitives.create2DQuad=function(e,r,a,n){return SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",e,r+n,e+a,r,e+a,r+n,e+a,r,e,r+n,e,r).data("aUV",0,0,1,1,1,0,1,1,0,0,0,1).update()},SQR.Primitives.createPlane=function(e,r,a,n,t,o,i){var s=[],u=[],l=new SQR.Buffer,i=i||{};l.width=e,l.height=r;var e=.5*e,r=.5*r,t=t||0,o=o||0,a=a||1,n=n||1;s.length=[];var f,c,m=-e+t,v=-r+o,d=l.width/a,S=l.height/n,h=[],Q=[];for(f=0;a+1>f;f++)for(c=0;n+1>c;c++){var R=m+f*d,p=v+c*S,w=f*(n+1)+c;Q[w]=i.perQuadUV?new SQR.V2(f%2,c%2):new SQR.V2(f/a,c/n),h[w]=i.zUp?new SQR.V3(R,p,0):new SQR.V3(R,0,p)}for(f=0;a>f;f++)for(c=0;n>c;c++){var R=m+f*d,p=v+c*S,w=f*(n+1)+c,b=(f+1)*(n+1)+c,g=(new SQR.Face).setIndex(h,w,w+1,b,b+1);s.push(g),u.push(w,w+1,b,b,w+1,b+1)}return layout=i.layout?i.layout:{},layout.aPosition=3,layout.aNormal=3,layout.aUV=2,l.layout(layout,h.length),l.faces=s,l.vertices=h,l.recalculateNormals=function(){return s.forEach(function(e){e.calculateNormal(),e.addNormalToVertices()}),l},l.updateFromFaces=function(){return l.iterate("aPosition",function(e,r,a){var n=h[a];r[e+0]=n.x,r[e+1]=n.y,r[e+2]=n.z}),l.iterate("aNormal",function(e,r,a){var n=h[a];n.normal.norm(),r[e+0]=n.normal.x,r[e+1]=n.normal.y,r[e+2]=n.normal.z}),l.iterate("aUV",function(e,r,a){var n=Q[a];r[e+0]=n.x,r[e+1]=n.y}),l.index(u),l},l.recalculateNormals().updateFromFaces().update()},SQR.Primitives.createPostEffect=function(e,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var a=new SQR.Transform("post-effect");return a.buffer=SQR.fullScreenQuad,a.shader=SQR.Shader(e,r),a},SQR.Primitives.createImage=function(e,r,a,n){if(!a&&!SQR.GLSL)throw"> SQR.Primitives.createImage > sqr-glsl.js package is required to use this feature.";a=a||SQR.GLSL["post/image.glsl"];var t=new SQR.Transform;t.buffer=SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var o=e,i=SQR.Texture(o);return t.shader=SQR.Shader(a,n),t.setImage=function(e){o=e,i.setSource(e).update(),t.shader.use().setUniform("uTexture",i)},t.setImage(o),t.size=function(e,a){var n=-1,i=1,s=1,u=-1,l=o.width,f=o.height,c=l/f*a,m=f/l*e;return"fit"==r?(c>e&&(u=-(m/a),i=m/a),m>a&&(n=-(c/e),s=c/e)):"cover"==r&&(c>e&&(n=-(c/e),s=c/e),m>a&&(u=-(m/a),i=m/a)),t.buffer.data("aPosition",n,i,s,i,s,u,n,i,s,u,n,u).update(),t},t},SQR.SceneParser=function(){var e=function(){return{aPosition:3,aNormal:3,aUV:2,aWeight:4,aIndex:4}},r=function(e,r){r.x=e[0],r.y=e[1],r.z=e[2],r.w&&(r.w=e[3])};return{parse:function(a,n){var t=n.prefix||"",o=a[t+"scene"],i=a[t+"mesh"],s=a[t+"anim"];if(n.context){var u=o.background;n.context.clearColor(u.r,u.g,u.b)}var l=function(){var e;return function(){return e||(e=SQR.Shader(n.shader)),e}}();SQR.flipMatrix=n&&n.flipMatrix?n.flipMatrix:!1;var f={},c={},m=[],v={};for(var d in i){var S=i[d],h=S.boneWeights?e():SQR.v3n3u2(),Q=SQR.Mesh.fromJSON(S,null,{layout:h});f[d]=Q,c[S.name]=Q}for(var R in o.materials){var p=o.materials[R];p.color=SQR.Color().setRGB(p.color.r,p.color.g,p.color.b)}var w,b=new SQR.Transform,g=o.transforms;g.forEach(function(e){var a=new SQR.Transform(e.name,e.uid);if(a.useQuaternion=!0,r(e.position,a.position),r(e.rotation,a.quaternion),a.data=e,e.bones&&m.push(a),e.camera){w=a;var n=o.cameras[e.camera],t=function(){var e=window.innerWidth,r=window.innerHeight,a=e/r;w.projection=(new SQR.ProjectionMatrix).perspective(n.fov,a,n.near,n.far)};window.addEventListener("resize",t),t()}e.mesh&&(a.buffer=f[e.meshId]),e.renderer&&(e.bones||(a.shader=l()),a.uniforms=a.uniforms||{},a.uniforms.uColor=o.materials[e.renderer].color),e.parent?b.findById(e.parent).add(a):b.add(a)}),m.forEach(function(e){var r=e.data.bones,a=[],t=r.length;r.forEach(function(e){a.push(b.findById(e))}),a[0].setAsBoneRoot();var o=[];e.shader=SQR.Shader(n.shader,{directives:[{name:"NUM_BONES",value:t},{name:"BONE_PER_VERTEX",value:4}]}),e.beforeDraw=function(){for(var r=0;t>r;r++)o[r]=a[r].computeBoneMatrix();e.shader.use().setUniform("uBones",o)}});for(var V in s){var y=s[V];v[V]={duration:y.length,transforms:{}};for(var P in y.curves){v[V].transforms[P]={properties:{}};for(var x in y.curves[P]){var N=[],T=y.curves[P][x];if(n.linearAnimation)for(var M=0;M<T.keys.length;M+=4){var B=T.keys[M+0],Q=T.keys[M+1];N.push(new SQR.V2(B,Q))}else for(var M=0;M<T.keys.length-4;M+=4){var I=T.keys[M+0],U=T.keys[M+1],_=T.keys[M+3],z=T.keys[M+4],F=T.keys[M+5],k=T.keys[M+6],C=new SQR.V2(I,U),E=new SQR.V2(z,F),L=(E.x-C.x)/3,D=new SQR.V2(L,L*_).add(C),O=new SQR.V2(-L,-L*k).add(E);N.push(new SQR.Bezier(C,D,O,E))}v[V].transforms[P].properties[x]=N}}}return b.recurse(function(e){if(e.data&&e.data.animationId){var r=e.data.animationId,a=v[r];if(!a)return;e.animation=SQR.Animation(a.duration);for(var t in a.transforms){var o=e.findByPath(t);o.clip=SQR.Clip(a.duration),e.animation.addClip(o.clip);for(var i in a.transforms[t].properties)o.clip.addProperty(i,a.transforms[t].properties[i])}n.autoPlay&&e.animation.play()}},!0),{root:b,camera:w,buffers:c}}}}(),SQR.Primitives.createSphere=function(e,r,a,n){var t=[],o=[],i=[];n=n||{};var s,u,e=e||50,l=Math.max(3,Math.floor(r)||8),f=Math.max(3,Math.floor(a)||6),c=0,m=2*Math.PI,v=0,d=Math.PI;for(u=0;f>=u;u++)for(s=0;l>=s;s++){var S=s/l,h=u/f,Q=-e*Math.cos(c+S*m)*Math.sin(v+h*d),R=e*Math.cos(v+h*d),p=e*Math.sin(c+S*m)*Math.sin(v+h*d);t.push(new SQR.V3(Q,R,p)),o.push(new SQR.V2(S,1-h))}for(u=0;f>u;u++)for(s=0;l>s;s++){var w,b=l+1,g=t[u*b+s+0],V=t[u*b+s+1],y=t[(u+1)*b+s+1],P=t[(u+1)*b+s+0],x=o[u*b+s+0],N=o[u*b+s+1],T=o[(u+1)*b+s+1],M=o[(u+1)*b+s+0];w=n.reverseNormals?(new SQR.Face).setPosition(V,g,y,P).setUV(N,x,T,M):(new SQR.Face).setPosition(g,V,P,y).setUV(x,N,M,T),n.flatShading?w.calculateNormal():(g.normal=g.clone().norm(),V.normal=V.clone().norm(),y.normal=y.clone().norm(),P.normal=P.clone().norm(),n.reverseNormals&&(g.normal.neg(),V.normal.neg(),y.normal.neg(),P.normal.neg())),i.push(w)}var B=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},6*i.length),I=0;return i.forEach(function(e){I+=e.toBuffer(B,I,!n.flatShading)}),B.update()};