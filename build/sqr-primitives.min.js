SQR.Primitives.createCube=function(e,r,a,t){e=e||1,r=r||1,a=a||1,t=t||{};var o=new SQR.Mesh,n=o.V(e*-.5,.5*r,.5*a),i=o.V(.5*e,.5*r,.5*a),s=o.V(e*-.5,r*-.5,.5*a),l=o.V(.5*e,r*-.5,.5*a),c=o.V(e*-.5,.5*r,a*-.5),u=o.V(.5*e,.5*r,a*-.5),f=o.V(e*-.5,r*-.5,a*-.5),v=o.V(.5*e,r*-.5,a*-.5),p=o.T(0,1),d=o.T(1,1),m=o.T(0,0),h=o.T(1,0);return o.F(n,i,s,l).T(p,d,m,h),o.F(u,c,v,f).T(p,d,m,h),o.F(c,n,f,s).T(p,d,m,h),o.F(i,u,l,v).T(p,d,m,h),o.F(c,u,n,i).T(p,d,m,h),o.F(s,l,f,v).T(p,d,m,h),o.calculateNormals(t.smooth),t.flip&&o.flip(),o.update()},SQR.Primitives.createCylinder=function(e,r,a,t){t=t||{};var o,n,i,s,l,c,u=[],f=function(e,r,a,t,o,n,i,s){var l=(new SQR.Face).setPosition(e,r,a,t).setUV(o,n,i,s);u.push(l)};o=[],n=[],i=[],s=[];for(var v=0;a>v;v++){var p=new SQR.V3,d=new SQR.V3,m=new SQR.V2,h=new SQR.V2,S=Math.cos(v/a*SQR.TWOPI)*r,Q=Math.sin(v/a*SQR.TWOPI)*r;t.vertical?(p.set(Q,e*-.5,S),d.set(Q,.5*e,S)):(p.set(e*-.5,S,Q),d.set(.5*e,S,Q)),m.set(v/a,0),h.set(v/a,1),t.noCaps||(t.vertical?(l=new SQR.V3(0,e*-.5,0),c=new SQR.V3(0,.5*e,0)):(l=new SQR.V3(e*-.5,0,0),c=new SQR.V3(.5*e,0,0))),o.push(p),n.push(d),i.push(m),s.push(h),t.insideFaces&&(p._inside=p.clone(),d._inside=d.clone())}for(var v=0;a>v;v++){var R=o[v],y=n[v],V=i[v],g=s[v],b=(v+1)%a,w=o[b],F=n[b],P=i[b],x=s[b];if(t.heightSegments=t.heightSegments||t.hs||0,t.heightSegments)for(var M=(new SQR.V3).sub(y,R),T=(new SQR.V3).sub(F,w),N=(new SQR.V3).copyFrom(R),_=(new SQR.V3).copyFrom(w),U=new SQR.V3,B=new SQR.V3,b=t.heightSegments,C=0;b+1>C;C++)U.copyFrom(M).mul(1/b*C).add(R,U),B.copyFrom(T).mul(1/b*C).add(w,B),f(N.clone(),U.clone(),_.clone(),B.clone(),V,g,P,x),N.copyFrom(U),_.copyFrom(B);else f(R,y,w,F,V,g,P,x),t.noCaps&&t.insideFaces&&f(R._inside,w._inside,y._inside,F._inside,V,g,P,x);t.noCaps||(f(R,w,l,null,g,x,P),f(F,y,c,null,x,g,P))}var p,I=t.layout||{aPosition:3,aNormal:3,aUV:2},z=SQR.Buffer().layout(I,6*u.length),k=0;return u.forEach(function(e){k+=e.calculateNormal().toBuffer(z,k)}),z},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var r,a,t,o,n,i,s,l=[],c=[];e.setPaths=function(n,i,s,l){return r=n,a=n.length,t=i,o=s||10,u(l),e},e.makeCaps=function(){return e};var u=function(r){l.length=0,c.length=0,r=r||SQR.v3n3();for(var t=0;o>t;t++)for(var n=0;a>n;n++){var i=new SQR.V3;l.push(i)}for(var t=0;o-1>t;t++)for(var n=0;a>n;n++){var s=t*a+n,u=a-1>n?s+1:t*a,f=(t+1)*a+n,v=a-1>n?f+1:(t+1)*a,p=(new SQR.Face).setPosition(l[s],l[v],l[u]),d=(new SQR.Face).setPosition(l[s],l[f],l[v]);c.push(p,d)}e.buffer.layout(r,3*c.length)},f=function(s,u){for(var f=0;o>f;f++)for(var v=f/(o-1),p=i+v*n,d=t.matrixAt(p),m=0;a>m;m++){var h=l[f*a+m];h.copyFrom(r[m]),s&&s(v,h,e),d.transformVector(h),u&&u(v,h,e)}for(var S=0,f=0,Q=c.length;Q>f;f++)S+=c[f].calculateNormal().toBuffer(e.buffer,S,!1,!0)};return e.update=function(r,a,t,o){return i=r||0,s=a||1,n=s-i,f(t,o),e.buffer.update(),e},e},SQR.Face=function(){return this instanceof SQR.Face?void 0:new SQR.Face},SQR.Face.prototype.setPosition=function(e,r,a,t){var o=this;return o.a=e||new SQR.V3,o.b=r||new SQR.V3,o.c=a||new SQR.V3,o.d=t,o},SQR.Face.prototype.setIndex=function(e,r,a,t,o){var n=this;return n.indexed=!0,n.ia=r,n.ib=a,n.ic=t,n.id=o,n.vertexArray=e,n},SQR.Face.prototype.flip=function(){var e=this,r=e.b;e.b=e.c,e.c=r},SQR.Face.prototype.setNormal=function(e){return this.normal=e,this},SQR.Face.prototype.setUV=function(e,r,a,t){var o=this;return o.uva=e,o.uvb=r,o.uvc=a,o.uvd=t,o},SQR.Face.prototype.setColor=function(e,r,a,t){var o=this;return o.ca=e,o.cb=r,o.cc=a,o.cd=t,o},SQR.Face.prototype.calculateNormal=function(){var e=this,r=SQR.V3.__tv1,a=SQR.V3.__tv2,t=e.vertexArray;return e.normal=e.normal||new SQR.V3,e.indexed?(r.sub(t[e.ia],t[e.ib]),r.isZero()&&r.sub(t[e.ia],t[e.id]),a.sub(t[e.ic],t[e.ia])):(r.sub(e.a,e.b),r.isZero()&&r.sub(e.a,e.d),a.sub(e.c,e.a)),e.normal.cross(r,a),e},SQR.Face.prototype.v=SQR.Face.prototype.setPosition,SQR.Face.prototype.i=SQR.Face.prototype.setIndex,SQR.Face.prototype.n=SQR.Face.prototype.setNormal,SQR.Face.prototype.uv=SQR.Face.prototype.setUV,SQR.Face.prototype.cl=SQR.Face.prototype.setColor,SQR.Face.prototype.cn=SQR.Face.prototype.calculateNormal,SQR.Face.prototype.addNormalToVertices=function(){var e=this,r=e.vertexArray,a=e.indexed?r[e.ia]:e.a,t=e.indexed?r[e.ib]:e.b,o=e.indexed?r[e.ic]:e.c,n=e.indexed?r[e.id]:e.d;return a.addNormal(e.normal),t.addNormal(e.normal),o.addNormal(e.normal),n&&n.addNormal(e.normal),e},SQR.Face.prototype.toBuffer=function(e,r,a,t){var o=this,n="aPosition",i="aNormal",s="aUV",l=r;if(e.attributes[n]&&(e.set(n,l+0,o.a).set(n,l+1,o.b).set(n,l+2,o.c),o.d&&e.set(n,l+3,o.c).set(n,l+4,o.b).set(n,l+5,o.d)),e.attributes[i]&&(o.normal||a)){var c=a,u=o.normal;t&&!c&&o.normal.norm(),e.set(i,l+0,c?o.a.normal:u).set(i,l+1,c?o.b.normal:u).set(i,l+2,c?o.c.normal:u),o.d&&e.set(i,l+3,c?o.c.normal:u).set(i,l+4,c?o.b.normal:u).set(i,l+5,c?o.d.normal:u)}return e.attributes[s]&&o.uva&&(e.set(s,l+0,o.uva).set(s,l+1,o.uvb).set(s,l+2,o.uvc),o.d&&e.set(s,l+3,o.uvc).set(s,l+4,o.uvb).set(s,l+5,o.uvd)),o.d?6:3},SQR.Primitives.createIcosphere=function(e,r,a){var t=[],o=[],n=[],i=0;a=a||{};var s=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],l=new SQR.V3,c=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var r,a;return l.copyFrom(e),l.norm(),r=1-(.5+Math.atan2(l.z,l.x)/SQR.TWOPI),a=1-(.5-Math.asin(l.y)/Math.PI),new SQR.V2(r,a)}),u=function(e,r,a,o,n,i){var s=c(e),l=c(r),u=c(a),f=(new SQR.Face).setPosition(e,r,a).setUV(s,l,u).setColor(o,n,i);t.push(f)},f=function(r,a){for(var t=o.length,n=0;t>n;n++){var i=o[n],s=i.__v1==r&&i.__v2==a,l=i.__v2==r&&i.__v1==a;if(s||l)return i}var c=new SQR.V3;return c.sub(r,a).mul(.5).add(c,a).norm().mul(e),c.__v1=r,c.__v2=a,o.push(c),c.normal=c.clone(),c},v=function(){n[i]={};var e=n[i];e.faces=t,e.vectors=o,t=[];for(var r=e.faces.length,a=0;r>a;a++){var l=e.faces[a],c=f(l.a,l.b),v=f(l.a,l.c),p=f(l.b,l.c),d=s[i+1];u(l.a,c,v,l.ca,d,d),u(l.b,p,c,l.cb,d,d),u(l.c,v,p,l.cc,d,d),u(c,p,v,d,d,d)}i++},p=e,d=.5*(1+Math.sqrt(5))*p,m=function(r,t,n){var i=new SQR.V3(r,t,n).norm();i.normal=i.clone(),a.reverseNormals&&i.normal.neg(),i.mul(e),o.push(i)},h=function(e,r,a){var t=s[0];u(o[e],o[a],o[r],t,t,t)};for(m(-p,d,0),m(p,d,0),m(-p,-d,0),m(p,-d,0),m(0,-p,d),m(0,p,d),m(0,-p,-d),m(0,p,-d),m(d,0,-p),m(d,0,p),m(-d,0,-p),m(-d,0,p),h(0,11,5),h(0,5,1),h(0,1,7),h(0,7,10),h(0,10,11),h(1,5,9),h(5,11,4),h(11,10,2),h(10,7,6),h(7,1,8),h(3,9,4),h(3,4,2),h(3,2,6),h(3,6,8),h(3,8,9),h(4,9,5),h(2,4,11),h(6,2,10),h(8,6,7),h(9,8,1);r-->0;)v();var d,S=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*t.length),Q=0;return t.forEach(function(e){a.flatShading&&e.calculateNormal(),Q+=e.toBuffer(S,Q,!a.flatShading)}),S},SQR.Mesh=function(){if(!(this instanceof SQR.Mesh))return new SQR.Mesh;var e=this;e.polys=[],e.vertices=[],e.uvs=[],e.size=0,e.addVertex=function(r,a,t){var o=new SQR.Vertex(r,a,t);return e.vertices.push(o),e.vertices.length-1},e.addUV=function(r,a){var a=new SQR.V2(r,a);return e.uvs.push(a),e.uvs.length-1},e.addFace=function(){var r=new SQR.Poly(e);return r.V.apply(r,arguments),e.polys.push(r),e.size+=r.triangles.length,r},e.calculateNormals=function(r){e.smooth=r;for(var a=0,t=e.polys.length;t>a;a++)e.polys[a].calculateNormal();if(e.smooth)for(var a=0,t=e.vertices.length;t>a;a++)e.vertices[a].polys&&e.vertices[a].calculateNormal();return e},e.flip=function(){for(var r=0,a=e.polys.length;a>r;r++)e.polys[r].flip();return e},e.calculateTangents=function(){console.log("SQR.Mesh.calculateTangents is not implemented yet!")};var r=function(){var r=e.polys[0],a=e.size,t={aPosition:3};return r.normal&&(t.aNormal=3),r.uvs.length>0&&(t.aUV=2),e.buffer=SQR.Buffer().layout(t,a),e.buffer};e.update=function(){if(0==e.polys.length)return void console.warn("> SQR.Mesh.update > no polys found to create buffer from.");for(var a=e.buffer||r(),t=a.attributes.aPosition,o=0,n=[],i=0,s=e.polys.length;s>i;i++)for(var l=e.polys[i],c=0,u=l.triangles.length;u>c;c++){var f=l.triangles[c],v=e.vertices[l.vertices[f]],t=v.position,p=e.smooth?v.normal:l.normal,d=e.uvs[l.uvs[f]];n.length=0,n.push(t.x,t.y,t.z,p.x,p.y,p.z,d.x,d.y),a.set(null,o,n),o++}return a.update(),a.mesh||(a.mesh=e),a},e.V=e.addVertex,e.F=e.addFace,e.T=e.addUV},SQR.Mesh.fromJSON=function(e,r,a){var t;if(a=a||{},r)t=e[r];else if(e.vertices)t=e;else for(var o in e){t=e[o];break}if(!t)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var n={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},i=function(e){var r=t[e]||t[n[e]];return r&&r.length>0?r:0==r.length&&"aUV2"==e?i("aUV"):null},s=a.layout||e.layout||SQR.v3n3u2(),l=a.vertexSize||s.aPosition,c=(t.vertices||t.aPosition).length/l,u=SQR.Buffer().layout(s,c);for(var f in s){var o=i(f);o&&u.data(f,o)}var v=i("indices");return v&&u.index(v),u.update()},SQR.Primitives.createPlane=function(e,r,a,t,o,n,i){var s,l,i=i||{},e=.5*e,r=.5*r,o=o||0,n=n||0,a=a||1,t=t||1,c=-e+o,u=-r+n,f=2*e/a,v=2*r/t,p=new SQR.Mesh;for(s=0;a+1>s;s++)for(l=0;t+1>l;l++){var d=c+s*f,m=u+l*v;i.zUp?p.V(d,m,0):p.V(d,0,m),p.T(s/a,l/t)}for(s=0;a>s;s++)for(l=0;t>l;l++){var d=c+s*f,m=u+l*v,h=(s+0)*(t+1)+l,S=(s+1)*(t+1)+l;p.F(h,h+1,S,S+1).T(h,h+1,S,S+1)}return p.calculateNormals(i.smooth),i.flip&&p.flip(),p.update()},SQR.Poly=function(e){var r=this;r.mesh=e,r.triangles=[]},SQR.Poly.prototype.addVertices=function(){var e=this;if(e.size=arguments.length,e.size<3)throw"> SQR.Poly.addVertices > A poly needs at least 3 vertices.";e.vertices=[];for(var r=0;r<e.size;r++){var a=arguments[r];e.mesh.vertices[a].addPoly(e),e.vertices.push(a)}return e.size>=3&&e.triangles.push(0,1,2),e.size>=4&&e.triangles.push(2,1,3),e},SQR.Poly.prototype.addUV=function(e,r,a,t){var o=this;return o.uvs=[e,r,a],t&&o.uvs.push(t),o},SQR.Poly.prototype.flip=function(){var e=this,r=this.vertices,a=r[1];r[1]=r[2],r[2]=a,r.normal?r.normal.neg():e.normal?e.normal.neg():console.log("> SQR.Poly.flip > please consider calculating normal first, then flipping")},SQR.Poly.prototype.calculateNormal=function(){var e=this,r=this.vertices,a=e.mesh.vertices,t=SQR.V3.__tv1,o=SQR.V3.__tv2;return e.normal=e.normal||new SQR.V3,t.sub(a[r[0]].position,a[r[1]].position),t.isZero()&&e.size>3&&t.sub(a[r[0]].position,a[r[3]].position),o.sub(a[r[2]].position,a[r[0]].position),e.normal.cross(t,o).norm(),e},SQR.Poly.prototype.V=SQR.Poly.prototype.addVertices,SQR.Poly.prototype.T=SQR.Poly.prototype.addUV,SQR.Primitives.createPostEffect=function(e,r){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var a=new SQR.Transform("post-effect");return a.buffer=SQR.fullScreenQuad,a.shader=SQR.Shader(e,r),a},SQR.SceneParser=function(){var e=function(e,r){r.x=e[0],r.y=e[1],r.z=e[2],r.w&&(r.w=e[3])};return{parse:function(r,a){a=a||{};var t=a.prefix||"",o=r[t+"scene"],n=r[t+"mesh"],i=r[t+"anim"];if(a.context){var s=o.background;a.context.clearColor(s.r,s.g,s.b)}var l=function(){var e;return function(){return e||(e=a.shader.setUniform?a.shader:SQR.Shader(a.shader)),e}}();SQR.flipMatrix=a&&a.flipMatrix?a.flipMatrix:!1;var c={},u={},f=[],v={};for(var p in n){var d=n[p],m=SQR.v3n3u2();d.boneWeights&&(m.aWeight=4,m.aIndex=4),d.uv2&&(m.aUV2=2);var h=SQR.Mesh.fromJSON(d,null,{layout:m});c[p]=h,u[d.name]=h}for(var S in o.materials){var Q=o.materials[S];Q.color=SQR.Color().setRGB(Q.color.r,Q.color.g,Q.color.b)}var R,y=new SQR.Transform,V=o.transforms;V.forEach(function(r){var a=new SQR.Transform(r.name,r.uid);if(a.useQuaternion=!0,e(r.position,a.position),e(r.rotation,a.quaternion),r.scale&&e(r.scale,a.scale),a.data=r,r.bones&&f.push(a),r.camera){R=a;var t=o.cameras[r.camera],n=window.innerWidth,i=window.innerHeight,s=n/i;R.projection=(new SQR.ProjectionMatrix).perspective(t.fov,s,t.near,t.far)}if(r.lightmapTileOffset&&(a.uniforms=a.uniforms||{},a.uniforms.uLightmapTileOffset=r.lightmapTileOffset),r.mesh&&(a.buffer=c[r.meshId]),r.collider){var u;switch(r.collider.type){case"sphere":u=SQR.Collider.Sphere(),u.radius=r.collider.radius,e(r.collider.center,u.center);break;case"box":u=SQR.Collider.Box();var v=r.collider.center,p=r.collider.size;u.box={maxX:v[0]+p[0]/2,minX:v[0]-p[0]/2,maxY:v[1]+p[1]/2,minY:v[1]-p[1]/2,maxZ:v[2]+p[2]/2,minZ:v[2]-p[2]/2};break;case"mesh":u=SQR.Collider.Mesh(c[r.meshId])}a.collider=u}r.renderer&&(r.bones||(a.shader=l()),a.uniforms=a.uniforms||{},a.uniforms.uColor=o.materials[r.renderer].color),r.parent?y.findById(r.parent).add(a):y.add(a)}),f.forEach(function(e){var r=e.data.bones,t=[],o=r.length;r.forEach(function(e){t.push(y.findById(e))}),t[0].setAsBoneRoot();var n=[];e.shader=SQR.Shader(a.shader,{directives:[{name:"NUM_BONES",value:o},{name:"BONE_PER_VERTEX",value:4}]}),e.beforeDraw=function(){for(var r=0;o>r;r++)n[r]=t[r].computeBoneMatrix();e.shader.use().setUniform("uBones",n)}});for(var g in i){var b=i[g];v[g]={duration:b.length,transforms:{}};for(var w in b.curves){v[g].transforms[w]={properties:{}};for(var F in b.curves[w]){var P=[],x=b.curves[w][F];if(a.linearAnimation)for(var M=0;M<x.keys.length;M+=4){var T=x.keys[M+0],h=x.keys[M+1];P.push(new SQR.V2(T,h))}else for(var M=0;M<x.keys.length-4;M+=4){var N=x.keys[M+0],_=x.keys[M+1],U=x.keys[M+3],B=x.keys[M+4],C=x.keys[M+5],I=x.keys[M+6],z=new SQR.V2(N,_),k=new SQR.V2(B,C),E=(k.x-z.x)/3,O=new SQR.V2(E,E*U).add(z),A=new SQR.V2(-E,-E*I).add(k);P.push(new SQR.Bezier(z,O,A,k))}v[g].transforms[w].properties[F]=P}}}return y.recurse(function(e){if(e.data&&e.data.animationId){var r=e.data.animationId,t=v[r];if(!t)return;e.animation=SQR.Animation(t.duration);for(var o in t.transforms){var n=e.findByPath(o);n.clip=SQR.Clip(t.duration),e.animation.addClip(n.clip);for(var i in t.transforms[o].properties)n.clip.addProperty(i,t.transforms[o].properties[i])}a.autoPlay&&e.animation.play()}},!0),{root:y,camera:R,buffers:u}}}}(),SQR.Primitives.createSphere=function(e,r,a,t){var o=new SQR.Mesh;e=e||50,r=Math.max(3,Math.floor(r)||8),a=Math.max(3,Math.floor(a)||6),t=t||{};var n,i,s=2*Math.PI,l=Math.PI;for(i=1;a-1>=i;i++)for(n=0;r>n;n++){{var c=n/r,u=i/a,f=-e*Math.cos(c*s)*Math.sin(u*l),v=e*Math.cos(u*l),p=e*Math.sin(c*s)*Math.sin(u*l);o.V(f,v,p)}o.T(c,1-u)}var d=o.V(0,e,0),m=o.V(0,-e,0);for(o.T(1,1),o.T(0,0),i=0;a>i;i++){var h=0==i,S=i==a-1;for(n=0;r>n;n++){var Q=i,R=i+1,y=n,V=(n+1)%r,g=Q*r+y-r;h&&(g=d);var b=Q*r+V-r;h&&(b=d);var w=R*r+y-r;S&&(w=m);var F=R*r+V-r;S&&(F=m),h?o.F(g,F,w).T(g,F,w):S?o.F(g,b,F).T(g,b,F):o.F(g,b,w,F).T(g,b,w,F)}}return o.calculateNormals(t.smooth),t.flip&&o.flip(),o.update()},SQR.Vertex=function(e,r,a){var t=this;t.position=new SQR.V3(e,r,a),t.normal=new SQR.V3},SQR.Vertex.prototype.addPoly=function(e){var r=this;r.polys=r.polys||[],r.polys.push(e)},SQR.Vertex.prototype.calculateNormal=function(){var e=this;e.normal.set();for(var r=0,a=e.polys.length;a>r;r++)e.normal.add(e.polys[r].normal);e.normal.norm()};