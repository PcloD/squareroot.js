SQR.Primitives.createPoint=function(e,a){return SQR.Buffer().layout(SQR.v2(),1).setMode(SQR.gl.POINTS).data("aPosition",e||0,a||0).update()},SQR.Primitives.createCube=function(e,a,r,t){e=e||1,a=a||1,r=r||1;var n=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},36),o=new SQR.V3(e*-.5,.5*a,.5*r),s=new SQR.V3(.5*e,.5*a,.5*r),i=new SQR.V3(e*-.5,a*-.5,.5*r),u=new SQR.V3(.5*e,a*-.5,.5*r),l=new SQR.V3(e*-.5,.5*a,r*-.5),c=new SQR.V3(.5*e,.5*a,r*-.5),f=new SQR.V3(e*-.5,a*-.5,r*-.5),S=new SQR.V3(.5*e,a*-.5,r*-.5),m=new SQR.V2(0,1),v=new SQR.V2(1,1),Q=new SQR.V2(0,0),R=new SQR.V2(1,0),d=[];d.push(SQR.Face().setPosition(o,s,i,u).setUV(m,v,Q,R)),d.push(SQR.Face().setPosition(c,l,S,f).setUV(m,v,Q,R)),d.push(SQR.Face().setPosition(l,o,f,i).setUV(m,v,Q,R)),d.push(SQR.Face().setPosition(s,c,u,S).setUV(m,v,Q,R)),d.push(SQR.Face().setPosition(l,c,o,s).setUV(m,v,Q,R)),d.push(SQR.Face().setPosition(i,u,f,S).setUV(m,v,Q,R));var h=0;return d.forEach(function(e){t&&t.reverseNormals&&e.flip(),e.calculateNormal(),h+=e.toBuffer(n,h)}),n.update()},SQR.Primitives.createSkybox=function(e){if(e=e||{},e.size=e.size||5,e.useDepth=void 0===e.useDepth?!0:e.useDepth,!e.glsl&&SQR.GLSL&&(e.glsl=e.use2dTextures?SQR.GLSL["shaders/skybox-2d.glsl"]:SQR.GLSL["shaders/skybox-cube.glsl"]),!e.glsl)throw"Missing shader code. Pass GLSL string as 2nd argument or include sqr-glsl.js to use the default one.";var a=new SQR.Transform,r=SQR.Shader(e.glsl);if(e.use2dTextures){var t={zUp:!0},n=e.size,o=function(a,t){var o=new SQR.Transform("front");return o.shader=r,o.useDepth=e.useDepth,o.buffer=SQR.Primitives.createPlane(n,n,1,1,0,0,t),o},s=o("front",t);s.position.z=n*-.5;var i=o("back",t);i.position.z=.5*n,i.rotation.y=Math.PI;var u=o("left",t);u.position.x=n*-.5,u.rotation.y=Math.PI*-.5;var l=o("right",t);l.position.x=.5*n,l.rotation.y=.5*Math.PI;var c=o("up");c.position.y=.5*n;var f=o("down");f.position.y=n*-.5,f.rotation.x=Math.PI,a.add(s,i,u,l,c,f),a.setTexture=function(e){e&&(s.uniforms={uTexture:SQR.Texture(e.front)},i.uniforms={uTexture:SQR.Texture(e.back)},u.uniforms={uTexture:SQR.Texture(e.left)},l.uniforms={uTexture:SQR.Texture(e.right)},c.uniforms={uTexture:SQR.Texture(e.up)},f.uniforms={uTexture:SQR.Texture(e.down)})}}else{var n=e.size;a.buffer=SQR.Primitives.createCube(n,n,n,{reverseNormals:!0}),a.shader=r,a.useDepth=e.useDepth,a.setTexture=function(e){e&&(a.cubemap=SQR.Cubemap(e),a.shader.use().setUniform("uCubemap",a.cubemap))}}return e.faces&&a.setTexture(e.faces),a},SQR.Primitives.createCylinder=function(e,a,r,t){t=t||{};var n,o,s,i,u,l,c=[],f=function(e,a,r,t,n,o,s,i){var u=(new SQR.Face).setPosition(e,a,r,t).setUV(n,o,s,i);c.push(u)};n=[],o=[],s=[],i=[];for(var S=0;r>S;S++){var m=new SQR.V3,v=new SQR.V3,Q=new SQR.V2,R=new SQR.V2,d=Math.cos(S/r*SQR.TWOPI)*a,h=Math.sin(S/r*SQR.TWOPI)*a;t.vertical?(m.set(h,e*-.5,d),v.set(h,.5*e,d)):(m.set(e*-.5,d,h),v.set(.5*e,d,h)),Q.set(S/r,0),R.set(S/r,1),t.noCaps||(t.vertical?(u=new SQR.V3(0,e*-.5,0),l=new SQR.V3(0,.5*e,0)):(u=new SQR.V3(e*-.5,0,0),l=new SQR.V3(.5*e,0,0))),n.push(m),o.push(v),s.push(Q),i.push(R),t.insideFaces&&(m._inside=m.clone(),v._inside=v.clone())}for(var S=0;r>S;S++){var V=n[S],p=o[S],w=s[S],b=i[S],P=(S+1)%r,g=n[P],y=o[P],x=s[P],N=i[P];if(t.heightSegments=t.heightSegments||t.hs||0,t.heightSegments)for(var T=(new SQR.V3).sub(p,V),U=(new SQR.V3).sub(y,g),F=(new SQR.V3).copyFrom(V),M=(new SQR.V3).copyFrom(g),_=new SQR.V3,z=new SQR.V3,P=t.heightSegments,I=0;P+1>I;I++)_.copyFrom(T).mul(1/P*I).add(V,_),z.copyFrom(U).mul(1/P*I).add(g,z),f(F.clone(),_.clone(),M.clone(),z.clone(),w,b,x,N),F.copyFrom(_),M.copyFrom(z);else f(V,p,g,y,w,b,x,N),t.noCaps&&t.insideFaces&&f(V._inside,g._inside,p._inside,y._inside,w,b,x,N);t.noCaps||(f(V,g,u,null,b,N,x),f(y,p,l,null,N,b,x))}var m,B=t.layout||{aPosition:3,aNormal:3,aUV:2},C=SQR.Buffer().layout(B,6*c.length),L=0;return c.forEach(function(e){L+=e.calculateNormal().toBuffer(C,L)}),C},SQR.Extrude=function(){var e={};e.buffer=SQR.Buffer();var a,r,t,n,o,s,i,u=[],l=[];e.setPaths=function(o,s,i,u){return a=o,r=o.length,t=s,n=i||10,c(u),e},e.makeCaps=function(){return e};var c=function(a){u.length=0,l.length=0,a=a||SQR.v3n3();for(var t=0;n>t;t++)for(var o=0;r>o;o++){var s=new SQR.V3;u.push(s)}for(var t=0;n-1>t;t++)for(var o=0;r>o;o++){var i=t*r+o,c=r-1>o?i+1:t*r,f=(t+1)*r+o,S=r-1>o?f+1:(t+1)*r,m=(new SQR.Face).setPosition(u[i],u[S],u[c]),v=(new SQR.Face).setPosition(u[i],u[f],u[S]);l.push(m,v)}e.buffer.layout(a,3*l.length)},f=function(i){for(var c=0;n>c;c++)for(var f=c/(n-1),S=s+f*o,m=t.matrixAt(S),v=0;r>v;v++){var Q=u[c*r+v];Q.copyFrom(a[v]),i&&i(f,Q),m.transformVector(Q)}for(var R=0,c=0,d=l.length;d>c;c++)R+=l[c].calculateNormal().toBuffer(e.buffer,R,!1,!0)};return e.update=function(a,r,t){return s=a||0,i=r||1,o=i-s,f(t),e.buffer.update(),e},e},SQR.Face=function(){var e,a={},r=!1,t="aPosition",n="aNormal",o="aUV";return a.setPosition=function(e,r,t,n){return a.a=e||new SQR.V3,a.b=r||new SQR.V3,a.c=t||new SQR.V3,a.d=n,a},a.setIndex=function(t,n,o,s,i){return r=!0,a.ia=n,a.ib=o,a.ic=s,a.id=i,e=t,a},a.flip=function(){var e=a.b;a.b=a.c,a.c=e},a.setNormal=function(e){return a.normal=e,a},a.setUV=function(e,r,t,n){return a.uva=e,a.uvb=r,a.uvc=t,a.uvd=n,a},a.setColor=function(e,r,t,n){return a.ca=e,a.cb=r,a.cc=t,a.cd=n,a},a.calculateNormal=function(){var t=SQR.V3.__tv1,n=SQR.V3.__tv2;return a.normal=new SQR.V3,r?(t.sub(e[a.ia],e[a.ib]),t.isZero()&&t.sub(e[a.ia],e[a.id]),n.sub(e[a.ic],e[a.ia])):(t.sub(a.a,a.b),t.isZero()&&t.sub(a.a,a.d),n.sub(a.c,a.a)),a.normal.cross(t,n),a},a.addNormalToVertices=function(){var t=r?e[a.ia]:a.a,n=r?e[a.ib]:a.b,o=r?e[a.ic]:a.c,s=r?e[a.id]:a.d;return t.addNormal(a.normal),n.addNormal(a.normal),o.addNormal(a.normal),s&&s.addNormal(a.normal),a},a.toBuffer=function(e,r,s,i){var u=r;if(e.attributes[t]&&(e.set(t,u+0,a.a).set(t,u+1,a.b).set(t,u+2,a.c),a.d&&e.set(t,u+3,a.c).set(t,u+4,a.b).set(t,u+5,a.d)),e.attributes[n]&&(a.normal||s)){var l=s,c=a.normal;i&&!l&&a.normal.norm(),e.set(n,u+0,l?a.a.normal:c).set(n,u+1,l?a.b.normal:c).set(n,u+2,l?a.c.normal:c),a.d&&e.set(n,u+3,l?a.c.normal:c).set(n,u+4,l?a.b.normal:c).set(n,u+5,l?a.d.normal:c)}return e.attributes[o]&&a.uva&&(e.set(o,u+0,a.uva).set(o,u+1,a.uvb).set(o,u+2,a.uvc),a.d&&e.set(o,u+3,a.uvc).set(o,u+4,a.uvb).set(o,u+5,a.uvd)),a.d?6:3},a},SQR.Primitives.createIcosphere=function(e,a,r){var t=[],n=[],o=[],s=0;r=r||{};var i=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],u=new SQR.V3,l=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(e){var a,r;return u.copyFrom(e),u.norm(),a=1-(.5+Math.atan2(u.z,u.x)/SQR.TWOPI),r=1-(.5-Math.asin(u.y)/Math.PI),new SQR.V2(a,r)}),c=function(e,a,r,n,o,s){var i=l(e),u=l(a),c=l(r),f=(new SQR.Face).setPosition(e,a,r).setUV(i,u,c).setColor(n,o,s);t.push(f)},f=function(a,r){for(var t=n.length,o=0;t>o;o++){var s=n[o],i=s.__v1==a&&s.__v2==r,u=s.__v2==a&&s.__v1==r;if(i||u)return s}var l=new SQR.V3;return l.sub(a,r).mul(.5).add(l,r).norm().mul(e),l.__v1=a,l.__v2=r,n.push(l),l.normal=l.clone(),l},S=function(){o[s]={};var e=o[s];e.faces=t,e.vectors=n,t=[];for(var a=e.faces.length,r=0;a>r;r++){var u=e.faces[r],l=f(u.a,u.b),S=f(u.a,u.c),m=f(u.b,u.c),v=i[s+1];c(u.a,l,S,u.ca,v,v),c(u.b,m,l,u.cb,v,v),c(u.c,S,m,u.cc,v,v),c(l,m,S,v,v,v)}s++},m=e,v=.5*(1+Math.sqrt(5))*m,Q=function(a,r,t){var o=new SQR.V3(a,r,t).norm();o.normal=o.clone(),o.mul(e),n.push(o)},R=function(e,a,r){var t=i[0];c(n[e],n[r],n[a],t,t,t)};for(Q(-m,v,0),Q(m,v,0),Q(-m,-v,0),Q(m,-v,0),Q(0,-m,v),Q(0,m,v),Q(0,-m,-v),Q(0,m,-v),Q(v,0,-m),Q(v,0,m),Q(-v,0,-m),Q(-v,0,m),R(0,11,5),R(0,5,1),R(0,1,7),R(0,7,10),R(0,10,11),R(1,5,9),R(5,11,4),R(11,10,2),R(10,7,6),R(7,1,8),R(3,9,4),R(3,4,2),R(3,2,6),R(3,6,8),R(3,8,9),R(4,9,5),R(2,4,11),R(6,2,10),R(8,6,7),R(9,8,1);a-->0;)S();var v,d=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*t.length),h=0;return t.forEach(function(e){r.flatShading&&e.calculateNormal(),h+=e.toBuffer(d,h,!r.flatShading)}),d},SQR.Mesh={fromJSON:function(e,a,r){var t;if(r=r||{},a)t=e[a];else if(e.vertices)t=e;else for(var n in e){t=e[n];break}if(!t)throw"> SQR.Mesh - mesh not found in data (name: "+a+")";var o={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",indices:"tris"},s=function(e){var a=t[e]||t[o[e]];return a&&a.length>0?a:null},i=r.layout||e.layout||SQR.v3n3u2(),u=r.vertexSize||i.aPosition,l=(t.vertices||t.aPosition).length/u,c=SQR.Buffer().layout(i,l);for(var f in i)if("aNormal"!=f||!r.skipNormals){var n=s(f);n&&c.data(f,n)}var S=s("indices");return S&&c.index(S),c.update()},calculateNormals:function(e){var a=e.getIndexArray(),r=e.getDataArray(),t=(new SQR.Face).setPosition(new SQR.V3,new SQR.V3,new SQR.V3);t.a.normal=new SQR.V3,t.b.normal=new SQR.V3,t.c.normal=new SQR.V3;for(var n=new SQR.V3,o=0;o<e.indexSize;o+=3){var s=a[o+0]*e.strideSize,i=a[o+1]*e.strideSize,u=a[o+2]*e.strideSize;t.a.set(r[s+0],r[s+1],r[s+2]),t.b.set(r[i+0],r[i+1],r[i+2]),t.c.set(r[u+0],r[u+1],r[u+2]),t.a.normal.set(r[s+3],r[s+4],r[s+5]),t.b.normal.set(r[i+3],r[i+4],r[i+5]),t.c.normal.set(r[u+3],r[u+4],r[u+5]),t.calculateNormal(),t.normal.norm(),t.addNormalToVertices(),r[s+3]=t.a.normal.x,r[s+4]=t.a.normal.y,r[s+5]=t.a.normal.z,r[i+3]=t.b.normal.x,r[i+4]=t.b.normal.y,r[i+5]=t.b.normal.z,r[u+3]=t.c.normal.x,r[u+4]=t.c.normal.y,r[u+5]=t.c.normal.z}e.iterate("aNormal",function(e,a){n.set(a[e+0],a[e+1],a[e+2]).norm(),a[e+0]=n.x,a[e+1]=n.y,a[e+2]=n.z}),e.update()}},SQR.Primitives.create2DQuad=function(e,a,r,t){return SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",e,a+t,e+r,a,e+r,a+t,e+r,a,e,a+t,e,a).data("aUV",0,0,1,1,1,0,1,1,0,0,0,1).update()},SQR.Primitives.createPlane=function(e,a,r,t,n,o,s){var i=[],u=[],l=new SQR.Buffer,s=s||{};l.width=e,l.height=a;var e=.5*e,a=.5*a,n=n||0,o=o||0,r=r||1,t=t||1;i.length=[];var c,f,S=-e+n,m=-a+o,v=l.width/r,Q=l.height/t,R=[],d=[];for(c=0;r+1>c;c++)for(f=0;t+1>f;f++){var h=S+c*v,V=m+f*Q,p=c*(t+1)+f;d[p]=new SQR.V2(c/r,f/t),R[p]=s.zUp?new SQR.V3(h,V,0):new SQR.V3(h,0,V)}for(c=0;r>c;c++)for(f=0;t>f;f++){var h=S+c*v,V=m+f*Q,p=c*(t+1)+f,w=(c+1)*(t+1)+f,b=(new SQR.Face).setIndex(R,p,p+1,w,w+1);i.push(b),u.push(p,p+1,w,w,p+1,w+1)}return layout=s&&s.layout?s.layout:{},layout.aPosition=3,layout.aNormal=3,layout.aUV=2,l.layout(layout,R.length),i.forEach(function(e){e.calculateNormal(),e.addNormalToVertices()}),l.iterate("aPosition",function(e,a,r){var t=R[r];a[e+0]=t.x,a[e+1]=t.y,a[e+2]=t.z}),l.iterate("aNormal",function(e,a,r){var t=R[r];t.normal.norm(),a[e+0]=t.normal.x,a[e+1]=t.normal.y,a[e+2]=t.normal.z}),l.iterate("aUV",function(e,a,r){var t=d[r];a[e+0]=t.x,a[e+1]=t.y}),l.index(u),l.update()},SQR.Primitives.createPostEffect=function(e,a){SQR.fullScreenQuad=SQR.fullScreenQuad||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var r=new SQR.Transform("post-effect");return r.buffer=SQR.fullScreenQuad,r.shader=SQR.Shader(e,a),r},SQR.Primitives.createImage=function(e,a,r,t){if(!r&&!SQR.GLSL)throw"> SQR.Primitives.createImage > sqr-glsl.js package is required to use this feature.";r=r||SQR.GLSL["post/image.glsl"];var n=new SQR.Transform;n.buffer=SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var o=e,s=SQR.Texture(o);return n.shader=SQR.Shader(r,t),n.setImage=function(e){o=e,s.setSource(e).update(),n.shader.use().setUniform("uTexture",s)},n.setImage(o),n.size=function(e,r){var t=-1,s=1,i=1,u=-1,l=o.width,c=o.height,f=l/c*r,S=c/l*e;return"fit"==a?(f>e&&(u=-(S/r),s=S/r),S>r&&(t=-(f/e),i=f/e)):"cover"==a&&(f>e&&(t=-(f/e),i=f/e),S>r&&(u=-(S/r),s=S/r)),n.buffer.data("aPosition",t,s,i,s,i,u,t,s,i,u,t,u).update(),n},n},SQR.Primitives.createSphere=function(e,a,r,t){var n=[],o=[],s=[];t=t||{};var i,u,e=e||50,l=Math.max(3,Math.floor(a)||8),c=Math.max(3,Math.floor(r)||6),f=0,S=2*Math.PI,m=0,v=Math.PI;for(u=0;c>=u;u++)for(i=0;l>=i;i++){var Q=i/l,R=u/c,d=-e*Math.cos(f+Q*S)*Math.sin(m+R*v),h=e*Math.cos(m+R*v),V=e*Math.sin(f+Q*S)*Math.sin(m+R*v);n.push(new SQR.V3(d,h,V)),o.push(new SQR.V2(Q,1-R))}for(u=0;c>u;u++)for(i=0;l>i;i++){var p,w=l+1,b=n[u*w+i+0],P=n[u*w+i+1],g=n[(u+1)*w+i+1],y=n[(u+1)*w+i+0],x=o[u*w+i+0],N=o[u*w+i+1],T=o[(u+1)*w+i+1],U=o[(u+1)*w+i+0];p=t.reverseNormals?(new SQR.Face).setPosition(P,b,g,y).setUV(N,x,T,U):(new SQR.Face).setPosition(b,P,y,g).setUV(x,N,U,T),t.flatShading?p.calculateNormal():(b.normal=b.clone().norm(),P.normal=P.clone().norm(),g.normal=g.clone().norm(),y.normal=y.clone().norm(),t.reverseNormals&&(b.normal.neg(),P.normal.neg(),g.normal.neg(),y.normal.neg())),s.push(p)}var F=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},6*s.length),M=0;return s.forEach(function(e){M+=e.toBuffer(F,M,!t.flatShading)}),F};